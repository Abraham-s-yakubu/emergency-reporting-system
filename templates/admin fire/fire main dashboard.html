<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- START BLOCK TITLE -->
    <title>Fire Incident Dashboard</title>
    <!-- END BLOCK TITLE -->
    
    <!-- CSS and Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
</head>
<body class="flex min-h-screen">

    <!-- Sidebar Navigation -->
    <aside id="sidebar" class="text-gray-300 flex flex-col rounded-r-lg shadow-lg overflow-hidden">
        <div class="p-4 flex items-center justify-between border-b border-gray-700 h-16">
            <div class="flex items-center">
                <img src="https://placehold.co/32x32/1a202c/e2e8f0?text=FIR" alt="Logo" class="rounded-full mr-2 h-8 w-8 flex-shrink-0">
                <span class="sidebar-text text-xl font-bold text-white">Fire Incident</span>
            </div>
            <button id="sidebar-pin-btn" aria-label="Pin sidebar" class="text-gray-400 hover:text-white focus:outline-none">
                <i class="fas fa-unlock"></i> <!-- Initial icon: unlocked -->
            </button>
        </div>
        <nav class="flex-grow p-4 sidebar-scroll">
            <div class="mb-6"> 
                <h3 class="text-xs uppercase font-semibold text-gray-500 mb-2 sidebar-text">MENU</h3>
                <ul>
                    <li class="mb-2">
                        <a href="#" class="sidebar-nav-item active"> <!-- Added sidebar-nav-item and active class -->
                            <i class="fas fa-fire-extinguisher sidebar-item-icon"></i> <span class="sidebar-text">Fire Overview</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="sidebar-nav-item"> <!-- Added sidebar-nav-item -->
                            <i class="fas fa-map-marked-alt sidebar-item-icon"></i> <span class="sidebar-text">Real-time Fire Map</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="sidebar-nav-item"> <!-- Added sidebar-nav-item -->
                            <i class="fas fa-clipboard-check sidebar-item-icon"></i> <span class="sidebar-text">Fire Report Management</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="sidebar-nav-item"> <!-- Added sidebar-nav-item -->
                            <i class="fas fa-chart-line sidebar-item-icon"></i> <span class="sidebar-text">Fire Analytics & Trends</span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="sidebar-nav-item"> <!-- Added sidebar-nav-item -->
                            <i class="fas fa-users-cog sidebar-item-icon"></i> <span class="sidebar-text">Admin Users</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div>
                <h3 class="text-xs uppercase font-semibold text-gray-500 mb-2 sidebar-text">SETTINGS</h3>
                <ul>
                    <li class="mb-2">
                        <a href="#" class="sidebar-nav-item"> <!-- Added sidebar-nav-item -->
                            <i class="fas fa-sign-out-alt sidebar-item-icon"></i> <span class="sidebar-text">Logout</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="p-4 border-t border-gray-700 text-center text-gray-500 text-sm sidebar-text">Fire Incident Reporting System</div>
    </aside>

    <!-- Main Content Wrapper -->
    <div id="main-content-wrapper" class="flex-1">
        <!-- Top Navigation Header -->
        <header id="main-header" class="mb-6"> 
            <!-- START BLOCK PAGE_TITLE -->
            <h1>Dashboard <span>Overview</span></h1>
            <!-- END BLOCK PAGE_TITLE -->
            <div class="flex items-center space-x-5 relative">
                <button id="notificationButton" class="header-icon-button relative">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    <span id="notification-dot" class="absolute top-1 right-1 block h-3 w-3 rounded-full bg-red-500 ring-2 ring-slate-900 hidden"></span>
                </button>
                <div id="notificationDropdown" class="dropdown-menu hidden header-dropdown">
                    <div class="dropdown-header flex justify-between items-center">
                        <h3 class="text-lg font-semibold">New Fire Alerts</h3>
                        <button class="dropdown-close-button" id="close-notification-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                    </div>
                    <div class="py-2" id="notificationList"><div class="text-center p-4 text-slate-400">Loading notifications...</div></div>
                    <div class="dropdown-footer"><a href="#" id="viewAllIncidentsLink">View All Fire Incidents</a></div>
                </div>
                <!-- Removed Settings button and its dropdown -->
                <div class="profile-avatar"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></div>
                <span class="profile-text hidden sm:block">Admin User</span>
            </div>
        </header>
        
        <!-- START BLOCK CONTENT -->
        <main id="main-content" class="pt-0 overflow-auto"> 
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6"> 
                <!-- Card 1: Resolved Fire Reports -->
                <div class="dashboard-card"> 
                    <div>
                        <h4>Resolved Fire Reports</h4>
                        <p id="resolved-reports" class="text-4xl font-bold text-white loading-placeholder">Loading...</p>
                        <div id="resolved-reports-trend" class="trend-text text-gray-400"></div>
                    </div>
                </div>
                
                <!-- Card 2: Pending Fire Reports -->
                <div class="dashboard-card">
                    <div>
                        <h4>Pending Fire Reports</h4>
                        <p id="pending-reports" class="text-4xl font-bold text-white loading-placeholder">Loading...</p>
                        <div id="pending-reports-trend" class="trend-text text-gray-400"></div>
                    </div>
                </div>

                <!-- Card 3: Total Fire Incidents (Current Month) -->
                <div class="dashboard-card">
                    <div>
                        <h4>Total Incidents This Month</h4>
                        <p id="total-incidents-this-month" class="text-4xl font-bold text-white loading-placeholder">Loading...</p>
                        <div id="total-incidents-this-month-trend" class="trend-text text-gray-400"></div>
                    </div>
                </div>

            </div>

            <div class="dashboard-card mb-6"> 
                <div class="flex items-center justify-between mb-3"><h4 class="text-gray-400 text-sm">Monthly Fire Incident Reports</h4></div>
                <div class="h-64 loading-placeholder" id="monthly-chart-container"><canvas id="monthlyIncidentsChart"></canvas></div>
            </div>
            
            <!-- Card: Fire Response Rate (Moved down for better flow) -->
            <div class="dashboard-card mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-gray-400 text-sm">Fire Response Rate</h4>
                    <!-- Removed the "three dots" button -->
                </div>
                <p class="text-gray-500 text-sm mb-3">Percentage of fire incidents resolved efficiently.</p> 
                <div class="flex flex-col items-center justify-center mb-3">
                    <div class="progress-bar-container">
                        <svg class="w-full h-full" viewBox="0 0 120 120"><circle class="progress-bar-circle progress-bar-background" cx="60" cy="60" r="50"></circle><circle id="response-rate-progress" class="progress-bar-circle progress-bar-foreground" cx="60" cy="60" r="50" style="stroke-dasharray: 314; stroke-dashoffset: 314;"></circle></svg>
                        <span id="response-rate-percentage" class="absolute text-white text-2xl font-bold loading-placeholder">...</span> 
                    </div>
                </div>
                <p id="response-rate-message1" class="text-gray-400 text-sm text-center">Loading data...</p>
                <p id="response-rate-message2" class="text-gray-400 text-sm text-center mb-3"></p>
                <div class="flex justify-around text-center border-t border-gray-700 pt-3"> 
                    <div><p class="text-gray-500 text-sm">Target</p><p class="text-white font-bold text-base">90%</p></div>
                    <div><p class="text-gray-500 text-sm">Current</p><p id="response-rate-current" class="text-white font-bold text-base">-% <i class="fas fa-minus text-gray-400 text-xs"></i></p></div>
                    <div><p class="text-gray-500 text-sm">Last Month</p><p id="response-rate-last-month" class="text-white font-bold text-base">-% <i class="fas fa-minus text-gray-400 text-xs"></i></p></div>
                </div>
            </div>


            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-6"> 
                <div class="dashboard-card lg:col-span-1">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-gray-400 text-sm">Fire Incident Statistics</h4>
                        <div class="flex space-x-2">
                             <select id="statisticsMonthFilter" class="dashboard-select"></select>
                             <select id="statisticsYearFilter" class="dashboard-select"></select>
                        </div>
                    </div>
                    <p class="text-gray-500 text-sm mb-3">Breakdown by severity and duplicates</p>
                    <div class="h-64 loading-placeholder relative" id="statistics-chart-container">
                        <canvas id="statisticsChart"></canvas>
                        <div id="noDataStatisticsMessage" class="no-data-message hidden">
                            No incidents found for this period.
                        </div>
                    </div>
                </div>
                <div class="dashboard-card lg:col-span-1 xl:col-span-2">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-gray-400 text-sm">Active Fire Incident Reports</h4>
                        <!-- Removed the "three dots" button -->
                    </div>
                    <!-- New filter bar for active incidents -->
                    <div class="filter-bar mb-4">
                        <div class="filter-group">
                            <label for="activeStatusFilter" class="text-gray-500 text-xs">Status</label>
                            <select id="activeStatusFilter" class="dashboard-select">
                                <option value="all">All</option>
                                <option value="Pending">Pending</option>
                                <option value="Investigating">Investigating</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="activeSeverityFilter" class="text-gray-500 text-xs">Severity</label>
                            <select id="activeSeverityFilter" class="dashboard-select">
                                <option value="all">All</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="activeSearch" class="text-gray-500 text-xs">Search</label>
                            <input type="text" id="activeSearch" placeholder="Location or ID..." class="dashboard-input">
                        </div>
                    </div>
                    <div class="overflow-x-auto w-full max-h-64 overflow-y-auto" id="active-incidents-table-container">
                        <table class="min-w-full divide-y divide-gray-700 hidden">
                            <thead><tr><th class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Incident ID</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Location</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Severity</th><th class="px-4 py-3 text-left text-sm font-medium text-gray-500 uppercase tracking-wider">Status</th></tr></thead>
                            <tbody id="active-incidents-tbody" class="divide-y divide-gray-700"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Manage Videos Card -->
                <div class="dashboard-card flex items-center justify-center flex-col text-center">
                    <h4>Manage Fire Safety Videos</h4>
                    <p class="text-gray-500 text-sm mb-4">Add, view, and organize educational fire safety videos.</p>
                    <button id="manageVideosButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full max-w-xs">
                        <i class="fas fa-video mr-2"></i> Open Video Manager
                    </button>
                </div>
            </div>

        </main>
        <!-- END BLOCK CONTENT -->

    </div>

    <!-- All Incidents Modal (kept in base for universal access) -->
    <div id="allIncidentsModal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header flex justify-between items-center">
                <h2>All Fire Incidents</h2>
                <button id="closeAllIncidentsModal" class="dropdown-close-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="modal-body">
                <div class="filter-bar">
                    <div class="filter-group"><label for="modalStatusFilter">Status</label><select id="modalStatusFilter" class="dashboard-select"><option value="all">All</option><option value="Pending">Pending</option><option value="Investigating">Investigating</option><option value="Resolved">Resolved</option></select></div>
                    <div class="filter-group"><label for="modalSeverityFilter">Severity</label><select id="modalSeverityFilter" class="dashboard-select"><option value="all">All</option><option value="High">High</option><option value="Medium">Medium</option><option value="Low">Low</option></select></div>
                    <div class="filter-group"><label for="modalTimeFilter">Time</label><select id="modalTimeFilter" class="dashboard-select"><option value="all">All Time</option><option value="last_24_hours">Last 24 Hours</option><option value="last_7_days">Last 7 Days</option></select></div>
                    <div class="filter-group"><label for="modalYearFilter">Year</label><select id="modalYearFilter" class="dashboard-select"><option value="all">All</option></select></div>
                    <div class="filter-group"><label for="modalMonthFilter">Month</label><select id="modalMonthFilter" class="dashboard-select"><option value="all">All</option></select></div>
                    <div class="filter-group"><label for="modalDayFilter">Day</label><select id="modalDayFilter" class="dashboard-select"><option value="all">All</option></select></div>
                    <div class="filter-group lg:col-span-2"><label for="modalSearch">Search</label><input type="text" id="modalSearch" placeholder="Location or ID..." class="dashboard-input"></div>
                </div>
                <div class="overflow-y-auto">
                    <table class="incidents-table">
                        <thead><tr><th>ID</th><th>Location</th><th>Severity</th><th>Status</th><th>Date/Time</th><th>Actions</th></tr></thead>
                        <tbody id="allIncidentsTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer"><span id="totalIncidentsCount">0</span> Total Incidents</div>
        </div>
    </div>

    <!-- Incident Details Modal (New) -->
    <div id="incidentDetailsModal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header flex justify-between items-center">
                <h2 id="incidentDetailsTitle">Incident Details</h2>
                <button id="closeIncidentDetailsModal" class="dropdown-close-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="modal-body p-6">
                <div class="incident-details-modal-content">
                    <p>Incident ID: <span id="detailId"></span></p>
                    <p>Location: <span id="detailLocation"></span></p>
                    <p>Severity: <span id="detailSeverity"></span></p>
                    <p>Status: <span id="detailStatus"></span></p>
                    <p>Date/Time: <span id="detailDateTime"></span></p>
                    <p>Cause: <span id="detailCause"></span></p>
                    <p>Duplicate: <span id="detailIsDuplicate"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeDetailsButton" class="cancel-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Video Management Modal -->
    <div id="videoManagementModal" class="modal-overlay hidden">
        <div class="modal-container">
            <div class="modal-header flex justify-between items-center">
                <h2>Manage Fire Safety Videos</h2>
                <button id="closeVideoManagementModal" class="dropdown-close-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="modal-body p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add New Video Form -->
                <div>
                    <h3 class="text-xl font-semibold text-white mb-4"><span id="formTitle">Add New Video</span></h3>
                    <div id="addVideoMessage" class="video-message hidden"></div>
                    <form id="addVideoForm">
                        <div class="form-group">
                            <label for="youtubeEmbedCode">YouTube Embed Code (Video ID)</label>
                            <input type="text" id="youtubeEmbedCode" placeholder="e.g., dQw4w9WgXcQ" required class="dashboard-input">
                            <p class="text-gray-500 text-xs mt-1">Found in the YouTube embed URL: `https://www.youtube.com/embed/<span class="font-bold text-gray-400">VIDEO_ID</span>`</p>
                        </div>
                        <div class="form-group">
                            <label for="videoTitle">Title</label>
                            <input type="text" id="videoTitle" placeholder="e.g., Fire Safety Tips" required class="dashboard-input">
                        </div>
                        <div class="form-group">
                            <label for="videoDescription">Description</label>
                            <textarea id="videoDescription" placeholder="A brief description of the video content." rows="3" required class="dashboard-input"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="videoCategory">Category</label>
                            <select id="videoCategory" class="dashboard-select">
                                <!-- Options will be dynamically populated by JavaScript -->
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="form-action-buttons">
                            <button type="submit" class="submit-btn" id="submitVideoButton"><i class="fas fa-plus-circle mr-2"></i> Add Video</button>
                            <button type="button" class="cancel-btn hidden" id="cancelEditButton"><i class="fas fa-times-circle mr-2"></i> Cancel Edit</button>
                        </div>
                    </form>
                </div>

                <!-- Existing Videos List -->
                <div>
                    <h3 class="text-xl font-semibold text-white mb-4">Existing Videos</h3>
                    <!-- Search input for videos -->
                    <div class="form-group mb-4">
                        <label for="videoSearchInput" class="sr-only">Search Videos</label>
                        <input type="text" id="videoSearchInput" placeholder="Search videos by title, description, or category..." class="dashboard-input">
                    </div>
                    <div id="existingVideosList" class="video-gallery-modal-content">
                        <!-- Videos will be rendered here -->
                        <div class="text-center text-gray-500 py-8 col-span-full">No videos added yet.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal Structure -->
    <div id="confirmationModal" class="confirmation-modal-overlay hidden">
        <div class="confirmation-modal-content">
            <h3 id="confirmationModalTitle">Confirm Action</h3>
            <p id="confirmationModalMessage">Are you sure you want to proceed?</p>
            <div class="confirmation-modal-actions">
                <button id="confirmActionButton" class="confirm-btn">Confirm</button>
                <button id="cancelActionButton" class="cancel-btn">Cancel</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Encapsulate dashboard logic within an IIFE (Immediately Invoked Function Expression)
        // This helps avoid polluting the global scope.
        (function() {
            // --- Simulated Data (Replace with Django Backend API Calls) ---
            // In a real Django application, these would be API endpoints.
            const SIMULATED_DELAY = 800; // Simulate network latency for demonstration

            // Simulated fire incident data for charts and tables
            // --- BACKEND INTEGRATION POINT (Django) ---
            // This 'allFireIncidents' array would typically be fetched from your Django backend
            // via a REST API endpoint (e.g., GET /api/incidents/).
            // You would use `fetch('/api/incidents/')` to get this data.
            const allFireIncidents = [
                { id: 'FR-AD001', location: 'Yola Main Market, Adamawa', severity: 'High', status: 'Pending', dateTime: '2025-06-05T14:30:00Z', cause: 'Electrical Fault', isDuplicate: false },
                { id: 'FR-AD002', location: 'Mubi Residential Area, Adamawa', severity: 'Medium', status: 'Resolved', dateTime: '2025-06-04T10:15:00Z', cause: 'Gas Leakage', isDuplicate: false },
                { id: 'FR-AD003', location: 'Numan Industrial Layout, Adamawa', severity: 'High', status: 'Investigating', dateTime: '2025-06-02T20:00:00Z', cause: 'Unknown', isDuplicate: false },
                { id: 'FR-AD004', location: 'Gombi Farmland, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2025-05-26T08:45:00Z', cause: 'Bush Burning', isDuplicate: false },
                { id: 'FR-AD005', location: 'Federal Poly Mubi, Adamawa', severity: 'Medium', status: 'Resolved', dateTime: '2025-05-25T16:00:00Z', cause: 'Human Error', isDuplicate: true }, // Marked as duplicate
                { id: 'FR-AD006', location: 'Jimeta Modern Market, Adamawa', severity: 'High', status: 'Pending', dateTime: new Date(Date.now() - 2 * 3600 * 1000).toISOString(), cause: 'Arson', isDuplicate: false },
                { id: 'FR-AD007', location: 'Girei Town, Adamawa', severity: 'Low', status: 'Pending', dateTime: new Date(Date.now() - 5 * 24 * 3600 * 1000).toISOString(), cause: 'Electrical Fault', isDuplicate: false },
                { id: 'FR-AD008', location: 'Song Local Govt., Adamawa', severity: 'Medium', status: 'Investigating', dateTime: '2024-12-15T11:00:00Z', cause: 'Unknown', isDuplicate: true }, // Marked as duplicate
                { id: 'FR-AD009', location: 'Mayo Belwa, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2024-11-01T09:00:00Z', cause: 'Accidental', isDuplicate: false },
                { id: 'FR-AD010', location: 'Fufore Market, Adamawa', severity: 'High', status: 'Pending', dateTime: new Date(Date.now() - 12 * 3600 * 1000).toISOString(), cause: 'Electrical', isDuplicate: false },
                // DUMMY DATA FOR OTHER MONTHS (2025)
                { id: 'FR-AD011', location: 'Gombi Road, Adamawa', severity: 'Medium', status: 'Resolved', dateTime: '2025-01-10T09:00:00Z', cause: 'Cooking Accident', isDuplicate: false },
                { id: 'FR-AD012', location: 'Yola Bypass, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2025-01-15T11:00:00Z', cause: 'Carelessness', isDuplicate: false },
                { id: 'FR-AD013', location: 'Mubi South, Adamawa', severity: 'High', status: 'Pending', dateTime: '2025-01-20T18:00:00Z', cause: 'Arson', isDuplicate: false },
                { id: 'FR-AD014', location: 'Numan Village, Adamawa', severity: 'Medium', status: 'Investigating', dateTime: '2025-02-01T07:00:00Z', cause: 'Unknown', isDuplicate: true },
                { id: 'FR-AD015', location: 'Lamurde Farmland, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2025-02-05T13:00:00Z', cause: 'Bush Burning', isDuplicate: false },
                { id: 'FR-AD016', location: 'Shelleng Town, Adamawa', severity: 'High', status: 'Resolved', dateTime: '2025-03-12T10:00:00Z', cause: 'Electrical Fault', isDuplicate: false },
                { id: 'FR-AD017', location: 'Ganye Market, Adamawa', severity: 'Medium', status: 'Pending', dateTime: '2025-03-20T16:00:00Z', cause: 'Cooking Accident', isDuplicate: false },
                { id: 'FR-AD018', location: 'Maiha, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2025-04-03T14:00:00Z', cause: 'Accidental', isDuplicate: false },
                { id: 'FR-AD019', location: 'Hong, Adamawa', severity: 'High', status: 'Investigating', dateTime: '2025-04-10T22:00:00Z', cause: 'Arson', isDuplicate: true },
                { id: 'FR-AD020', location: 'Jada, Adamawa', severity: 'Medium', status: 'Pending', dateTime: '2025-05-01T08:00:00Z', cause: 'Gas Leakage', isDuplicate: false },
                { id: 'FR-AD021', location: 'Madagali, Adamawa', severity: 'High', status: 'Resolved', dateTime: '2025-05-15T17:00:00Z', cause: 'Electrical Fault', isDuplicate: false },
                // DUMMY DATA FOR OTHER MONTHS (2024 and 2023)
                { id: 'FR-AD022', location: 'Ganye Road, Adamawa', severity: 'Medium', status: 'Resolved', dateTime: '2024-12-01T09:00:00Z', cause: 'Cooking Accident', isDuplicate: false },
                { id: 'FR-AD023', location: 'Jada Bypass, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2024-12-10T11:00:00Z', cause: 'Carelessness', isDuplicate: false },
                { id: 'FR-AD024', location: 'Madagali South, Adamawa', severity: 'High', status: 'Pending', dateTime: '2024-12-25T18:00:00Z', cause: 'Arson', isDuplicate: false },
                { id: 'FR-AD025', location: 'Mayo Belwa Village, Adamawa', severity: 'Medium', status: 'Investigating', dateTime: '2024-11-05T07:00:00Z', cause: 'Unknown', isDuplicate: true },
                { id: 'FR-AD026', location: 'Fufore Farmland, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2024-11-10T13:00:00Z', cause: 'Bush Burning', isDuplicate: false },
                { id: 'FR-AD027', location: 'Song Town, Adamawa', severity: 'High', status: 'Resolved', dateTime: '2024-10-18T10:00:00Z', cause: 'Electrical Fault', isDuplicate: false },
                { id: 'FR-AD028', location: 'Girei Market, Adamawa', severity: 'Medium', status: 'Pending', dateTime: '2024-10-22T16:00:00Z', cause: 'Cooking Accident', isDuplicate: false },
                { id: 'FR-AD029', location: 'Toungo, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2024-09-01T14:00:00Z', cause: 'Accidental', isDuplicate: false },
                { id: 'FR-AD030', location: 'Mubi North, Adamawa', severity: 'High', status: 'Investigating', dateTime: '2024-09-10T22:00:00Z', cause: 'Arson', isDuplicate: true },
                { id: 'FR-AD031', location: 'Gombi LGA, Adamawa', severity: 'Medium', status: 'Pending', dateTime: '2024-08-05T08:00:00Z', cause: 'Gas Leakage', isDuplicate: false },
                { id: 'FR-AD032', location: 'Michika LGA, Adamawa', severity: 'High', status: 'Resolved', dateTime: '2024-08-15T17:00:00Z', cause: 'Electrical Fault', isDuplicate: false },
                { id: 'FR-AD033', location: 'Shani LGA, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2024-07-01T09:00:00Z', cause: 'Cooking Accident', isDuplicate: false },
                { id: 'FR-AD034', location: 'Askira Uba LGA, Adamawa', severity: 'Medium', status: 'Pending', dateTime: '2024-07-10T11:00:00Z', cause: 'Carelessness', isDuplicate: false },
                { id: 'FR-AD035', location: 'Mubi Town, Adamawa', severity: 'High', status: 'Resolved', dateTime: '2024-06-01T12:00:00Z', cause: 'Electrical', isDuplicate: false },
                { id: 'FR-AD036', location: 'Yola South Area, Adamawa', severity: 'Medium', status: 'Pending', dateTime: '2024-06-15T14:00:00Z', cause: 'Gas Leak', isDuplicate: false },
                { id: 'FR-AD037', location: 'Numan Area, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2024-06-20T10:00:00Z', cause: 'Bush fire', isDuplicate: true },
                { id: 'FR-AD038', location: 'Girei South, Adamawa', severity: 'Medium', status: 'Resolved', dateTime: '2023-01-10T09:00:00Z', cause: 'Cooking Accident', isDuplicate: false },
                { id: 'FR-AD039', location: 'Yola North Campus, Adamawa', severity: 'High', status: 'Resolved', dateTime: '2023-01-15T11:00:00Z', cause: 'Electrical Fault', isDuplicate: false },
                { id: 'FR-AD040', location: 'Jada North, Adamawa', severity: 'Low', status: 'Resolved', dateTime: '2023-03-01T14:00:00Z', cause: 'Accidental', isDuplicate: false },
                { id: 'FR-AD041', location: 'Ganye West, Adamawa', severity: 'Medium', status: 'Pending', dateTime: '2023-03-10T22:00:00Z', cause: 'Arson', isDuplicate: true },
            ];

            // Simulated notification data (for client-side display without Firebase)
            // --- BACKEND INTEGRATION POINT (Django) ---
            // Notifications would also come from your Django backend (e.g., GET /api/notifications/).
            // You might have a Django model for notifications and a viewset to expose them.
            const simulatedNotifications = [
                { id: 'NOTIF-001', messageTitle: 'High Severity Fire', messageSubtitle: 'Yola Main Market', details: 'Incident FR-AD001 reported.', timestamp: new Date(Date.now() - 3600 * 1000), unread: true },
                { id: 'NOTIF-002', messageTitle: 'New Incident', messageSubtitle: 'Jimeta Modern Market', details: 'Incident FR-AD006 requires attention.', timestamp: new Date(Date.now() - 2 * 3600 * 1000), unread: true },
                { id: 'NOTIF-003', messageTitle: 'Incident Resolved', messageSubtitle: 'Gombi Farmland', details: 'Incident FR-AD004 has been resolved.', timestamp: new Date(Date.now() - 24 * 3600 * 1000), unread: false },
                { id: 'NOTIF-004', messageTitle: 'Duplicate Flagged', messageSubtitle: 'Federal Poly Mubi', details: 'Incident FR-AD005 flagged as duplicate.', timestamp: new Date(Date.now() - 48 * 3600 * 1000), unread: false },
                { id: 'NOTIF-005', messageTitle: 'System Update', messageSubtitle: 'Dashboard Maintenance', details: 'New features deployed successfully.', timestamp: new Date(Date.now() - 72 * 3600 * 1000), unread: false },
            ];

            // Simulated YouTube video data (would be fetched from database in a real app)
            // This array will be used to store videos added via the modal
            // --- BACKEND INTEGRATION POINT (Django) ---
            // Video data would be managed by Django models and exposed via API (e.g., GET /api/videos/).
            // Adding/updating/deleting videos would involve POST/PUT/DELETE requests to your Django API.
            const youtubeVideos = [
                { id: 'lF4M37_b8jU', title: 'Fire Safety Basics: Your Home', description: 'Essential tips for preventing fires at home and what to do in case of one.', category: 'Prevention' },
                { id: 'jD2xH4XQn7E', title: 'Road Accident Response', description: 'What to do when you encounter a road accident and how to assist.', category: 'Response' },
                { id: 'D-3-vEw-k0M', title: 'Flood Preparedness in Nigeria', description: 'Important steps to take before, during, and after a flood in Nigerian communities.', category: 'Preparedness' },
                { id: 'dQw4w9WgXcQ', title: 'Emergency Medical First Aid', description: 'Basic first aid techniques for common medical emergencies like cuts and burns.', category: 'Medical' },
            ];

            // Global variable to hold the ID of the video being edited
            let editingVideoId = null;

            // --- UI Elements (cached for performance) ---
            const els = {
                sidebar: document.getElementById('sidebar'),
                pinBtn: document.getElementById('sidebar-pin-btn'),
                pinIcon: document.getElementById('sidebar-pin-btn')?.querySelector('i'),
                mainContentWrapper: document.getElementById('main-content-wrapper'),
                notificationButton: document.getElementById('notificationButton'),
                notificationDropdown: document.getElementById('notificationDropdown'),
                notificationList: document.getElementById('notificationList'), 
                closeNotificationBtn: document.getElementById('close-notification-btn'),
                viewAllIncidentsLink: document.getElementById('viewAllIncidentsLink'),
                allIncidentsModal: document.getElementById('allIncidentsModal'),
                closeAllIncidentsModal: document.getElementById('closeAllIncidentsModal'),
                modalStatusFilter: document.getElementById('modalStatusFilter'),
                modalSeverityFilter: document.getElementById('modalSeverityFilter'),
                modalTimeFilter: document.getElementById('modalTimeFilter'),
                modalYearFilter: document.getElementById('modalYearFilter'),
                modalMonthFilter: document.getElementById('modalMonthFilter'),
                modalDayFilter: document.getElementById('modalDayFilter'),
                modalSearchInput: document.getElementById('modalSearch'),
                activeStatusFilter: document.getElementById('activeStatusFilter'),
                activeSeverityFilter: document.getElementById('activeSeverityFilter'),
                activeSearch: document.getElementById('activeSearch'),
                manageVideosButton: document.getElementById('manageVideosButton'),
                videoManagementModal: document.getElementById('videoManagementModal'),
                closeVideoManagementModal: document.getElementById('closeVideoManagementModal'),
                addVideoForm: document.getElementById('addVideoForm'),
                cancelEditButton: document.getElementById('cancelEditButton'),
                videoSearchInput: document.getElementById('videoSearchInput'),
                statisticsMonthFilter: document.getElementById('statisticsMonthFilter'),
                statisticsYearFilter: document.getElementById('statisticsYearFilter'),
                confirmationModal: document.getElementById('confirmationModal'),
                confirmationModalTitle: document.getElementById('confirmationModalTitle'),
                confirmationModalMessage: document.getElementById('confirmationModalMessage'),
                confirmActionButton: document.getElementById('confirmActionButton'),
                cancelActionButton: document.getElementById('cancelActionButton'),
                resolvedReportsEl: document.getElementById('resolved-reports'),
                pendingReportsEl: document.getElementById('pending-reports'),
                totalIncidentsThisMonthEl: document.getElementById('total-incidents-this-month'), 
                responseRateProgress: document.getElementById('response-rate-progress'),
                responseRatePercentage: document.getElementById('response-rate-percentage'),
                responseRateCurrent: document.getElementById('response-rate-current'),
                responseRateLastMonth: document.getElementById('response-rate-last-month'),
                responseRateMessage1: document.getElementById('response-rate-message1'),
                responseRateMessage2: document.getElementById('response-rate-message2'),
                monthlyChartContainer: document.getElementById('monthly-chart-container'),
                monthlyIncidentsChart: document.getElementById('monthlyIncidentsChart'),
                statisticsChartContainer: document.getElementById('statistics-chart-container'),
                statisticsChart: document.getElementById('statisticsChart'),
                noDataStatisticsMessage: document.getElementById('noDataStatisticsMessage'),
                activeIncidentsTbody: document.getElementById('active-incidents-tbody'),
                activeIncidentsTable: document.getElementById('active-incidents-table-container')?.querySelector('table'),
                allIncidentsTableBody: document.getElementById('allIncidentsTableBody'),
                totalIncidentsCount: document.getElementById('totalIncidentsCount'),
                addVideoMessage: document.getElementById('addVideoMessage'),
                youtubeEmbedCodeInput: document.getElementById('youtubeEmbedCode'),
                videoTitleInput: document.getElementById('videoTitle'),
                videoDescriptionInput: document.getElementById('videoDescription'),
                videoCategorySelect: document.getElementById('videoCategory'),
                formTitle: document.getElementById('formTitle'),
                submitVideoButton: document.getElementById('submitVideoButton'),
                existingVideosList: document.getElementById('existingVideosList'),
                notificationDot: document.getElementById('notification-dot'),

                // Incident Details Modal Elements
                incidentDetailsModal: document.getElementById('incidentDetailsModal'),
                closeIncidentDetailsModal: document.getElementById('closeIncidentDetailsModal'),
                closeDetailsButton: document.getElementById('closeDetailsButton'),
                detailId: document.getElementById('detailId'),
                detailLocation: document.getElementById('detailLocation'),
                detailSeverity: document.getElementById('detailSeverity'),
                detailStatus: document.getElementById('detailStatus'),
                detailDateTime: document.getElementById('detailDateTime'),
                detailCause: document.getElementById('detailCause'),
                detailIsDuplicate: document.getElementById('detailIsDuplicate')
            };

            let isSidebarPinned = false;
            let monthlyChartInstance = null;
            let statisticsChartInstance = null;

            // --- Sidebar Functions ---
            const sidebar = {
                expandedWidth: "20rem",
                collapsedWidth: "5rem",

                setMainContentMargin() {
                    if (els.sidebar && els.mainContentWrapper) {
                        if (els.sidebar.classList.contains('collapsed')) {
                            els.mainContentWrapper.style.marginLeft = this.collapsedWidth;
                        } else {
                            els.mainContentWrapper.style.marginLeft = this.expandedWidth;
                        }
                    }
                },

                open() {
                    if (els.sidebar && els.sidebar.classList.contains('collapsed')) {
                        els.sidebar.classList.remove('collapsed');
                        this.setMainContentMargin();
                    }
                },

                close() {
                    if (els.sidebar && !isSidebarPinned && !els.sidebar.classList.contains('collapsed')) {
                        els.sidebar.classList.add('collapsed');
                        this.setMainContentMargin();
                    }
                },

                togglePin() {
                    if (!els.pinBtn || !els.pinIcon) return; 

                    isSidebarPinned = !isSidebarPinned;
                    els.pinBtn.classList.toggle('text-indigo-400'); // This class is no longer used for color, but kept for toggle logic
                    els.pinBtn.classList.toggle('pinned', isSidebarPinned);

                    if (isSidebarPinned) {
                        els.pinIcon.classList.remove('fa-unlock');
                        els.pinIcon.classList.add('fa-lock');
                        this.open(); 
                    } else {
                        els.pinIcon.classList.remove('fa-lock');
                        els.pinIcon.classList.add('fa-unlock');
                        this.close(); 
                    }
                },

                init() {
                    if (els.sidebar) {
                        els.sidebar.classList.add('collapsed'); 
                        this.setMainContentMargin();

                        els.sidebar.addEventListener('mouseenter', () => {
                            if (!isSidebarPinned) this.open();
                        });

                        els.sidebar.addEventListener('mouseleave', () => {
                            if (!isSidebarPinned) this.close();
                        });
                    }
                    if (els.pinBtn) {
                        els.pinBtn.addEventListener('click', () => this.togglePin());
                    }
                }
            };

            // --- Modal & Dropdown Management ---
            function closeAllPopups(exceptId = null) {
                const popups = [
                    els.notificationDropdown, els.allIncidentsModal,
                    els.videoManagementModal, els.confirmationModal,
                    els.incidentDetailsModal 
                ];
                popups.forEach(element => {
                    if (element && element.id !== exceptId && !element.classList.contains('hidden')) {
                        element.classList.add('hidden');
                    }
                });

                if (els.notificationButton) els.notificationButton.classList.remove('active');
            }

            // --- Data Fetching (Simulated - Replace with Django Backend API Calls) ---
            async function getDashboardStats() {
                // --- BACKEND INTEGRATION POINT (Django) ---
                // Replace this simulated data fetch with an actual API call to your Django backend.
                // Example: fetch('/api/dashboard-stats/')
                // Your Django view would calculate these statistics and return them as JSON.
                const now = new Date();
                const currentMonth = now.getMonth(); 
                const currentYear = now.getFullYear();

                const incidentsThisMonth = allFireIncidents.filter(inc => {
                    const incidentDate = new Date(inc.dateTime);
                    return incidentDate.getMonth() === currentMonth && incidentDate.getFullYear() === currentYear;
                }).length;

                const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const prevMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;

                const incidentsLastMonth = allFireIncidents.filter(inc => {
                    const incidentDate = new Date(inc.dateTime);
                    return incidentDate.getMonth() === prevMonth && incidentDate.getFullYear() === prevMonthYear;
                }).length;

                let incidentsTrend = 0;
                let incidentsTrendDirection = 'neutral';
                if (incidentsLastMonth > 0) {
                    incidentsTrend = ((incidentsThisMonth - incidentsLastMonth) / incidentsLastMonth) * 100;
                    incidentsTrendDirection = incidentsTrend >= 0 ? 'up' : 'down';
                } else if (incidentsThisMonth > 0) {
                    incidentsTrend = 100; 
                    incidentsTrendDirection = 'up';
                }

                return new Promise(r => setTimeout(() => r({
                    resolvedReports: { value: 780, trend: 7, trendDirection: 'up' },
                    pendingReports: { value: 170, trend: 3, trendDirection: 'down' },
                    totalIncidentsThisMonth: { value: incidentsThisMonth, trend: Math.abs(incidentsTrend), trendDirection: incidentsTrendDirection },
                    responseRate: { current: 81.14, lastMonth: 75.55, target: 90 }
                }), SIMULATED_DELAY));
            }

            async function getMonthlyIncidentsData() {
                // --- BACKEND INTEGRATION POINT (Django) ---
                // This data would be generated by a Django view, likely aggregating incidents by month.
                // Example: fetch('/api/monthly-incidents-data/')
                return new Promise(r => setTimeout(() => r({
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Fire Incidents',
                        data: [22, 18, 28, 20, 25, 22, 15, 30, 32, 28, 24, 38],
                        backgroundColor: 'rgba(239, 68, 68, 0.6)', // Red theme
                        borderColor: 'rgba(239, 68, 68, 1)',     // Red theme
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                }), SIMULATED_DELAY));
            }

            async function getActiveIncidents() {
                // --- BACKEND INTEGRATION POINT (Django) ---
                // Fetch active incidents from your Django API.
                // Example: fetch('/api/incidents/?status__in=Pending,Investigating')
                return new Promise(r => setTimeout(() => r(
                    allFireIncidents.filter(inc => inc.status !== 'Resolved')
                ), SIMULATED_DELAY));
            }

            // --- Dashboard Card Rendering ---
            function updateProgressBar(percentage, progressBarEl, percentageTextEl) {
                if (!progressBarEl || !percentageTextEl) return;

                const radius = progressBarEl.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;

                progressBarEl.style.strokeDasharray = circumference;
                const offset = circumference - (percentage / 100) * circumference;
                progressBarEl.style.strokeDashoffset = offset;

                percentageTextEl.textContent = `${percentage.toFixed(2)}%`;
                percentageTextEl.classList.remove('loading-placeholder');
            }

            function renderTrend(element, trendValue, trendDirection) {
                if (!element) return;
                let iconClass = 'fa-minus text-gray-400'; 
                if (trendDirection === 'up') {
                    iconClass = 'fa-arrow-up text-green-400';
                } else if (trendDirection === 'down') {
                    iconClass = 'fa-arrow-down text-red-400';
                }
                
                element.innerHTML = `<i class="fas ${iconClass}"></i> ${trendValue.toFixed(0)}% from last month`;
            }

            async function loadDashboardStats() {
                const stats = await getDashboardStats();

                if (els.resolvedReportsEl) {
                    els.resolvedReportsEl.textContent = stats.resolvedReports.value;
                    els.resolvedReportsEl.classList.remove('loading-placeholder');
                    renderTrend(els.resolvedReportsEl.nextElementSibling, stats.resolvedReports.trend, stats.resolvedReports.trendDirection);
                }

                if (els.pendingReportsEl) {
                    els.pendingReportsEl.textContent = stats.pendingReports.value;
                    els.pendingReportsEl.classList.remove('loading-placeholder');
                    renderTrend(els.pendingReportsEl.nextElementSibling, stats.pendingReports.trend, stats.pendingReports.trendDirection);
                }

                if (els.totalIncidentsThisMonthEl) {
                    els.totalIncidentsThisMonthEl.textContent = stats.totalIncidentsThisMonth.value;
                    els.totalIncidentsThisMonthEl.classList.remove('loading-placeholder');
                    renderTrend(els.totalIncidentsThisMonthEl.nextElementSibling, stats.totalIncidentsThisMonth.trend, stats.totalIncidentsThisMonth.trendDirection);
                }

                updateProgressBar(stats.responseRate.current, els.responseRateProgress, els.responseRatePercentage);

                if (els.responseRateCurrent) {
                    const trendIcon = stats.responseRate.current > stats.responseRate.lastMonth ? 'fa-arrow-up text-green-400' : 'fa-arrow-down text-red-400';
                    els.responseRateCurrent.innerHTML = `${stats.responseRate.current.toFixed(2)}% <i class="fas ${trendIcon} text-xs"></i>`;
                }

                if(els.responseRateLastMonth) {
                    els.responseRateLastMonth.innerHTML = `${stats.responseRate.lastMonth.toFixed(2)}% <i class="fas fa-plus text-green-400 text-xs"></i>`; 
                }

                if(els.responseRateMessage1 && els.responseRateMessage2) {
                    if (stats.responseRate.current >= stats.responseRate.target) {
                        els.responseRateMessage1.textContent = "Excellent response rate! Target achieved.";
                        els.responseRateMessage2.textContent = "Maintain this high standard.";
                    } else if (stats.responseRate.current >= 70) {
                        els.responseRateMessage1.textContent = "Current fire response rate is good, keep it up!";
                        els.responseRateMessage2.textContent = `Aim for ${stats.responseRate.target}% and above.`;
                    } else {
                        els.responseRateMessage1.textContent = "Response rate needs improvement.";
                        els.responseRateMessage2.textContent = `Focus on reaching the ${stats.responseRate.target}% target.`;
                    }
                }
            }

            // --- Charting Functions ---
            async function initMonthlyChart() {
                if (!els.monthlyChartContainer || !els.monthlyIncidentsChart) return;

                const data = await getMonthlyIncidentsData();
                els.monthlyChartContainer.classList.remove('loading-placeholder');

                if (monthlyChartInstance) {
                    monthlyChartInstance.destroy();
                }

                // Ensure Chart is defined before creating a new Chart instance
                if (typeof Chart !== 'undefined') {
                    monthlyChartInstance = new Chart(els.monthlyIncidentsChart.getContext('2d'), {
                        type: 'bar',
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, labels: { color: '#e2e8f0', font: { size: 12 } } },
                                tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${context.parsed.y} incidents` } }
                            },
                            scales: {
                                x: { grid: { display: false }, ticks: { color: '#a0aec0', font: { size: 12 } } },
                                y: { beginAtZero: true, grid: { color: '#2d3748' }, ticks: { color: '#a0aec0', font: { size: 12 } } }
                            }
                        }
                    });
                } else {
                    console.error("Chart.js is not loaded. Cannot initialize monthly chart.");
                }
            }

            function getStatisticsCounts(incidents) {
                let highSeverity = 0, mediumSeverity = 0, lowSeverity = 0, duplicateReports = 0;
                incidents.forEach(inc => {
                    if (inc.severity === 'High') highSeverity++;
                    else if (inc.severity === 'Medium') mediumSeverity++;
                    else if (inc.severity === 'Low') lowSeverity++;
                    if (inc.isDuplicate) duplicateReports++;
                });
                return { highSeverity, mediumSeverity, lowSeverity, duplicateReports };
            }

            async function renderStatisticsChart(selectedMonth, selectedYear) {
                if (!els.statisticsChartContainer || !els.statisticsChart || !els.noDataStatisticsMessage) return;

                els.statisticsChartContainer.classList.add('loading-placeholder');
                els.statisticsChart.style.display = 'none';
                els.noDataStatisticsMessage.classList.add('hidden');

                const filteredIncidents = allFireIncidents.filter(inc => {
                    const incidentDate = new Date(inc.dateTime);
                    const monthMatch = selectedMonth === 'all' || (incidentDate.getMonth() + 1) === parseInt(selectedMonth);
                    const yearMatch = selectedYear === 'all' || incidentDate.getFullYear() === parseInt(selectedYear);
                    return monthMatch && yearMatch;
                });

                const { highSeverity, mediumSeverity, lowSeverity, duplicateReports } = getStatisticsCounts(filteredIncidents);
                await new Promise(resolve => setTimeout(resolve, SIMULATED_DELAY));

                const hasData = (highSeverity + mediumSeverity + lowSeverity + duplicateReports) > 0;

                if (!hasData) {
                    if (statisticsChartInstance) statisticsChartInstance.destroy();
                    els.noDataStatisticsMessage.classList.remove('hidden');
                    els.statisticsChart.style.display = 'none';
                } else {
                    els.noDataStatisticsMessage.classList.add('hidden');
                    els.statisticsChart.style.display = 'block';

                    const chartData = {
                        labels: ['High Severity', 'Medium Severity', 'Low Severity', 'Duplicate Reports'],
                        datasets: [{
                            label: 'Fire Incident Severity',
                            data: [highSeverity, mediumSeverity, lowSeverity, duplicateReports],
                            backgroundColor: ['rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(52, 211, 153, 0.8)', 'rgba(107, 114, 128, 0.8)'], // Red, Orange, Green, Gray
                            borderColor: '#1a202c',
                            borderWidth: 2,
                        }]
                    };

                    if (statisticsChartInstance) statisticsChartInstance.destroy();

                    // Ensure Chart is defined before creating a new Chart instance
                    if (typeof Chart !== 'undefined') {
                        statisticsChartInstance = new Chart(els.statisticsChart.getContext('2d'), {
                            type: 'doughnut',
                            data: chartData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'right', labels: { color: '#e2e8f0', boxWidth: 14, padding: 20, font: { size: 12 } } },
                                    tooltip: { callbacks: { label: (context) => {
                                        let label = context.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed !== null) label += context.parsed + ' incidents';
                                        return label;
                                    } } }
                                }
                            }
                        });
                    } else {
                        console.error("Chart.js is not loaded. Cannot initialize statistics chart.");
                    }
                }
                els.statisticsChartContainer.classList.remove('loading-placeholder');
            }

            function populateStatisticsFilters() {
                if (!els.statisticsMonthFilter || !els.statisticsYearFilter) return;

                els.statisticsMonthFilter.innerHTML = '<option value="all">All Months</option>';
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                monthNames.forEach((name, index) => {
                    els.statisticsMonthFilter.innerHTML += `<option value="${index + 1}">${name}</option>`;
                });

                const currentYear = new Date().getFullYear();
                const yearsInData = new Set(allFireIncidents.map(inc => new Date(inc.dateTime).getFullYear()));
                yearsInData.add(currentYear);

                els.statisticsYearFilter.innerHTML = '<option value="all">All Years</option>';
                Array.from(yearsInData).sort((a, b) => b - a).forEach(year => {
                    els.statisticsYearFilter.innerHTML += `<option value="${year}">${year}</option>`;
                });

                els.statisticsMonthFilter.value = (new Date().getMonth() + 1).toString();
                els.statisticsYearFilter.value = currentYear.toString();
            }
            
            // --- Table Rendering Functions ---
            async function renderActiveIncidentsTable() {
                if (!els.activeIncidentsTbody || !els.activeIncidentsTable) return;

                const allActiveIncidents = await getActiveIncidents();

                const statusFilter = els.activeStatusFilter.value;
                const severityFilter = els.activeSeverityFilter.value;
                const searchInput = els.activeSearch.value.toLowerCase();

                const filteredIncidents = allActiveIncidents.filter(inc => {
                    const matchesStatus = statusFilter === 'all' || inc.status === statusFilter;
                    const matchesSeverity = severityFilter === 'all' || inc.severity === severityFilter;
                    const matchesSearch = searchInput === '' || inc.location.toLowerCase().includes(searchInput) || inc.id.toLowerCase().includes(searchInput);
                    return matchesStatus && matchesSeverity && matchesSearch;
                });

                els.activeIncidentsTable.classList.remove('hidden');
                els.activeIncidentsTbody.innerHTML = '';

                if (filteredIncidents.length === 0) {
                    els.activeIncidentsTbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500 text-sm">No active incidents found matching your criteria.</td></tr>`;
                    return;
                }

                filteredIncidents.forEach(incident => {
                    const severityClass = incident.severity === 'High' ? 'text-red-500' : (incident.severity === 'Medium' ? 'text-orange-500' : 'text-green-500');
                    const currentStatusBadgeClass = `status-${incident.status.toLowerCase()}`;

                    const row = `
                        <tr>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-white">${incident.id}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-white">${incident.location}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold ${severityClass}">${incident.severity}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${currentStatusBadgeClass}">${incident.status}</span>
                            </td>
                        </tr>
                    `;
                    els.activeIncidentsTbody.insertAdjacentHTML('beforeend', row);
                });
            }

            function populateDateFilters() {
                if (!els.modalYearFilter || !els.modalMonthFilter || !els.modalDayFilter) return;

                const years = new Set(allFireIncidents.map(inc => new Date(inc.dateTime).getFullYear()));
                els.modalYearFilter.innerHTML = '<option value="all">All</option>';
                Array.from(years).sort((a,b) => b - a).forEach(year => {
                    els.modalYearFilter.innerHTML += `<option value="${year}">${year}</option>`;
                });

                els.modalMonthFilter.innerHTML = '<option value="all">All</option>';
                for(let i = 1; i <= 12; i++) {
                    els.modalMonthFilter.innerHTML += `<option value="${i}">${new Date(0, i-1).toLocaleString('default', { month: 'long' })}</option>`;
                }

                els.modalDayFilter.innerHTML = '<option value="all">All</option>';
                for(let i = 1; i <= 31; i++) {
                    els.modalDayFilter.innerHTML += `<option value="${i}">${i}</option>`;
                }
            }

            function populateIncidentsTable(incidents) {
                if (!els.allIncidentsTableBody || !els.totalIncidentsCount) return;

                els.allIncidentsTableBody.innerHTML = '';
                els.totalIncidentsCount.textContent = incidents.length;

                if (incidents.length === 0) {
                    els.allIncidentsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-400">No incidents found matching your criteria.</td></tr>';
                    return;
                }

                incidents.forEach(incident => {
                    const row = `
                        <tr>
                            <td>${incident.id}</td>
                            <td>${incident.location}</td>
                            <td><span class="severity-text-${incident.severity.toLowerCase()}">${incident.severity}</span></td>
                            <td><span class="status-badge status-${incident.status.toLowerCase()}">${incident.status}</span></td>
                            <td>${new Date(incident.dateTime).toLocaleString()}</td>
                            <td><button class="view-details-btn bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-xs" data-incident-id="${incident.id}">View Details</button></td>
                        </tr>
                    `;
                    els.allIncidentsTableBody.insertAdjacentHTML('beforeend', row);
                });

                // Attach event listeners to the newly created buttons
                els.allIncidentsTableBody.querySelectorAll('.view-details-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault();
                        const incidentId = event.currentTarget.dataset.incidentId;
                        openIncidentDetailsModal(incidentId);
                    });
                });
            }
            
            // Function to open and populate the incident details modal
            function openIncidentDetailsModal(incidentId) {
                console.log('Attempting to open incident details modal for ID:', incidentId);
                if (!els.incidentDetailsModal) {
                    console.error("Incident details modal element not found.");
                    return;
                }

                const incident = allFireIncidents.find(inc => inc.id === incidentId);
                if (!incident) {
                    console.error(`Incident with ID ${incidentId} not found. Cannot open details modal.`);
                    return;
                }
                console.log('Incident found:', incident);

                // Populate the modal fields
                if (els.detailId) {
                    els.detailId.textContent = incident.id;
                    console.log('detailId.textContent set to:', els.detailId.textContent);
                }
                if (els.detailLocation) {
                    els.detailLocation.textContent = incident.location;
                    console.log('detailLocation.textContent set to:', els.detailLocation.textContent);
                }
                if (els.detailSeverity) {
                    els.detailSeverity.textContent = incident.severity;
                    console.log('detailSeverity.textContent set to:', els.detailSeverity.textContent);
                }
                if (els.detailStatus) {
                    els.detailStatus.textContent = incident.status;
                    console.log('detailStatus.textContent set to:', els.detailStatus.textContent);
                }
                if (els.detailDateTime) {
                    els.detailDateTime.textContent = new Date(incident.dateTime).toLocaleString();
                    console.log('detailDateTime.textContent set to:', els.detailDateTime.textContent);
                }
                if (els.detailCause) {
                    els.detailCause.textContent = incident.cause;
                    console.log('detailCause.textContent set to:', els.detailCause.textContent);
                }
                if (els.detailIsDuplicate) {
                    els.detailIsDuplicate.textContent = incident.isDuplicate ? 'Yes' : 'No';
                    console.log('detailIsDuplicate.textContent set to:', els.detailIsDuplicate.textContent);
                }
                console.log('Populating modal fields complete.');

                // Display the modal
                closeAllPopups(els.incidentDetailsModal.id);
                console.log('Removing hidden class from incident details modal. Current classes before removal:', els.incidentDetailsModal.classList);
                els.incidentDetailsModal.classList.remove('hidden');
                console.log('Incident details modal visibility:', els.incidentDetailsModal.classList.contains('hidden') ? 'hidden' : 'visible');
            }


            function applyFiltersToAllIncidents() {
                const status = els.modalStatusFilter.value;
                const severity = els.modalSeverityFilter.value;
                const time = els.modalTimeFilter.value;
                const year = els.modalYearFilter.value;
                const month = els.modalMonthFilter.value;
                const day = els.modalDayFilter.value;
                const search = els.modalSearchInput.value.toLowerCase();

                const now = new Date();

                let filtered = allFireIncidents.filter(inc => {
                    const incidentDate = new Date(inc.dateTime);

                    const matchesStatus = status === 'all' || inc.status === status;
                    const matchesSeverity = severity === 'all' || inc.severity === severity;
                    const matchesSearch = search === '' || inc.location.toLowerCase().includes(search) || inc.id.toLowerCase().includes(search);

                    let matchesDate = true;
                    if (year !== 'all' || month !== 'all' || day !== 'all') {
                        if (year !== 'all' && incidentDate.getFullYear() !== parseInt(year)) {
                            matchesDate = false;
                        }
                        if (month !== 'all' && (incidentDate.getMonth() + 1) !== parseInt(month)) {
                            matchesDate = false;
                        }
                        if (day !== 'all' && incidentDate.getDate() !== parseInt(day)) {
                            matchesDate = false;
                        }
                    } else if (time !== 'all') {
                        if (time === 'last_24_hours') {
                            matchesDate = incidentDate > new Date(now.getTime() - (24 * 60 * 60 * 1000));
                        } else if (time === 'last_7_days') {
                            matchesDate = incidentDate > new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                        }
                    }
                    return matchesStatus && matchesSeverity && matchesSearch && matchesDate;
                });

                populateIncidentsTable(filtered);
            }

            // --- Notification Management (now client-side simulated) ---
            function loadNotifications() {
                // --- BACKEND INTEGRATION POINT (Django) ---
                // Fetch notifications from your Django API.
                // Example: fetch('/api/notifications/')
                // You might also have an endpoint to mark notifications as read (e.g., PUT /api/notifications/{id}/mark_read/).
                const sortedNotifications = [...simulatedNotifications].sort((a, b) => b.timestamp - a.timestamp);
                renderNotificationsToUI(sortedNotifications);
            }

            function renderNotificationsToUI(notifications) {
                if (!els.notificationList || !els.notificationDot) {
                    if (els.notificationList) {
                        els.notificationList.innerHTML = `<div class="text-center p-4 text-slate-400">Error loading notifications.</div>`;
                    }
                    return;
                }

                els.notificationList.innerHTML = ''; 
                let hasUnread = false;

                if (notifications.length === 0) {
                    els.notificationList.innerHTML = `<div class="text-center p-4 text-slate-400">No new notifications.</div>`;
                } else {
                    notifications.forEach(notif => {
                        if (notif.unread) hasUnread = true;
                        const timeString = notif.timestamp instanceof Date ? notif.timestamp.toLocaleString() : 'N/A';
                        const itemHTML = `
                            <div class="notification-item" data-notification-id="${notif.id}">
                                <div class="icon-circle">${notif.messageTitle.substring(0, 2)}</div>
                                <div class="content">
                                    <p class="title">${notif.messageTitle}</p>
                                    <p class="subtitle">${notif.messageSubtitle}</p>
                                    <p class="time">${notif.details}  ${timeString}</p>
                                </div>
                            </div>
                        `;
                        els.notificationList.insertAdjacentHTML('beforeend', itemHTML);
                    });
                }
                els.notificationDot.classList.toggle('hidden', !hasUnread);
            }

            // --- Video Management Functions ---
            function populateCategoryDropdown() {
                if (!els.videoCategorySelect) return;
                els.videoCategorySelect.innerHTML = '<option value="">Select Category</option>';

                // --- BACKEND INTEGRATION POINT (Django) ---
                // Fetch categories from your Django backend (e.g., /api/video-categories/).
                // Or, if categories are static, define them in Django settings and expose via context or a simple view.
                const categories = new Set();
                youtubeVideos.forEach(video => {
                    if (video.category) categories.add(video.category);
                });

                Array.from(categories).sort().forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    els.videoCategorySelect.appendChild(option);
                });
            }

            function renderExistingVideos(searchTerm = '') {
                if (!els.existingVideosList) return;

                els.existingVideosList.innerHTML = '';
                const normalizedSearchTerm = searchTerm.toLowerCase().trim();

                // --- BACKEND INTEGRATION POINT (Django) ---
                // When integrating with Django, this function would likely make an API call
                // to fetch videos, potentially with query parameters for searching.
                // Example: fetch(`/api/videos/?search=${normalizedSearchTerm}`)
                const filteredVideos = youtubeVideos.filter(video => {
                    if (normalizedSearchTerm === '') return true;
                    const titleMatch = video.title.toLowerCase().includes(normalizedSearchTerm);
                    const descriptionMatch = video.description.toLowerCase().includes(normalizedSearchTerm);
                    const categoryMatch = video.category ? video.category.toLowerCase().includes(normalizedSearchTerm) : false;
                    return titleMatch || descriptionMatch || categoryMatch;
                });

                if (filteredVideos.length === 0) {
                    els.existingVideosList.innerHTML = `<div class="text-center text-gray-500 py-8 col-span-full">No videos found matching your search.</div>`;
                    return;
                }

                filteredVideos.forEach((video, index) => {
                    const videoCardId = `video-card-${video.id || index}`;
                    const videoHtml = `
                        <div class="video-card" id="${videoCardId}">
                            <iframe 
                                src="https://www.youtube.com/embed/${video.id}" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen
                                title="${video.title}"
                            ></iframe>
                            <div class="video-info">
                                <div class="video-title">${video.title}</div>
                                <div class="video-description">${video.description}</div>
                            </div>
                            <div class="video-card-actions">
                                <button class="edit-btn" data-video-id="${video.id}" title="Edit Video"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" data-video-id="${video.id}" title="Delete Video"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    `;
                    els.existingVideosList.insertAdjacentHTML('beforeend', videoHtml);
                });

                els.existingVideosList.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.stopPropagation();
                        editVideo(event.currentTarget.dataset.videoId);
                    });
                });
                els.existingVideosList.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        event.stopPropagation();
                        confirmDeleteVideo(event.currentTarget.dataset.videoId);
                    });
                });
            }

            function editVideo(videoId) {
                // --- BACKEND INTEGRATION POINT (Django) ---
                // In a real app, you might fetch the specific video details from an API
                // (e.g., GET /api/videos/{id}/) before populating the form.
                const videoToEdit = youtubeVideos.find(video => video.id === videoId);
                if (!videoToEdit) return;

                if (!els.formTitle || !els.submitVideoButton || !els.cancelEditButton || !els.youtubeEmbedCodeInput || !els.videoTitleInput || !els.videoDescriptionInput || !els.videoCategorySelect) return;

                els.formTitle.textContent = 'Edit Video';
                els.submitVideoButton.innerHTML = '<i class="fas fa-save mr-2"></i> Save Changes';
                els.cancelEditButton.classList.remove('hidden');

                els.youtubeEmbedCodeInput.value = videoToEdit.id;
                els.videoTitleInput.value = videoToEdit.title;
                els.videoDescriptionInput.value = videoToEdit.description;
                els.videoCategorySelect.value = videoToEdit.category || '';

                els.youtubeEmbedCodeInput.setAttribute('readonly', 'true'); // Prevent changing YouTube ID during edit
                editingVideoId = videoId;
            }

            function resetVideoForm() {
                if (!els.formTitle || !els.submitVideoButton || !els.cancelEditButton || !els.youtubeEmbedCodeInput || !els.videoTitleInput || !els.videoDescriptionInput || !els.videoCategorySelect || !els.addVideoMessage || !els.videoSearchInput) return;

                els.formTitle.textContent = 'Add New Video';
                els.submitVideoButton.innerHTML = '<i class="fas fa-plus-circle mr-2"></i> Add Video';
                els.cancelEditButton.classList.add('hidden');

                els.youtubeEmbedCodeInput.value = '';
                els.videoTitleInput.value = '';
                els.videoDescriptionInput.value = '';
                els.videoCategorySelect.value = '';
                
                els.youtubeEmbedCodeInput.removeAttribute('readonly'); // Re-enable for new video
                editingVideoId = null;
                els.addVideoMessage.classList.add('hidden');
                els.videoSearchInput.value = '';
                populateCategoryDropdown();
            }

            async function handleAddUpdateVideo(event) {
                event.preventDefault();
                if (!els.youtubeEmbedCodeInput || !els.videoTitleInput || !els.videoDescriptionInput || !els.videoCategorySelect || !els.addVideoMessage) return;


                const embedCode = els.youtubeEmbedCodeInput.value.trim();
                const title = els.videoTitleInput.value.trim();
                const description = els.videoDescriptionInput.value.trim();
                const category = els.videoCategorySelect.value.trim() || 'General';

                if (!embedCode || !title || !description) {
                    els.addVideoMessage.classList.remove('hidden', 'success');
                    els.addVideoMessage.classList.add('error');
                    els.addVideoMessage.textContent = 'Please fill in all required fields (Embed Code, Title, Description).';
                    return;
                }

                if (!editingVideoId) {
                    const youtubeIdRegex = /^[a-zA-Z0-9_-]{11}$/;
                    if (!youtubeIdRegex.test(embedCode)) {
                        els.addVideoMessage.classList.remove('hidden', 'success');
                        els.addVideoMessage.classList.add('error');
                        els.addVideoMessage.textContent = 'Invalid YouTube Embed Code (should be the 11-character video ID).';
                        return;
                    }
                }

                const videoData = {
                    id: embedCode, // Assuming YouTube ID is the primary key or unique identifier
                    title: title,
                    description: description,
                    category: category
                };

                let successMessage = '';
                let isError = false;

                if (editingVideoId) {
                    // --- BACKEND INTEGRATION POINT (Django) ---
                    // This would be a PUT or PATCH request to update an existing video.
                    // Example: await fetch(`/api/videos/${editingVideoId}/`, { method: 'PUT', body: JSON.stringify(videoData), headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') } });
                    const index = youtubeVideos.findIndex(video => video.id === editingVideoId);
                    if (index !== -1) {
                        youtubeVideos[index] = { ...youtubeVideos[index], ...videoData }; // Update existing properties
                        successMessage = 'Video updated successfully!';
                    } else {
                        isError = true;
                        successMessage = 'Error: Video not found for update.';
                    }
                } else {
                    // --- BACKEND INTEGRATION POINT (Django) ---
                    // This would be a POST request to create a new video.
                    // Example: await fetch('/api/videos/', { method: 'POST', body: JSON.stringify(videoData), headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') } });
                    youtubeVideos.push(videoData);
                    successMessage = 'Video added successfully!';
                }

                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, SIMULATED_DELAY / 2));

                if (isError) {
                    els.addVideoMessage.classList.remove('hidden', 'success');
                    els.addVideoMessage.classList.add('error');
                    els.addVideoMessage.textContent = successMessage;
                } else {
                    els.addVideoMessage.classList.remove('hidden', 'error');
                    els.addVideoMessage.classList.add('success');
                    els.addVideoMessage.textContent = successMessage;
                }

                resetVideoForm();
                renderExistingVideos(els.videoSearchInput?.value || ''); 
                setTimeout(() => els.addVideoMessage.classList.add('hidden'), 3000);
            }

            function confirmDeleteVideo(videoIdToDelete) {
                const videoToDelete = youtubeVideos.find(v => v.id === videoIdToDelete);
                if (!videoToDelete) return;

                if (!els.confirmationModalTitle || !els.confirmationModalMessage || !els.confirmationModal || !els.confirmActionButton || !els.cancelActionButton) return;

                els.confirmationModalTitle.textContent = 'Delete Video';
                els.confirmationModalMessage.innerHTML = `Are you sure you want to delete the video: <span class="font-bold text-white">"${videoToDelete.title}"</span>? This action cannot be undone.`;
                els.confirmationModal.classList.remove('hidden');

                // Clone buttons to remove existing event listeners and attach new ones
                const newConfirmBtn = els.confirmActionButton.cloneNode(true);
                const newCancelBtn = els.cancelActionButton.cloneNode(true);
                els.confirmActionButton.replaceWith(newConfirmBtn);
                els.cancelActionButton.replaceWith(newCancelBtn);
                els.confirmActionButton = newConfirmBtn; 
                els.cancelActionButton = newCancelBtn; 

                els.confirmActionButton.addEventListener('click', () => {
                    deleteVideo(videoIdToDelete);
                    els.confirmationModal.classList.add('hidden');
                });
                els.cancelActionButton.addEventListener('click', () => {
                    els.confirmationModal.classList.add('hidden');
                });
            }

            async function deleteVideo(videoId) {
                // --- BACKEND INTEGRATION POINT (Django) ---
                // This would be a DELETE request to your Django API.
                // Example: await fetch(`/api/videos/${videoId}/`, { method: 'DELETE', headers: { 'X-CSRFToken': getCookie('csrftoken') } });
                const initialLength = youtubeVideos.length;
                const videoTitle = youtubeVideos.find(v => v.id === videoId)?.title || 'Unknown Video';
                const filteredVideos = youtubeVideos.filter(video => video.id !== videoId);

                if (!els.addVideoMessage || !els.videoSearchInput) return; 

                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, SIMULATED_DELAY / 2));

                if (filteredVideos.length < initialLength) {
                    youtubeVideos.length = 0; // Clear array
                    Array.prototype.push.apply(youtubeVideos, filteredVideos); // Repopulate with filtered
                    els.addVideoMessage.classList.remove('hidden', 'error');
                    els.addVideoMessage.classList.add('success');
                    els.addVideoMessage.textContent = `Video "${videoTitle}" deleted successfully!`;
                } else {
                    els.addVideoMessage.classList.remove('hidden', 'success');
                    els.addVideoMessage.classList.add('error');
                    els.addVideoMessage.textContent = `Error: Video "${videoTitle}" not found for deletion.`;
                }

                renderExistingVideos(els.videoSearchInput.value);
                populateCategoryDropdown();
                setTimeout(() => els.addVideoMessage.classList.add('hidden'), 3000);
            }

            // Helper function to get CSRF token for Django (if using Django's CSRF protection)
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }


            // --- Event Listeners Initialization ---
            function initEventListeners() {
                // Sidebar
                sidebar.init();

                // Dropdowns
                if (els.notificationButton) {
                    els.notificationButton.addEventListener('click', (event) => {
                        event.stopPropagation();
                        closeAllPopups(els.notificationDropdown?.id); 
                        if (els.notificationDropdown) { 
                            const isDropdownHidden = els.notificationDropdown.classList.contains('hidden'); 
                            els.notificationDropdown.classList.toggle('hidden');
                            els.notificationButton.classList.toggle('active', !isDropdownHidden);
                            if (!isDropdownHidden && els.notificationDot) { 
                                els.notificationDot.classList.add('hidden'); // Hide dot when opened
                            }
                        }
                    });
                }
                if (els.closeNotificationBtn) els.closeNotificationBtn.addEventListener('click', () => {
                    if (els.notificationDropdown) els.notificationDropdown.classList.add('hidden'); 
                    if (els.notificationButton) els.notificationButton.classList.remove('active'); 
                });

                // All Incidents Modal
                if (els.viewAllIncidentsLink) els.viewAllIncidentsLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    closeAllPopups();
                    populateDateFilters();
                    populateIncidentsTable(allFireIncidents);
                    if (els.allIncidentsModal) els.allIncidentsModal.classList.remove('hidden');
                });
                if (els.closeAllIncidentsModal) els.closeAllIncidentsModal.addEventListener('click', () => {
                    if (els.allIncidentsModal) els.allIncidentsModal.classList.add('hidden');
                });
                const modalFilters = [
                    els.modalStatusFilter, els.modalSeverityFilter, els.modalTimeFilter,
                    els.modalYearFilter, els.modalMonthFilter, els.modalDayFilter
                ];
                modalFilters.forEach(filter => {
                    if (filter) filter.addEventListener('change', applyFiltersToAllIncidents);
                });
                if (els.modalSearchInput) els.modalSearchInput.addEventListener('input', applyFiltersToAllIncidents);

                // Incident Details Modal
                if (els.closeIncidentDetailsModal) els.closeIncidentDetailsModal.addEventListener('click', () => {
                    if (els.incidentDetailsModal) els.incidentDetailsModal.classList.add('hidden');
                });
                if (els.closeDetailsButton) els.closeDetailsButton.addEventListener('click', () => {
                    if (els.incidentDetailsModal) els.incidentDetailsModal.classList.add('hidden');
                });


                // Active Incidents Table Filters
                if (els.activeStatusFilter) els.activeStatusFilter.addEventListener('change', renderActiveIncidentsTable);
                if (els.activeSeverityFilter) els.activeSeverityFilter.addEventListener('change', renderActiveIncidentsTable);
                if (els.activeSearch) els.activeSearch.addEventListener('input', renderActiveIncidentsTable);

                // Video Management Modal
                if (els.manageVideosButton) els.manageVideosButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    closeAllPopups(els.videoManagementModal?.id); 
                    resetVideoForm();
                    populateCategoryDropdown();
                    renderExistingVideos();
                    if (els.videoManagementModal) els.videoManagementModal.classList.remove('hidden');
                });
                if (els.closeVideoManagementModal) els.closeVideoManagementModal.addEventListener('click', () => {
                    if (els.videoManagementModal) els.videoManagementModal.classList.add('hidden');
                    resetVideoForm();
                });
                if (els.addVideoForm) els.addVideoForm.addEventListener('submit', handleAddUpdateVideo);
                if (els.cancelEditButton) els.cancelEditButton.addEventListener('click', resetVideoForm);
                if (els.videoSearchInput) els.videoSearchInput.addEventListener('input', (event) => renderExistingVideos(event.target.value));
            
                // Statistics Chart Month/Year filters
                if (els.statisticsMonthFilter) els.statisticsMonthFilter.addEventListener('change', () => {
                    renderStatisticsChart(els.statisticsMonthFilter.value, els.statisticsYearFilter.value);
                });
                if (els.statisticsYearFilter) els.statisticsYearFilter.addEventListener('change', () => {
                    renderStatisticsChart(els.statisticsYearFilter.value, els.statisticsMonthFilter.value);
                });

                // Global click listener to close popups
                document.addEventListener('click', (event) => {
                    const clickedInsideAnyModal = event.target ? event.target.closest('.modal-overlay:not(.hidden)') : null;
                    const clickedInsideHeader = event.target ? event.target.closest('#main-header') : null;
                    if (!clickedInsideHeader && !clickedInsideAnyModal) {
                        closeAllPopups();
                    }
                });
            }

            // --- Main Initialization on DOM Content Loaded ---
            document.addEventListener('DOMContentLoaded', () => {
                initEventListeners();
                loadDashboardStats();
                renderActiveIncidentsTable();
                populateStatisticsFilters();
                loadNotifications(); 
            });

            // Initialize charts after window has fully loaded all resources
            window.onload = () => {
                initMonthlyChart();
                if (els.statisticsMonthFilter && els.statisticsYearFilter) {
                    renderStatisticsChart(els.statisticsMonthFilter.value, els.statisticsYearFilter.value); 
                }
            };

        })(); 
    </script>
</body>
</html>

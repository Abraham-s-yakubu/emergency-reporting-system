<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Accident Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <style>
        /* Base styles for the entire page */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A1128; /* Deep navy blue background */
            color: #E0E7FF; /* Light blue-gray text color */
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 1.5rem; /* Consistent padding */
            gap: 1.5rem; /* Spacing between sections */
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            gap: 1.5rem;
            overflow: hidden; /* Ensure content within is scrollable if needed */
        }

        .map-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        #map {
            flex-grow: 1;
            background-color: #1E293B;
            border-radius: 1.5rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.35);
            overflow: hidden;
            position: relative;
        }

        /* Accident details panel styles - slides in from the right */
        #accidentDetailsPanel {
            width: 350px; /* More compact width */
            background-color: #1E293B;
            border-left: 1px solid #334155;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.4);
            transform: translateX(100%); /* Start off-screen to the right */
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth slide animation */
            z-index: 102; /* Increased z-index for better visibility */
            overflow-y: auto;
            flex-shrink: 0;
            border-radius: 1.5rem 0 0 1.5rem; /* Rounded on left edge */
            padding: 1.5rem; /* Reduced padding */
            max-height: calc(100vh - 6rem); /* Adjusted max-height for cleaner appearance */
        }
        #accidentDetailsPanel.open {
            transform: translateX(0); /* Slide into view */
        }
        /* Ensure display is block when open, none when hidden */
        #accidentDetailsPanel.hidden {
            display: none;
        }


        /* Map Filters Panel - slides in from the left */
        #mapFiltersPanel {
            width: 300px; /* Width of the filter panel */
            background-color: #1E293B;
            border-right: 1px solid #334155;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.4);
            transform: translateX(-100%); /* Start off-screen to the left */
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth slide animation */
            z-index: 100; /* Ensure it's on top */
            overflow-y: auto;
            flex-shrink: 0;
            border-radius: 0 1.5rem 1.5rem 0; /* Rounded on right edge */
            padding: 1.5rem;
            position: absolute; /* Position absolutely over the map */
            height: 100%; /* Take full height of map area */
            top: 0;
            left: 0;
        }
        #mapFiltersPanel.open {
            transform: translateX(0); /* Slide into view */
        }
        #mapFiltersPanel.hidden {
            display: none; /* Hide when not in use to prevent interaction */
        }


        /* Common styles for form controls (inputs, selects, textareas) used throughout the app */
        .filter-control, .detail-input, .detail-select, .detail-textarea {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            background-color: #2D3748;
            color: #E0E7FF;
            border: 1px solid #4A5568;
            font-size: 0.95rem;
            transition: all 0.2s ease-in-out;
            width: 100%;
        }
        .filter-control:focus, .detail-input:focus, .detail-select:focus, .detail-textarea:focus {
            outline: none;
            border-color: #3B82F6; /* Blue focus for accident theme */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); /* Blue shadow */
        }
        /* Style for disabled/read-only inputs */
        .detail-input:disabled, .detail-select:disabled, .detail-textarea:disabled,
        .detail-input[readonly], .detail-select[readonly], .detail-textarea[readonly] {
            background-color: #1A202C; /* Darker background for non-editable fields */
            color: #A0AEC0; /* Lighter grey text */
            cursor: not-allowed;
            border-color: #2D3748;
        }

        /* Common button styles - Primary Action Button */
        .btn-primary {
            padding: 0.85rem 1.75rem;
            background-image: linear-gradient(to right, #3B82F6, #1D4ED8); /* Blue gradient background for accident theme */
            color: white;
            font-weight: 600;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3); /* Blue shadow */
            transition: all 0.3s ease-in-out;
            transform: translateY(0);
        }
        .btn-primary:hover {
            box-shadow: 0 12px 25px rgba(59, 130, 246, 0.4); /* Darker blue shadow */
            transform: translateY(-2px); /* Slight lift on hover */
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.2); /* Lighter blue shadow */
        }
        /* Style for small primary button (used in the all accidents modal) */
        .btn-primary-small {
            padding: 0.5rem 1rem;
            background-image: linear-gradient(to right, #3B82F6, #1D4ED8); /* Blue gradient */
            color: white;
            font-weight: 600;
            border-radius: 0.75rem; /* Slightly less rounded than large button */
            font-size: 0.85rem;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2); /* Blue shadow */
            transition: all 0.3s ease-in-out;
            transform: translateY(0);
        }
        .btn-primary-small:hover {
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.3); /* Darker blue shadow */
            transform: translateY(-1px);
        }
        .btn-primary-small:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1); /* Lighter blue shadow */
        }

        /* Common button styles - Secondary Action Button */
        .btn-secondary {
            padding: 0.85rem 1.75rem;
            background-color: #4A5568;
            color: #E0E7FF;
            font-weight: 500;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease-in-out;
            transform: translateY(0);
        }
        .btn-secondary:hover {
            background-color: #64748B;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* --- Modal Styles START --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            backdrop-filter: blur(8px); /* Frosted glass effect */
        }
        .modal.hidden {
            display: none;
        }
        .modal-content {
            background-color: #1E293B;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            border: 1px solid #334155;
            animation: slideIn 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; /* Smooth entry animation */
        }
        .modal-title {
            font-size: 2rem;
            font-weight: 700;
            color: #E0E7FF;
            margin-bottom: 1.5rem;
        }
        .modal-close-button {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            color: #A0AEC0;
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        .modal-close-button:hover {
            color: #E0E7FF;
        }
        .modal-checkbox-label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            color: #CBD5E1;
            font-size: 1rem;
            transition: color 0.2s ease-in-out;
        }
        .modal-checkbox-label:hover {
            color: #E0E7FF;
        }
        .modal-checkbox-label input[type="checkbox"] {
            height: 1.5rem;
            width: 1.5rem;
            border-radius: 0.375rem;
            background-color: #2D3748;
            border: 1px solid #4A5568;
            transition: all 0.2s ease-in-out;
        }
        .modal-checkbox-label input[type="checkbox"]:checked {
            background-color: #3B82F6; /* Blue checkbox checked color */
            border-color: #3B82F6; /* Blue border */
        }
        .modal-checkbox-label input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); /* Blue shadow */
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* --- Modal Styles END --- */


        /* Drawing controls for map interactions (top-left) */
        #drawingControls {
            position: absolute;
            top: 1.5rem;
            left: 1.5rem;
            background-color: #1E293B;
            padding: 0.75rem;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        #drawingControls button {
            padding: 0.75rem;
            background-color: #2D3748;
            color: #E0E7FF;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        #drawingControls button:hover {
            background-color: #4A5568;
            transform: translateY(-1px);
        }
        #drawingControls button.active {
            background-color: #3B82F6; /* Blue active state */
            color: white;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); /* Blue shadow */
        }
        #drawingControls button.active:hover {
            background-color: #1D4ED8; /* Darker blue on hover */
        }

        /* Layer switcher controls for base map layers (top-right) */
        #layerSwitcher {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background-color: #1E293B;
            padding: 0.75rem;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        #layerSwitcher button {
            padding: 0.75rem 1.25rem;
            background-color: #2D3748;
            color: #E0E7FF;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        #layerSwitcher button:hover {
            background-color: #4A5568;
            transform: translateY(-1px);
        }
        #layerSwitcher button.active {
            background-color: #3B82F6; /* Blue active state */
            color: white;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); /* Blue shadow */
        }
        #layerSwitcher button.active:hover {
            background-color: #1D4ED8; /* Darker blue on hover */
        }

        /* Map interaction controls (bottom-left) */
        #mapInteractionControls {
            position: absolute;
            bottom: 1.5rem;
            left: 1.5rem;
            background-color: #1E293B;
            padding: 0.75rem;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        #mapInteractionControls button { /* Added this block for consistency */
            padding: 0.75rem;
            background-color: #2D3748;
            color: #E0E7FF;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        #mapInteractionControls button:hover {
            background-color: #4A5568;
            transform: translateY(-1px);
        }

        /* Bottom control bar for global actions like map filters and the new "View All Accidents" button */
        .bottom-control-bar {
            background-color: #152238;
            border-radius: 1.5rem;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
            padding: 1rem 2rem;
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-shrink: 0;
            position: relative;
        }
        .bottom-control-bar .control-button {
            padding: 0.75rem 1.25rem;
            background-color: #2D3748;
            color: #E0E7FF;
            font-weight: 500;
            border-radius: 1rem;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .bottom-control-bar .control-button:hover {
            background-color: #4A5568;
            transform: translateY(-2px);
        }
        .bottom-control-bar .control-button svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        /* OpenLayers Popup styling for accident details on hover */
        #popup {
            background-color: #1E293B;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            padding: 1rem;
            position: absolute;
            transform: translate(-50%, -100%) translate(10px, -25px); /* Adjusted for better offset */
            min-width: 180px;
            z-index: 10;
            display: none; /* Hidden by default */
            border: 1px solid #334155;
        }
        #popup-closer {
            text-decoration: none;
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: #A0AEC0;
            font-size: 1rem;
            transition: color 0.2s ease-in-out;
        }
        #popup-closer:hover {
            color: #E0E7FF;
        }
        #popup-content {
            font-size: 0.9rem;
            color: #E0E7FF;
            margin-top: 0.5rem;
        }
        #popup-content strong {
            color: #FFFFFF;
        }
        #popup-content p {
            margin-bottom: 0.25rem;
        }

        /* Styles for the new full-screen accidents modal (reusable modal structure) */
        #allAccidentsModal .modal-content {
            width: 90%;
            height: 90%;
            padding: 0; /* Remove padding from here, add to inner divs for content control */
            display: flex;
            flex-direction: column;
        }
        #allAccidentsModal .modal-header {
            flex-shrink: 0;
            padding: 1.5rem;
            border-bottom: 1px solid #334155;
        }
        #allAccidentsModal .modal-body {
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for table content */
            padding: 1.5rem;
        }
        #allAccidentsModal table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5rem; /* Adds space between rows */
        }
        #allAccidentsModal thead th {
            background-color: #152238; /* Darker header for table */
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: #CBD5E1;
            position: sticky; /* Make table header sticky */
            top: -1.5rem; /* Offset for padding of modal-body to keep header visible on scroll */
            z-index: 1;
            border-radius: 0.75rem; /* Rounded corners for header cells */
            text-align: left;
        }
        #allAccidentsModal tbody tr {
            background-color: #2D3748; /* Slightly lighter row background */
            transition: background-color 0.2s ease-in-out;
            border-radius: 0.75rem;
        }
        #allAccidentsModal tbody tr:hover {
            background-color: #4A5568; /* Hover effect */
        }
        #allAccidentsModal tbody td {
            padding: 0.75rem 1rem;
            color: #E0E7FF;
        }
        /* Rounded corners for table cells to match row styling */
        #allAccidentsModal tbody tr td:first-child { border-top-left-radius: 0.75rem; border-bottom-left-radius: 0.75rem; }
        #allAccidentsModal tbody tr td:last-child { border-top-right-radius: 0.75rem; border-bottom-right-radius: 0.75rem; }

        /* Status badges within the table */
        #allAccidentsModal .status-badge {
            padding: 0.3em 0.6em;
            border-radius: 0.5rem;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
            display: inline-block;
        }
        #allAccidentsModal .status-reported { background-color: #FACC15; color: #334155; }
        #allAccidentsModal .status-closed { background-color: #22C55E; }
        #allAccidentsModal .status-active { background-color: #3B82F6; }

        /* Severity text colors within the table */
        #allAccidentsModal .severity-text {
            font-weight: 600;
        }
        #allAccidentsModal .severity-critical { color: #EF4444; } /* Red */
        #allAccidentsModal .severity-serious { color: #F97316; } /* Orange */
        #allAccidentsModal .severity-minor { color: #22C55E; } /* Green */
        #allAccidentsModal .modal-footer {
            flex-shrink: 0;
            padding: 1rem;
            border-top: 1px solid #334155;
            text-align: center;
        }

        /* Styles for filter controls within the modal - flexible layout */
        #allAccidentsModal .filter-group {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 1rem;
            margin-top: 1rem;
            align-items: flex-end; /* Align buttons/inputs to the bottom */
        }
        #allAccidentsModal .filter-item {
            flex: 1; /* Distribute space evenly */
            min-width: 100px; /* Adjusted min-width for date filters to prevent squishing */
        }
        #allAccidentsModal .filter-item.search-item {
            min-width: 150px; /* Ensure search bar has enough space */
        }
        #allAccidentsModal .filter-item label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: #CBD5E1;
        }
        #allAccidentsModal .filter-item select,
        #allAccidentsModal .filter-item input[type="text"] {
            width: 100%;
            padding: 0.6rem 0.8rem; /* Slightly smaller padding for modal filters */
            border-radius: 0.6rem;
            background-color: #2D3748;
            color: #E0E7FF;
            border: 1px solid #4A5568;
            font-size: 0.9rem;
        }
        #allAccidentsModal .filter-item button {
            width: auto; /* Allow button to size to content */
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            align-self: flex-end; /* Push button to the bottom if other items are taller */
        }

        /* Specific styles for the new single accident details modal */
        #singleAccidentDetailsModal .modal-content {
            max-width: 500px; /* Smaller width for this modal */
            padding: 2rem;
        }
        #singleAccidentDetailsModal .modal-header {
            border-bottom: none; /* No border for this smaller modal's header */
            padding-bottom: 0;
            margin-bottom: 1rem;
        }
        #singleAccidentDetailsModal .modal-title {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }
        #singleAccidentDetailsModal .detail-field {
            margin-bottom: 0.75rem;
        }
        #singleAccidentDetailsModal .detail-field p {
            margin-bottom: 0.25rem;
        }
        #singleAccidentDetailsModal .detail-field strong {
            color: #E0E7FF;
            font-weight: 600;
        }
        #singleAccidentDetailsModal .detail-field span {
            color: #CBD5E1;
            font-size: 0.95rem;
        }
        #singleAccidentDetailsModal .media-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }
        #singleAccidentDetailsModal .media-container img {
            border-radius: 0.5rem;
            width: 100%;
            height: auto;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #singleAccidentDetailsModal .no-media {
            background-color: #1A202C;
            border: 1px dashed #2D3748;
            color: #4A5568;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container">
        <!-- Main content area, including the map and details panel -->
        <div class="main-content">
            <div class="map-area">
                <div id="map" class="rounded-xl">
                    <!-- Popup for displaying brief accident info on map hover -->
                    <div id="popup" class="ol-popup">
                        <a href="#" id="popup-closer" class="ol-popup-closer">x</a>
                        <div id="popup-content"></div>
                    </div>

                    <!-- Drawing controls for adding points, lines, polygons to the map -->
                    <div id="drawingControls" class="absolute top-6 left-6 flex flex-col gap-3">
                        <button id="drawPointBtn" title="Draw Point">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.5 7.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0zm4.5 1.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button id="drawLineBtn" title="Draw Line">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button id="drawPolygonBtn" title="Draw Polygon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-3.5-7.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z" clip-rule="evenodd" />
                        </svg>
                        </button>
                        <button id="clearDrawingsBtn" title="Clear All Drawings">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <!-- Layer switcher controls for changing the base map layer -->
                    <div id="layerSwitcher" class="absolute top-6 right-6 flex flex-col gap-3">
                        <button id="osmLayerBtn" class="active" title="Standard Map Layer">Standard Map</button>
                        <button id="satelliteLayerBtn" title="Satellite Layer">Satellite</button>
                        <button id="terrainLayerBtn" title="Terrain Map Layer">Terrain Map</button>
                    </div>

                    <!-- Map interaction controls like zoom, locate, and fullscreen -->
                    <div id="mapInteractionControls" class="absolute bottom-6 left-6 flex flex-col gap-3">
                        <button id="zoomInBtn" title="Zoom In">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                        </button>
                        <button id="zoomOutBtn" title="Zoom Out">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                            </svg>
                        </button>
                        <button id="locateMeBtn" title="Locate Me">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                        <button id="fullscreenBtn" title="Toggle Fullscreen">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5v4m0-4h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Accident Details Panel - slides in from the right when an accident is selected -->
            <div id="accidentDetailsPanel" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">Accident Details</h2>
                    <button id="closeDetailsPanel" class="modal-close-button">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-4 text-slate-300 flex-grow text-base">
                    <div>
                        <p class="font-semibold text-slate-400">Report ID:</p>
                        <p id="detailReportId" class="text-white font-bold text-lg"></p>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-400">Location:</p>
                        <p id="detailLocation"></p>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-400">Date/Time:</p>
                        <p id="detailDateTime"></p>
                    </div>
                    <div>
                        <label for="detailCause" class="font-semibold text-slate-400 block mb-1">Cause:</label>
                        <input type="text" id="detailCause" class="detail-input" disabled>
                    </div>
                    <div>
                        <label for="detailSeverity" class="font-semibold text-slate-400 block mb-1">Severity:</label>
                        <select id="detailSeverity" class="detail-select" disabled>
                            <option value="Critical">Critical</option>
                            <option value="Serious">Serious</option>
                            <option value="Minor">Minor</option>
                        </select>
                    </div>
                    <div>
                        <label for="detailStatus" class="font-semibold text-slate-400 block mb-1">Status:</label>
                        <select id="detailStatus" class="detail-select" disabled>
                            <option value="Reported">Reported</option>
                            <option value="Active">Active</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div>
                        <label for="detailVehicleInvolved" class="font-semibold text-slate-400 block mb-1">Vehicles Involved:</label>
                        <input type="number" id="detailVehicleInvolved" class="detail-input" min="0" disabled>
                    </div>
                    <div>
                        <label for="detailFatalities" class="font-semibold text-slate-400 block mb-1">Fatalities:</label>
                        <input type="number" id="detailFatalities" class="detail-input" min="0" disabled>
                    </div>
                    <div>
                        <label for="detailInjuries" class="font-semibold text-slate-400 block mb-1">Injuries:</label>
                        <input type="number" id="detailInjuries" class="detail-input" min="0" disabled>
                    </div>
                    <div>
                        <label for="detailResponseTime" class="font-semibold text-slate-400 block mb-1">Response Time (min):</label>
                        <input type="number" id="detailResponseTime" class="detail-input" min="0" disabled>
                    </div>
                    <div>
                        <label for="detailDescription" class="font-semibold text-slate-400 block mb-1">Description:</label>
                        <textarea id="detailDescription" class="detail-textarea h-20" disabled></textarea>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-400">Attached Media:</p>
                        <div id="detailMedia" class="grid grid-cols-2 gap-3 mt-2">
                            </div>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-400">Admin Log:</p>
                        <div id="detailAdminLog" class="bg-slate-700 p-3 rounded-lg text-xs max-h-24 overflow-y-auto border border-slate-600"></div>
                    </div>
                    <div>
                        <label for="detailInternalNotes" class="font-semibold text-slate-400 block mb-1">Internal Notes:</label>
                        <textarea id="detailInternalNotes" class="detail-textarea h-20" disabled></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="editAccidentBtn" class="btn-secondary">Edit Details</button>
                    <button id="updateAccidentBtn" class="btn-primary hidden">Update Accident</button>
                    <button id="cancelEditBtn" class="btn-secondary hidden">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Filters Panel - new sidebar design -->
    <div id="mapFiltersPanel" class="hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">Map Filters</h2>
            <button id="closeFiltersPanel" class="modal-close-button">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="space-y-4">
            <div class="flex flex-col gap-2">
                <label for="statusFilter" class="text-slate-300 text-sm font-medium">Status:</label>
                <select id="statusFilter" class="filter-control">
                    <option value="all">All</option>
                    <option value="Reported">Reported</option>
                    <option value="Active">Active</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <div class="flex flex-col gap-2">
                <label for="severityFilter" class="text-slate-300 text-sm font-medium">Severity:</label>
                <select id="severityFilter" class="filter-control">
                    <option value="all">All</option>
                    <option value="Critical">Critical</option>
                    <option value="Serious">Serious</option>
                    <option value="Minor">Minor</option>
                </select>
            </div>
            <div class="flex flex-col gap-2">
                <label for="timeRangeFilter" class="text-slate-300 text-sm font-medium">Time:</label>
                <select id="timeRangeFilter" class="filter-control">
                    <option value="all">All Time</option>
                    <option value="last_hour">Last Hour</option>
                    <option value="last_24_hours">Last 24 Hours</option>
                    <option value="last_7_days">Last 7 Days</option>
                </select>
            </div>
            <div class="flex flex-col gap-2">
                <label for="searchBar" class="text-slate-300 text-sm font-medium">Search:</label>
                <input type="text" id="searchBar" placeholder="Location or ID..." class="filter-control">
            </div>
        </div>
    </div>

    <!-- Bottom control bar for global actions -->
    <div class="bottom-control-bar">
        <button id="openFiltersPanelBtn" class="control-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01.293.707l3 3A1 1 0 0121 14v5a1 1 0 01-1 1H4a1 1 0 01-1-1v-5a1 1 0 01.293-.707l3-3A1 1 0 016 6.586V4z" />
            </svg>
            <span>Map Filters</span>
        </button>
        <button id="viewAllAccidentsBtn" class="btn-primary flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-6 w-6">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
            <span>View All Accidents</span>
        </button>
    </div>

    <!-- Notification Preferences Modal (can be triggered by other means if needed) -->
    <div id="notificationPreferencesModal" class="modal hidden">
        <div class="modal-content w-full md:w-2/3 lg:w-1/3">
            <button class="modal-close-button" onclick="closeAllPopups();">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="modal-title">Notification Preferences</h2>
            <div class="space-y-5">
                <div>
                    <label class="modal-checkbox-label">
                        <input type="checkbox" id="notifyCriticalSeverity" class="form-checkbox" checked>
                        <span class="ml-3">New Critical Severity Accident Alerts</span>
                    </label>
                </div>
                <div>
                    <label class="modal-checkbox-label">
                        <input type="checkbox" id="notifySeriousSeverity" class="form-checkbox">
                        <span class="ml-3">New Serious Severity Accident Alerts</span>
                    </label>
                </div>
                <div>
                    <label class="modal-checkbox-label">
                        <input type="checkbox" id="notifyMinorSeverity" class="form-checkbox">
                        <span class="ml-3">New Minor Severity Accident Alerts</span>
                    </label>
                </div>
                <div>
                    <label class="modal-checkbox-label">
                        <input type="checkbox" id="notifyDuplicateFlags" class="form-checkbox" checked>
                        <span class="ml-3">AI Duplicate Report Flags</span>
                    </label>
                </div>
                <div class="mt-6">
                    <p class="font-semibold text-slate-400 mb-3">Sound Alerts:</p>
                    <label class="modal-checkbox-label">
                        <input type="checkbox" id="enableSoundAlerts" class="form-checkbox">
                        <span class="ml-3">Enable Sound Notifications</span>
                    </label>
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button id="saveNotificationPreferences" class="btn-primary">Save Preferences</button>
            </div>
        </div>
    </div>

    <!-- Full-screen Modal for All Accidents Table -->
    <div id="allAccidentsModal" class="modal hidden">
        <div class="modal-content w-full h-full flex flex-col">
            <div class="modal-header flex justify-between items-center flex-wrap">
                <h2 class="modal-title mb-4 sm:mb-0">All Road Accidents</h2>
                <div class="filter-group w-full md:w-auto">
                    <div class="filter-item">
                        <label for="modalStatusFilter">Status:</label>
                        <select id="modalStatusFilter" class="filter-control">
                            <option value="all">All</option>
                            <option value="Reported">Reported</option>
                            <option value="Active">Active</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="modalSeverityFilter">Severity:</label>
                        <select id="modalSeverityFilter" class="filter-control">
                            <option value="all">All</option>
                            <option value="Critical">Critical</option>
                            <option value="Serious">Serious</option>
                            <option value="Minor">Minor</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="modalTimeRangeFilter">Time:</label>
                        <select id="modalTimeRangeFilter" class="filter-control">
                            <option value="all">All Time</option>
                            <option value="last_hour">Last Hour</option>
                            <option value="last_24_hours">Last 24 Hours</option>
                            <option value="last_7_days">Last 7 Days</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="modalYearFilter">Year:</label>
                        <select id="modalYearFilter" class="filter-control">
                            <option value="all">All</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="modalMonthFilter">Month:</label>
                        <select id="modalMonthFilter" class="filter-control">
                            <option value="all">All</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="modalDayFilter">Day:</label>
                        <select id="modalDayFilter" class="filter-control">
                            <option value="all">All</option>
                        </select>
                    </div>
                    <div class="filter-item flex-grow search-item">
                        <label for="modalSearchBar">Search:</label>
                        <input type="text" id="modalSearchBar" placeholder="Location or ID..." class="filter-control">
                    </div>
                    <button id="applyModalFiltersBtn" class="btn-primary">Apply Filters</button>
                </div>
                <button class="modal-close-button" onclick="closeAllPopups();">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <table class="w-full text-left">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Location</th>
                            <th>Severity</th>
                            <th>Status</th>
                            <th>Date/Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="allAccidentsTableBody">
                        <!-- Accident rows will be dynamically populated here -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <p class="text-slate-400">Total Accidents: <span id="totalAccidentsCount">0</span></p>
            </div>
        </div>
    </div>

    <!-- New: Single Accident Details Modal (appears on top of All Accidents Modal) -->
    <div id="singleAccidentDetailsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header flex justify-between items-center">
                <h2 class="modal-title" id="singleDetailReportId">Accident Details</h2>
                <button class="modal-close-button" onclick="closeAllPopups('allAccidentsModal');">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-3 text-slate-300 text-sm">
                <div class="detail-field">
                    <strong>Location:</strong> <span id="singleDetailLocation"></span>
                </div>
                <div class="detail-field">
                    <strong>Date/Time:</strong> <span id="singleDetailDateTime"></span>
                </div>
                <div class="detail-field">
                    <strong>Cause:</strong> <span id="singleDetailCause"></span>
                </div>
                <div class="detail-field">
                    <strong>Severity:</strong> <span id="singleDetailSeverity"></span>
                </div>
                <div class="detail-field">
                    <strong>Status:</strong> <span id="singleDetailStatus"></span>
                </div>
                <div class="detail-field">
                    <strong>Vehicles Involved:</strong> <span id="singleDetailVehicleInvolved"></span>
                </div>
                <div class="detail-field">
                    <strong>Fatalities:</strong> <span id="singleDetailFatalities"></span>
                </div>
                <div class="detail-field">
                    <strong>Injuries:</strong> <span id="singleDetailInjuries"></span>
                </div>
                <div class="detail-field">
                    <strong>Response Time:</strong> <span id="singleDetailResponseTime"></span> min
                </div>
                <div class="detail-field">
                    <strong>Description:</strong> <span id="singleDetailDescription"></span>
                </div>
                <div class="detail-field">
                    <strong>Admin Log:</strong> <div id="singleDetailAdminLog" class="bg-slate-700 p-2 rounded-md text-xs max-h-20 overflow-y-auto border border-slate-600 mt-1"></div>
                </div>
                <div class="detail-field">
                    <strong>Internal Notes:</strong> <span id="singleDetailInternalNotes"></span>
                </div>
                <div class="detail-field">
                    <strong>Attached Media:</strong>
                    <div id="singleDetailMedia" class="media-container">
                        <!-- Media will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="singleDetailViewOnMapBtn" class="btn-primary-small">View on Map</button>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol-ext@4.0.0/dist/ol-ext.min.js"></script>

    <script>
        // --- Global Map and State Variables ---
        let map;
        let accidentVectorSource;
        let accidentVectorLayer;
        let heatmapLayer; // Placeholder for potential future heatmap functionality
        let selectedAccidentFeature = null; // Stores the OpenLayers feature of the currently selected accident

        // Drawing specific variables for map interactions (e.g., drawing points, lines)
        let drawVectorSource;
        let drawVectorLayer;
        let drawInteraction;
        let activeDrawButton = null;

        // Base map layers for OpenLayers
        let osmLayer;
        let satelliteLayer;
        let openTopoMapLayer;

        // OpenLayers Popup overlay for displaying brief accident info on hover
        let popupOverlay;

        // Global variable for accident details panel element
        let accidentDetailsPanelElement;
        let mapFiltersPanelElement; // Global variable for map filters panel element
        let allAccidentsModalElement; // Global variable for all accidents modal element
        let notificationPreferencesModalElement; // Global variable for notification preferences modal element
        let singleAccidentDetailsModalElement; // New: Global variable for single accident details modal

        // Flag to prevent immediate closing of newly opened panels by global click listener
        let isPanelOpening = false;


        // --- Sample Data for Road Accidents ---
        // In a real Django application, this data would be fetched from a Django REST API endpoint.
        // The `accidentIncidents` array would be populated asynchronously after a successful fetch.
        // Example:
        // fetch('/api/accidents/') // Replace with your actual Django API endpoint for accidents
        //     .then(response => {
        //         if (!response.ok) {
        //             throw new Error(`HTTP error! status: ${response.status}`);
        //         }
        //         return response.json();
        //     })
        //     .then(data => {
        //         accidentIncidents = data; // Assign fetched data to accidentIncidents
        //         renderAccidentsOnMap(accidentIncidents); // Render initial map markers
        //         populateDateFilters(); // Populate modal filters based on fetched data
        //         applyFiltersAndSearch(); // Apply initial map filters
        //         applyFiltersToAllAccidentsModal(); // Apply initial modal table filters
        //     })
        //     .catch(error => console.error('Error fetching accident data:', error));
        const accidentIncidents = [
            {
                id: 'AC-KD001', location: 'Kaduna-Abuja Expressway, Km 50', lat: 9.7700, lng: 7.7500,
                dateTime: '2025-06-20T10:00', cause: 'Speeding', severity: 'Critical', status: 'Active',
                media: ['https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+1'],
                description: 'Multiple vehicle collision due to high speed. Road currently blocked. Emergency services en route.',
                adminLog: 'Admin User: Report Acknowledged (2025-06-20 10:05)\nAdmin User: FRSC and Police on scene (2025-06-20 10:20)',
                vehiclesInvolved: 5, fatalities: 3, injuries: 8, responseTime: 15, internalNotes: 'High priority. Traffic diversion critical.'
            },
            {
                id: 'AC-KD002', location: 'Zaria City Bypass, Near Ahmadu Bello Uni', lat: 11.0800, lng: 7.7200,
                dateTime: '2025-06-19T14:30', cause: 'Pothole', severity: 'Serious', status: 'Closed',
                media: [],
                description: 'Car veered off road hitting a large pothole. Driver sustained serious injuries. Vehicle recovered.',
                adminLog: 'Admin User: Report Acknowledged (2025-06-19 14:35)\nAdmin User: Accident cleared, road patched (2025-06-19 16:00)',
                vehiclesInvolved: 1, fatalities: 0, injuries: 1, responseTime: 40, internalNotes: 'Monitor road conditions regularly.'
            },
            {
                id: 'AC-KD003', location: 'Kafanchan-Jema\'a Road, Bridge Section', lat: 9.9400, lng: 8.3000,
                dateTime: '2025-06-18T08:15', cause: 'Brake Failure', severity: 'Critical', status: 'Active',
                media: ['https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+2'],
                description: 'Truck suffered brake failure on bridge, collided with two cars. Bridge integrity under assessment.',
                adminLog: 'Admin User: Report Acknowledged (2025-06-18 08:20)\nAdmin User: Structural engineers en route (2025-06-18 09:00)',
                vehiclesInvolved: 3, fatalities: 2, injuries: 5, responseTime: 20, internalNotes: 'Close bridge to traffic until assessment complete.'
            },
            {
                id: 'AC-KD004', location: 'Sokoto Road, Kaduna City', lat: 10.5100, lng: 7.4200,
                dateTime: '2025-06-17T11:00', cause: 'Driver Distraction', severity: 'Minor', status: 'Closed',
                media: [],
                description: 'Minor fender-bender. No injuries, minimal damage. Parties exchanged info and left.',
                adminLog: 'Admin User: Report Acknowledged (2025-06-17 11:05)',
                vehiclesInvolved: 2, fatalities: 0, injuries: 0, responseTime: 10, internalNotes: 'Typical minor incident.'
            },
            {
                id: 'AC-KD005', location: 'Kaduna Western Bye-pass, Refinery Area', lat: 10.4500, lng: 7.3700,
                dateTime: '2025-06-16T22:00', cause: 'Poor Visibility', severity: 'Serious', status: 'Active',
                media: ['https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+3'],
                description: 'Nighttime collision involving a tanker and a car due to heavy fog. Tanker carrying non-flammable liquid.',
                adminLog: 'Admin User: Report Acknowledged (2025-06-16 22:05)\nAdmin User: Tanker safely secured. Recovery ongoing (2025-06-16 23:00)',
                vehiclesInvolved: 2, fatalities: 1, injuries: 2, responseTime: 25, internalNotes: 'Monitor weather conditions for advisories.'
            },
            {
                id: 'AC-KD006', location: 'Abuja City Gate Intersection', lat: 9.0437, lng: 7.4939,
                dateTime: '2024-11-15T09:15', cause: 'Traffic Light Violation', severity: 'Serious', status: 'Closed',
                media: [],
                description: 'Two cars collided at City Gate. One driver ran a red light. Injuries reported.',
                adminLog: 'Admin User: Report Acknowledged (2024-11-15 09:20)\nAdmin User: Scene cleared (2024-11-15 10:30)',
                vehiclesInvolved: 2, fatalities: 0, injuries: 3, responseTime: 20, internalNotes: 'Recommend review of traffic light timing.'
            },
            {
                id: 'AC-KD007', location: 'Wuse Market Road, Abuja', lat: 9.0600, lng: 7.4800,
                dateTime: '2024-12-05T13:00', cause: 'Improper Lane Change', severity: 'Minor', status: 'Closed',
                media: [],
                description: 'Taxi brushed against private car during lane change. No significant damage, minor argument.',
                adminLog: 'Admin User: Report Acknowledged (2024-12-05 13:05)\nAdmin User: Parties settled, moved cars (2024-12-05 13:30)',
                vehiclesInvolved: 2, fatalities: 0, injuries: 0, responseTime: 10, internalNotes: 'No further action needed.'
            },
            {
                id: 'AC-KD008', location: 'Kubwa Expressway, Abuja', lat: 9.1000, lng: 7.3900,
                dateTime: '2023-01-25T17:45', cause: 'Over-speeding', severity: 'Critical', status: 'Closed',
                media: ['https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+4'],
                description: 'Fatal head-on collision on Kubwa Expressway. Caused by over-speeding. Road briefly closed.',
                adminLog: 'Admin User: Report Acknowledged (2023-01-25 17:50)\nAdmin User: Road reopened, scene cleared (2023-01-25 20:00)',
                vehiclesInvolved: 2, fatalities: 4, injuries: 1, responseTime: 30, internalNotes: 'High profile case. Ongoing police investigation.'
            },
            {
                id: 'AC-KD009', location: 'Airport Road, Abuja', lat: 9.0000, lng: 7.3500,
                dateTime: '2024-06-08T06:30', cause: 'Mechanical Failure', severity: 'Serious', status: 'Reported',
                media: [],
                description: 'Bus experienced tire burst on Airport Road, swerved and hit barrier. Minor injuries, bus disabled.',
                adminLog: 'Admin User: Report Acknowledged (2024-06-08 06:35)\nAdmin User: Recovery ongoing (2024-06-08 07:15)',
                vehiclesInvolved: 1, fatalities: 0, injuries: 5, responseTime: 25, internalNotes: 'FRSC to inspect bus after recovery.'
            },
            {
                id: 'AC-KD010', location: 'Gwarinpa Estate Main Gate, Abuja', lat: 9.0700, lng: 7.3800,
                dateTime: '2025-02-10T15:00', cause: 'Distracted Driving', severity: 'Minor', status: 'Closed',
                media: [],
                description: 'Two vehicles scraped each other at estate gate. Drivers exchanged details.',
                adminLog: 'Admin User: Report Acknowledged (2025-02-10 15:05)',
                vehiclesInvolved: 2, fatalities: 0, injuries: 0, responseTime: 5, internalNotes: 'Common occurrence, no follow up needed.'
            }
        ];

        /**
         * Initializes the OpenLayers map, layers, and event listeners.
         */
        function initMap() {
            // Initialize vector sources for accidents and drawing features
            accidentVectorSource = new ol.source.Vector();
            drawVectorSource = new ol.source.Vector();

            // Define OpenLayers base map layers
            // These layers are client-side. In a Django app, you would typically serve
            // your own tile layers or use a proxy for external tile services if needed
            // for security or performance reasons.
            osmLayer = new ol.layer.Tile({
                source: new ol.source.OSM(),
                visible: true,
                title: 'Standard Map'
            });

            satelliteLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    attributions: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    maxZoom: 19
                }),
                visible: false,
                title: 'Satellite'
            });

            openTopoMapLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    attributions: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
                    url: 'https://a.tile.opentopomap.org/{z}/{y}/{x}.png',
                    maxZoom: 17
                }),
                visible: false,
                title: 'Terrain Map'
            });

            // Layer for displaying road accidents with simplified markers
            // The `accidentVectorSource` will be populated with accident data fetched from Django.
            accidentVectorLayer = new ol.layer.Vector({
                source: accidentVectorSource,
                style: function(feature) {
                    const severity = feature.get('severity');
                    const status = feature.get('status');
                    const fillColor = getSeverityColor(severity); // Main body color for the icon

                    let statusBgColor;
                    let statusStrokeColor = '#1E293B'; // Stroke for the status indicator
                    let statusSymbolPath = ''; // SVG path for the status icon

                    // Determine status indicator color and icon based on status
                    switch (status) {
                        case 'Reported':
                            statusBgColor = '#FACC15'; // Yellow
                            statusStrokeColor = '#334155'; // Darker stroke for contrast
                            statusSymbolPath = '<circle cx="12" cy="12" r="2.5" fill="#334155"/>'; // Small dark dot for 'Reported'
                            break;
                        case 'Closed':
                            statusBgColor = '#22C55E'; // Green
                            statusSymbolPath = '<path d="M6 12L10 16L18 8" fill="none" stroke="white" stroke-width="2"/>'; // Checkmark
                            break;
                        case 'Active':
                            statusBgColor = '#3B82F6'; // Blue
                            statusSymbolPath = '<circle cx="12" cy="12" r="3" fill="white"/>'; // Simple white dot
                            break;
                    }

                    // Define the SVG content for the simplified marker
                    // It now consists of a main circle and a smaller status circle on its top-right
                    const svgContent = `<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <!-- Main circle (severity color) -->
                        <circle cx="12" cy="12" r="8" fill="${fillColor}" stroke="#1E293B" stroke-width="1.5"/>
                        <!-- Status indicator (smaller circle on top-right) -->
                        <circle cx="18" cy="6" r="5" fill="${statusBgColor}" stroke="${statusStrokeColor}" stroke-width="1"/>
                        <!-- Status icon inside the smaller circle (positioned relative to its own viewBox for easier scaling) -->
                        <svg x="13" y="1" width="10" height="10" viewBox="0 0 24 24">${statusSymbolPath}</svg>
                    </svg>`;

                    const svgDataUrl = 'data:image/svg+xml;utf8,' + encodeURIComponent(svgContent);

                    return new ol.style.Style({
                        image: new ol.style.Icon({
                            src: svgDataUrl,
                            scale: 1, // Keep scale uniform for simpler markers
                            anchor: [0.5, 0.5], // Anchor the icon at its center
                        }),
                    });
                }
            });

            // Layer for drawing interactions (points, lines, polygons) by the user
            // Drawn features could be sent to a Django backend for storage and spatial analysis.
            drawVectorLayer = new ol.layer.Vector({
                source: drawVectorSource,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 255, 255, 0.2)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#3B82F6', /* Blue for drawing interactions */
                        width: 3
                    }),
                    image: new ol.style.Circle({
                        radius: 7,
                        fill: new ol.style.Fill({
                            color: '#3B82F6'
                        })
                    })
                })
            });

            // Initialize the map with defined layers and a default view
            map = new ol.Map({
                target: 'map',
                layers: [
                    osmLayer,
                    satelliteLayer,
                    openTopoMapLayer,
                    accidentVectorLayer,
                    drawVectorLayer
                ],
                view: new ol.View({
                    center: ol.proj.fromLonLat([7.4939, 9.0437]), // Centered on Abuja City Gate, FCT
                    zoom: 8
                })
            });

            // Setup the popup overlay for displaying brief accident info on hover
            const popupElement = document.getElementById('popup');
            const popupCloser = document.getElementById('popup-closer');
            popupOverlay = new ol.Overlay({
                element: popupElement,
                autoPan: false, // Prevent map from panning to show the popup
                offset: [10, -40] // Offset the popup from the cursor/feature
            });
            map.addOverlay(popupOverlay);

            // Event listener to close the popup when the 'x' button is clicked
            popupCloser.onclick = function() {
                popupOverlay.setPosition(undefined); // Hide the popup
                popupCloser.blur(); // Remove focus from the button
                return false;
            };

            // Event listener for map click events to open the accident details panel
            map.on('click', function(event) {
                // Immediately stop propagation for map clicks to prevent document listener interference
                event.stopPropagation();

                let featureClicked = false;
                map.forEachFeatureAtPixel(event.pixel, function(feature, layer) {
                    if (layer === accidentVectorLayer) { // Only handle clicks on accident markers
                        const accidentData = feature.getProperties().accidentData;
                        openAccidentDetails(accidentData); // Open the details panel
                        selectedAccidentFeature = feature; // Store the feature for potential re-population on cancel
                        featureClicked = true; // Set flag that a feature was clicked
                        return true; // Stop iterating over features once one is found
                    }
                });
                // If no accident feature was clicked, close the details panel
                if (!featureClicked) {
                    closeAccidentDetails();
                    selectedAccidentFeature = null;
                }
            });

            // Event listener for pointer movement on the map to show/hide accident popups
            map.on('pointermove', function(event) {
                const pixel = map.getEventPixel(event.originalEvent);
                let hit = false;
                map.forEachFeatureAtPixel(pixel, function(feature, layer) {
                    if (layer === accidentVectorLayer) { // Only show popup for accident markers
                        const accidentData = feature.getProperties().accidentData;
                        const popupContent = document.getElementById('popup-content');
                        // Populate popup content with brief accident details
                        popupContent.innerHTML = `
                            <p><strong>ID:</strong> ${accidentData.id}</p>
                            <p><strong>Loc:</strong> ${accidentData.location}</p>
                            <p><strong>Sev:</strong> ${accidentData.severity}</p>
                            <p><strong>Status:</strong> ${accidentData.status}</p>
                            <p><strong>Time:</strong> ${new Date(accidentData.dateTime).toLocaleTimeString()}</p>
                        `;
                        popupOverlay.setPosition(feature.getGeometry().getCoordinates()); // Position popup at feature coordinates
                        document.getElementById('popup').style.display = 'block'; // Show popup
                        map.getTargetElement().style.cursor = 'pointer'; // Change cursor to pointer
                        hit = true;
                        return true;
                    }
                });
                if (!hit) {
                    document.getElementById('popup').style.display = 'none'; // Hide popup if no feature is hovered
                    map.getTargetElement().style.cursor = ''; // Reset cursor
                }
            });

            renderAccidentsOnMap(accidentIncidents); // Initial rendering of all accidents on map
        }

        /**
         * Renders accident features on the map based on the provided array.
         * Clears existing features before adding new ones.
         * @param {Array<Object>} accidentsToRender - An array of accident objects.
         */
        function renderAccidentsOnMap(accidentsToRender) {
            accidentVectorSource.clear(); // Clear existing features from the source

            accidentsToRender.forEach(accident => {
                // For Django integration, ensure your Django model for accidents has
                // 'lat' and 'lng' fields, or a GeoDjango PointField.
                // If using a GeoDjango PointField, you might receive coordinates as GeoJSON.
                const accidentFeature = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([accident.lng, accident.lat])),
                    accidentData: accident, // Store full accident data within the feature for easy access
                    severity: accident.severity,
                    status: accident.status
                });
                accidentVectorSource.addFeature(accidentFeature);
            });
        }

        /**
         * Returns a color string (RGBA) based on the severity level for map icons.
         * @param {string} severity - The severity level ('Critical', 'Serious', 'Minor').
         * @returns {string} RGBA color string.
         */
        function getSeverityColor(severity) {
            switch (severity) {
                case 'Critical': return 'rgba(239, 68, 68, 0.9)'; // Red with transparency
                case 'Serious': return 'rgba(249, 115, 22, 0.9)'; // Orange with transparency
                case 'Minor': return 'rgba(34, 197, 94, 0.9)'; // Green with transparency
                default: return 'rgba(148, 163, 184, 0.9)'; // Gray with transparency
            }
        }

        /**
         * Sets the editability of the accident details panel fields.
         * @param {boolean} isEditable - True to enable editing, false to disable.
         */
        function setAccidentDetailsEditable(isEditable) {
            const fields = [
                'detailCause', 'detailSeverity', 'detailStatus', 'detailVehicleInvolved',
                'detailFatalities', 'detailInjuries', 'detailResponseTime', 'detailDescription',
                'detailInternalNotes'
            ];
            fields.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.disabled = !isEditable; // Use disabled for inputs and selects
                    if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
                        element.readOnly = !isEditable; // Also use readOnly for text inputs/textareas for visual cue
                    }
                }
            });

            // Toggle button visibility
            document.getElementById('editAccidentBtn').classList.toggle('hidden', isEditable);
            document.getElementById('updateAccidentBtn').classList.toggle('hidden', !isEditable);
            document.getElementById('cancelEditBtn').classList.toggle('hidden', !isEditable);
        }


        /**
         * Opens the accident details panel and populates it with data for the given accident.
         * @param {Object} accident - The accident data object.
         */
        function openAccidentDetails(accident) {
            const panel = accidentDetailsPanelElement; // Use the globally assigned reference
            if (!panel) {
                console.error("Error: accidentDetailsPanel element not found!");
                return;
            }

            isPanelOpening = true; // Set flag to prevent global click listener from closing it immediately
            setTimeout(() => {
                isPanelOpening = false; // Reset flag after a short delay
            }, 100); // 100ms should be enough for the event loop to settle

            // Explicitly set display to block before removing 'hidden' and adding 'open'
            panel.style.display = 'block';
            panel.classList.remove('hidden'); // Make the panel visible
            panel.classList.add('open'); // Trigger the slide-in animation

            panel.dataset.currentAccidentId = accident.id; // Store the ID of the currently displayed accident for updates

            // Populate all the input/display fields in the details panel
            // Ensure that the IDs here match the field names in your Django model's serializer
            // (e.g., `accident.id` corresponds to a 'report_id' field in Django)
            document.getElementById('detailReportId').textContent = accident.id;
            document.getElementById('detailLocation').textContent = accident.location;
            document.getElementById('detailDateTime').textContent = accident.dateTime.replace('T', ' '); // Format date/time

            // Directly assign values to input fields, ensuring default for potential undefined
            document.getElementById('detailCause').value = accident.cause || '';
            document.getElementById('detailSeverity').value = accident.severity || '';
            document.getElementById('detailStatus').value = accident.status || '';
            document.getElementById('detailVehicleInvolved').value = accident.vehiclesInvolved !== undefined ? accident.vehiclesInvolved : 0;
            document.getElementById('detailFatalities').value = accident.fatalities !== undefined ? accident.fatalities : 0;
            document.getElementById('detailInjuries').value = accident.injuries !== undefined ? accident.injuries : 0;
            document.getElementById('detailResponseTime').value = accident.responseTime !== undefined ? accident.responseTime : 0;
            document.getElementById('detailDescription').value = accident.description || '';
            document.getElementById('detailInternalNotes').value = accident.internalNotes || '';

            document.getElementById('detailAdminLog').textContent = accident.adminLog || 'No admin log available.';

            // Populate media (images) for the accident
            // In Django, `accident.media` would likely be a list of URLs to images stored in Django's Media files.
            // Ensure your Django REST API serializes these image URLs.
            const mediaContainer = document.getElementById('detailMedia');
            mediaContainer.innerHTML = ''; // Clear previous media
            if (accident.media && accident.media.length > 0) {
                accident.media.forEach(mediaUrl => {
                    const img = document.createElement('img');
                    img.src = mediaUrl; // This URL should be served by Django's static/media files
                    img.alt = 'Accident Media';
                    img.className = 'rounded-lg w-full h-auto object-cover shadow-md';
                    mediaContainer.appendChild(img);
                });
            } else {
                mediaContainer.innerHTML = '<div class="w-full h-auto bg-slate-700 rounded-lg flex items-center justify-center text-slate-400 text-sm p-4 border border-slate-600">No media available</div>';
            }

            setAccidentDetailsEditable(false); // Set to read-only mode initially
        }

        /**
         * Closes the accident details panel by triggering its slide-out animation.
         */
        function closeAccidentDetails() {
            const panel = accidentDetailsPanelElement; // Use the globally assigned reference
            if (!panel) {
                console.error("Error: accidentDetailsPanel element not found for closing!");
                return;
            }
            panel.classList.remove('open'); // Start slide-out animation
            // Ensure the hidden class is added after the transition, and display is set to none
            setTimeout(() => {
                panel.classList.add('hidden'); // Hide completely after animation finishes
                panel.style.display = 'none'; // Explicitly set display to none
            }, 300); // Matches the CSS transition duration
        }

        /**
         * Updates an accident's details based on the current values in the details panel form.
         * Re-renders the map to reflect any changes and shows a success alert.
         */
        function updateAccidentDetails() {
            const panel = accidentDetailsPanelElement; // Use the globally assigned reference
            const currentAccidentId = panel.dataset.currentAccidentId;

            if (!currentAccidentId) {
                console.error("No accident selected for update.");
                return;
            }

            // Find the accident in the local data array
            const accidentIndex = accidentIncidents.findIndex(acc => acc.id === currentAccidentId);
            if (accidentIndex === -1) {
                console.error(`Accident with ID ${currentAccidentId} not found.`);
                return;
            }

            // Create a mutable copy of the accident object
            const updatedAccident = { ...accidentIncidents[accidentIndex] };

            // Update accident properties from the input fields
            // Map these JavaScript properties to your Django model fields.
            // For example, `detailCause` might map to `cause_of_accident` in Django.
            updatedAccident.cause = document.getElementById('detailCause').value;
            updatedAccident.severity = document.getElementById('detailSeverity').value;
            updatedAccident.status = document.getElementById('detailStatus').value;
            updatedAccident.vehiclesInvolved = parseInt(document.getElementById('detailVehicleInvolved').value) || 0;
            updatedAccident.fatalities = parseInt(document.getElementById('detailFatalities').value) || 0;
            updatedAccident.injuries = parseInt(document.getElementById('detailInjuries').value) || 0;
            updatedAccident.responseTime = parseInt(document.getElementById('detailResponseTime').value) || 0;
            updatedAccident.description = document.getElementById('detailDescription').value;
            updatedAccident.internalNotes = document.getElementById('detailInternalNotes').value;

            // In a Django application, you would send this updated data to your backend API.
            // This requires a Django REST Framework (DRF) setup with a ViewSet and Serializer.
            // The `currentAccidentId` would be part of the URL (e.g., `/api/accidents/AC-KD001/`).
            //
            // Example using Fetch API for a PUT/PATCH request:
            // fetch(`/api/accidents/${currentAccidentId}/`, { // Your Django API endpoint for updating a specific accident
            //     method: 'PUT', // Use 'PUT' for full replacement, 'PATCH' for partial updates
            //     headers: {
            //         'Content-Type': 'application/json',
            //         'X-CSRFToken': getCookie('csrftoken') // IMPORTANT: Include CSRF token for Django POST/PUT/PATCH/DELETE requests
            //     },
            //     body: JSON.stringify(updatedAccident) // Send the updated accident data as JSON
            // })
            // .then(response => {
            //     if (!response.ok) {
            //         // Handle HTTP errors (e.g., 400 Bad Request, 404 Not Found, 500 Server Error)
            //         return response.json().then(errData => { throw new Error(errData.detail || 'Network response was not ok'); });
            //     }
            //     return response.json(); // Parse the JSON response from Django
            // })
            // .then(data => {
            //     // On successful update, replace the local data with the response from the server.
            //     // Django's serializer might return the full updated object, including server-side timestamps etc.
            //     accidentIncidents[accidentIndex] = data;
            //     renderAccidentsOnMap(accidentIncidents); // Re-render markers on map with potentially updated styles
            //     setAccidentDetailsEditable(false); // Revert to read-only mode after update
            //     showCustomAlert(`Accident ${currentAccidentId} details have been successfully updated.`, 'Accident Updated!');
            // })
            // .catch(error => {
            //     console.error('Error updating accident:', error);
            //     showCustomAlert(`Failed to update accident details: ${error.message}. Please try again.`, 'Update Failed');
            // });

            // For this frontend-only demo, we directly update the local array:
            accidentIncidents[accidentIndex] = updatedAccident;

            renderAccidentsOnMap(accidentIncidents); // Re-render markers on map with potentially updated styles
            setAccidentDetailsEditable(false); // Revert to read-only mode after update
            showCustomAlert(`Accident ${currentAccidentId} details have been successfully updated.`, 'Accident Updated!'); // Show a user-friendly confirmation
        }

        /**
         * Applies filters and search criteria from the map filters panel
         * to the accidents displayed on the OpenLayers map.
         * This function is now called on every input/change event for real-time filtering.
         */
        function applyFiltersAndSearch() {
            const statusFilter = document.getElementById('statusFilter').value;
            const severityFilter = document.getElementById('severityFilter').value;
            const timeRangeFilter = document.getElementById('timeRangeFilter').value;
            const searchTerm = document.getElementById('searchBar').value.toLowerCase();

            // Filter the main accidentIncidents array based on selected criteria
            const filteredAccidents = accidentIncidents.filter(accident => {
                const matchesStatus = statusFilter === 'all' || accident.status === statusFilter;
                const matchesSeverity = severityFilter === 'all' || accident.severity === severityFilter;

                const accidentTime = new Date(accident.dateTime).getTime();
                const now = Date.now();
                let matchesTimeRange = true; // Assume true unless a time filter is applied
                if (timeRangeFilter === 'last_hour') {
                    matchesTimeRange = accidentTime > (now - 3600 * 1000); // Last 1 hour
                } else if (timeRangeFilter === 'last_24_hours') {
                    matchesTimeRange = accidentTime > (now - 24 * 3600 * 1000); // Last 24 hours
                } else if (timeRangeFilter === 'last_7_days') {
                    matchesTimeRange = accidentTime > (now - 7 * 24 * 3600 * 1000); // Last 7 days
                }

                const matchesSearch = searchTerm === '' || // If search term is empty, always match
                                      accident.location.toLowerCase().includes(searchTerm) ||
                                      accident.id.toLowerCase().includes(searchTerm) ||
                                      accident.cause.toLowerCase().includes(searchTerm) || // Search by cause
                                      accident.description.toLowerCase().includes(searchTerm); // Search by description

                return matchesStatus && matchesSeverity && matchesTimeRange && matchesSearch;
            });

            renderAccidentsOnMap(filteredAccidents); // Update the map with the filtered accidents
            // In a Django application, this filtering would likely happen on the backend.
            // You would send these filter parameters to your Django API endpoint (e.g., `/api/accidents/?status=Active&severity=Critical&time_range=last_24_hours&search=keyword`)
            // and the API would return the filtered data, which you then render.
            // Django REST Framework's `django-filter` library is excellent for this.
        }

        /**
         * Adds a drawing interaction (Point, LineString, Polygon) to the map.
         * Removes any existing drawing interaction before adding a new one.
         * @param {string} drawType - The type of geometry to draw ('Point', 'LineString', 'Polygon').
         */
        function addInteraction(drawType) {
            if (drawInteraction) {
                map.removeInteraction(drawInteraction); // Remove currently active drawing interaction
            }
            if (drawType !== 'None') { // 'None' means no drawing, just clear interaction
                drawInteraction = new ol.interaction.Draw({
                    source: drawVectorSource, // Source for the drawn features
                    type: drawType, // Type of geometry to draw
                    style: new ol.style.Style({ // Styling for the temporary drawn features
                        fill: new ol.style.Fill({
                            color: 'rgba(255, 255, 255, 0.2)'
                        }),
                        stroke: new ol.style.Stroke({
                            color: '#3B82F6', /* Blue for drawing interactions */
                            width: 3
                        }),
                        image: new ol.style.Circle({
                            radius: 7,
                            fill: new ol.style.Fill({
                                color: '#3B82F6'
                            })
                        })
                    })
                });
                map.addInteraction(drawInteraction); // Add the new drawing interaction to the map
                // In a Django application, if you wanted to save these drawn features,
                // you would listen for the 'drawend' event on the drawInteraction,
                // extract the geometry, convert it to GeoJSON or WKT, and send it to your Django backend.
                // Django's GeoDjango can handle spatial data types like Point, LineString, Polygon.
                //
                // drawInteraction.on('drawend', function(event) {
                //     const feature = event.feature;
                //     const geometry = feature.getGeometry();
                //     // Convert OpenLayers geometry to GeoJSON format
                //     const geoJsonFormat = new ol.format.GeoJSON();
                //     const geoJson = geoJsonFormat.writeFeatureObject(feature);
                //     console.log('Drawn GeoJSON:', geoJson);
                //     // Send geoJson to Django backend:
                //     // fetch('/api/drawn_features/', { // Your Django API endpoint for saving drawn features
                //     //     method: 'POST',
                //     //     headers: {
                //     //         'Content-Type': 'application/json',
                //     //         'X-CSRFToken': getCookie('csrftoken') // IMPORTANT for Django POST requests
                //     //     },
                //     //     body: JSON.stringify(geoJson) // Send the GeoJSON object
                //     // })
                //     // .then(response => response.json())
                //     // .then(data => console.log('Feature saved to Django:', data))
                //     // .catch(error => console.error('Error saving drawn feature:', error));
                // });
            }
        }

        /**
         * Sets the active visual state for drawing buttons in the control panel.
         * @param {HTMLElement|null} button - The button element that is now active, or null to deactivate all.
         */
        function setActiveDrawButton(button) {
            // Remove 'active' class from all drawing buttons
            document.querySelectorAll('#drawingControls button').forEach(btn => btn.classList.remove('active'));
            if (button) {
                button.classList.add('active'); // Add 'active' class to the clicked button
            }
            activeDrawButton = button; // Keep track of the currently active button
        }

        /**
         * Switches the visible base map layer (e.g., OSM, Satellite, Terrain).
         * Ensures only one base layer is visible at a time and updates button active states.
         * @param {string} layerName - The title of the layer to make visible ('Standard Map', 'Satellite', 'Terrain Map').
         */
        function switchLayer(layerName) {
            // Set visibility for each base layer
            osmLayer.setVisible(layerName === 'Standard Map');
            satelliteLayer.setVisible(layerName === 'Satellite');
            openTopoMapLayer.setVisible(layerName === 'Terrain Map');

            // Update the 'active' class on layer switcher buttons
            document.getElementById('osmLayerBtn').classList.toggle('active', layerName === 'Standard Map');
            document.getElementById('satelliteLayerBtn').classList.toggle('active', layerName === 'Satellite');
            document.getElementById('terrainLayerBtn').classList.toggle('active', layerName === 'Terrain Map');
        }

        /* --- Reusable JS Functions for UI (closeAllPopups, showCustomAlert) START --- */
        /**
         * Closes all open popups, dropdowns, and modals except for a specified one.
         * This function promotes reusability by centralizing closing logic for various UI elements.
         * @param {string|null} exceptId - The ID of the HTML element to keep open, or null to close all.
         */
        function closeAllPopups(exceptId = null) {
            // List of all known popup/modal/dropdown IDs
            const popups = [
                { id: 'mapFiltersPanel', element: mapFiltersPanelElement },
                { id: 'accidentDetailsPanel', element: accidentDetailsPanelElement },
                { id: 'allAccidentsModal', element: allAccidentsModalElement },
                { id: 'notificationPreferencesModal', element: notificationPreferencesModalElement },
                { id: 'singleAccidentDetailsModal', element: singleAccidentDetailsModalElement } // New modal
            ];
            
            popups.forEach(item => {
                const element = item.element;
                if (element && item.id !== exceptId) {
                    if (element.classList.contains('open')) { // Handles animated panels like accidentDetailsPanel or mapFiltersPanel
                        element.classList.remove('open');
                        setTimeout(() => element.classList.add('hidden'), 300); // Hide after animation
                    } else if (!element.classList.contains('hidden')) { // Handles standard hidden/shown elements
                        element.classList.add('hidden');
                    }
                    // Also ensure display is set to none for elements that are truly hidden
                    if (element.classList.contains('hidden')) {
                        element.style.display = 'none';
                    }
                }
            });
            // Ensure the OpenLayers map popup is also hidden if it's visible
            if (popupOverlay) {
                popupOverlay.setPosition(undefined); // Hides the OpenLayers popup
                document.getElementById('popup').style.display = 'none'; // Ensure its display is also set to none
            }
        }

        /**
         * Displays a custom alert message as a modal overlay.
         * This replaces browser's native `alert()` for better UI consistency and control.
         * @param {string} message - The main message content to display.
         * @param {string} title - The title for the alert modal.
         */
        function showCustomAlert(message, title = 'Alert') {
            const customAlert = document.createElement('div');
            customAlert.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999]';
            customAlert.innerHTML = `
                <div class="bg-slate-800 p-6 rounded-lg shadow-lg text-white">
                    <h3 class="text-xl font-semibold mb-3">${title}</h3>
                    <p>${message}</p>
                    <button class="mt-4 px-4 py-2 bg-blue-600 rounded-md hover:bg-blue-700" onclick="this.closest('.fixed').remove()">OK</button>
                </div>
            `;
            document.body.appendChild(customAlert);
        }
        /* --- Reusable JS Functions for UI (closeAllPopups, showCustomAlert) END --- */

        /**
         * Filters and populates the "All Road Accidents" modal table based on multiple criteria:
         * Status, Severity, Time Range, Year, Month, Day, and a general Search term.
         * This is a core function demonstrating advanced filtering logic.
         */
        function applyFiltersToAllAccidentsModal() {
            // Get current filter values from the modal's dropdowns and search bar
            const modalStatusFilter = document.getElementById('modalStatusFilter').value;
            const modalSeverityFilter = document.getElementById('modalSeverityFilter').value;
            const modalTimeRangeFilter = document.getElementById('modalTimeRangeFilter').value;
            const modalYearFilter = document.getElementById('modalYearFilter').value;
            const modalMonthFilter = document.getElementById('modalMonthFilter').value;
            const modalDayFilter = document.getElementById('modalDayFilter').value;
            const modalSearchBar = document.getElementById('modalSearchBar').value.toLowerCase();

            // Filter the main accidentIncidents array
            const filteredAccidents = accidentIncidents.filter(accident => {
                // Check if accident matches selected status filter
                const matchesStatus = modalStatusFilter === 'all' || accident.status === modalStatusFilter;
                // Check if accident matches selected severity filter
                const matchesSeverity = modalSeverityFilter === 'all' || accident.severity === modalSeverityFilter;

                const accidentDate = new Date(accident.dateTime);
                const now = Date.now();
                let matchesTimeRange = true; // Assume time range matches by default
                let matchesSpecificDate = true; // Assume specific date matches by default

                // Determine if any specific date (year, month, day) filters are active
                const isYearFiltered = modalYearFilter !== 'all';
                const isMonthFiltered = modalMonthFilter !== 'all';
                const isDayFiltered = modalDayFilter !== 'all';

                // If any specific date filter is set, prioritize it over the generic time range filter
                if (isYearFiltered || isMonthFiltered || isDayFiltered) {
                    const accidentYear = accidentDate.getFullYear().toString();
                    const accidentMonth = (accidentDate.getMonth() + 1).toString(); // getMonth() is 0-indexed (0-11)
                    const accidentDay = accidentDate.getDate().toString();

                    // Check if accident date matches the selected year, month, and/or day
                    matchesSpecificDate = (isYearFiltered ? accidentYear === modalYearFilter : true) &&
                                          (isMonthFiltered ? accidentMonth === modalMonthFilter : true) &&
                                          (isDayFiltered ? accidentDay === modalDayFilter : true);
                    
                    matchesTimeRange = true; // Override time range filter if specific date is used

                } else {
                    // If no specific date filters are active, apply the general time range filter
                    if (modalTimeRangeFilter === 'last_hour') {
                        matchesTimeRange = accidentDate.getTime() > (now - 3600 * 1000); // Accidents within the last hour
                    } else if (modalTimeRangeFilter === 'last_24_hours') {
                        matchesTimeRange = accidentDate.getTime() > (now - 24 * 3600 * 1000); // Accidents within the last 24 hours
                    } else if (modalTimeRangeFilter === 'last_7_days') {
                        matchesTimeRange = accidentDate.getTime() > (now - 7 * 24 * 3600 * 1000); // Accidents within the last 7 days
                    }
                }

                // Check if accident matches the search term in location, ID, description, or cause
                const matchesSearch = modalSearchBar === '' ||
                                      accident.location.toLowerCase().includes(modalSearchBar) ||
                                      accident.id.toLowerCase().includes(modalSearchBar) ||
                                      accident.cause.toLowerCase().includes(modalSearchBar) || // Search by cause
                                      accident.description.toLowerCase().includes(modalSearchBar); // Search by description

                // Return true only if all selected filters and search criteria are met
                return matchesStatus && matchesSeverity && matchesTimeRange && matchesSpecificDate && matchesSearch;
            });

            const modalBody = document.getElementById('allAccidentsTableBody');
            modalBody.innerHTML = ''; // Clear existing table rows

            // Populate the table with filtered accidents
            if (filteredAccidents.length === 0) {
                modalBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-slate-400">No accidents found matching your criteria.</td></tr>';
            } else {
                filteredAccidents.forEach(accident => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${accident.id}</td>
                        <td>${accident.location}</td>
                        <td><span class="severity-text severity-${accident.severity.toLowerCase()}">${accident.severity}</span></td>
                        <td><span class="status-badge status-${accident.status.toLowerCase()}">${accident.status}</span></td>
                        <td>${new Date(accident.dateTime).toLocaleString()}</td>
                        <td>
                            <button class="btn-primary-small" onclick="openSingleAccidentDetailsModal('${accident.id}')">View Details</button>
                        </td>
                    `;
                    modalBody.appendChild(row);
                });
            }
            document.getElementById('totalAccidentsCount').textContent = filteredAccidents.length; // Update accident count display
            // In a Django application, this filtering would typically be done on the backend.
            // You would send the filter parameters (modalStatusFilter, modalSeverityFilter, etc.)
            // to a Django API endpoint (e.g., `/api/accidents/filtered/?status=Active&severity=Critical&year=2025&search=collision`)
            // and the API would return the filtered data. Django REST Framework's `django-filter`
            // can be used to easily create filterable API endpoints.
        }

        /**
         * Populates the Year, Month, and Day dropdown filters in the "All Accidents" modal.
         * Years are dynamically extracted from the `accidentIncidents` data.
         */
        function populateDateFilters() {
            const yearFilter = document.getElementById('modalYearFilter');
            const monthFilter = document.getElementById('modalMonthFilter');
            const dayFilter = document.getElementById('modalDayFilter');

            // Clear existing options, then add the default "All" option
            yearFilter.innerHTML = '<option value="all">All</option>';
            monthFilter.innerHTML = '<option value="all">All</option>';
            dayFilter.innerHTML = '<option value="all">All</option>';

            // Populate Years dynamically based on accident data
            // In a Django app, you might fetch unique years from your database
            // via a dedicated API endpoint (e.g., `/api/accidents/years/`).
            const years = new Set(); // Use a Set to store unique years
            accidentIncidents.forEach(accident => {
                years.add(new Date(accident.dateTime).getFullYear());
            });
            // Convert Set to Array, sort in descending order, and add to dropdown
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                yearFilter.appendChild(option);
            });

            // Populate Months (static list, as there are always 12 months)
            // In Django, you could provide these as choices in a form field or serializer.
            const months = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = (index + 1).toString(); // Month values are 1-12
                option.textContent = month;
                monthFilter.appendChild(option);
            });

            // Populate Days (static list, assuming max 31 days)
            // Similarly, these could be choices provided by Django.
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i.toString();
                option.textContent = i.toString();
                dayFilter.appendChild(option);
            }
        }

        /**
         * Opens the "All Road Accidents" modal, resets its filters to default,
         * populates the date filters, and then applies filters to display all accidents initially.
         */
        function openAllAccidentsModal() {
            // Reset all modal filters to their default 'all' state
            document.getElementById('modalStatusFilter').value = 'all';
            document.getElementById('modalSeverityFilter').value = 'all';
            document.getElementById('modalTimeRangeFilter').value = 'all';
            document.getElementById('modalYearFilter').value = 'all';
            document.getElementById('modalMonthFilter').value = 'all';
            document.getElementById('modalDayFilter').value = 'all';
            document.getElementById('modalSearchBar').value = '';

            populateDateFilters(); // Ensure date filters are dynamically populated based on current data
            applyFiltersToAllAccidentsModal(); // Apply filters (which will show all accidents initially due to 'all' selections)
            allAccidentsModalElement.classList.remove('hidden'); // Show the modal
            allAccidentsModalElement.style.display = 'flex'; // Ensure display is flex for centering

            isPanelOpening = true; // Set flag to prevent global click listener from closing it immediately
            setTimeout(() => {
                isPanelOpening = false; // Reset flag after a short delay
            }, 100);
        }

        /**
         * Opens a smaller modal for displaying details of a single accident.
         * This modal appears on top of the 'All Accidents' modal.
         * @param {string} accidentId - The ID of the accident to display.
         */
        window.openSingleAccidentDetailsModal = function(accidentId) { // Make global for onclick
            const accident = accidentIncidents.find(acc => acc.id === accidentId);
            if (!accident) {
                console.error("Accident not found for single details modal:", accidentId);
                return;
            }

            // Populate the new single details modal with accident data.
            // Ensure these fields map correctly to your Django model's attributes.
            document.getElementById('singleDetailReportId').textContent = `Accident: ${accident.id}`;
            document.getElementById('singleDetailLocation').textContent = accident.location;
            document.getElementById('singleDetailDateTime').textContent = new Date(accident.dateTime).toLocaleString();
            document.getElementById('singleDetailCause').textContent = accident.cause || 'N/A';
            document.getElementById('singleDetailSeverity').textContent = accident.severity || 'N/A';
            document.getElementById('singleDetailStatus').textContent = accident.status || 'N/A';
            document.getElementById('singleDetailVehicleInvolved').textContent = accident.vehiclesInvolved !== undefined ? accident.vehiclesInvolved : 'N/A';
            document.getElementById('singleDetailFatalities').textContent = accident.fatalities !== undefined ? accident.fatalities : 'N/A';
            document.getElementById('singleDetailInjuries').textContent = accident.injuries !== undefined ? accident.injuries : 'N/A';
            document.getElementById('singleDetailResponseTime').textContent = accident.responseTime !== undefined ? accident.responseTime : 'N/A';
            document.getElementById('singleDetailDescription').textContent = accident.description || 'No description provided.';
            document.getElementById('singleDetailAdminLog').textContent = accident.adminLog || 'No admin log available.';
            document.getElementById('singleDetailInternalNotes').textContent = accident.internalNotes || 'No internal notes.';

            // Populate media (images) for the accident.
            // `accident.media` should contain URLs to images served by Django.
            const mediaContainer = document.getElementById('singleDetailMedia');
            mediaContainer.innerHTML = ''; // Clear previous media
            if (accident.media && accident.media.length > 0) {
                accident.media.forEach(mediaUrl => {
                    const img = document.createElement('img');
                    img.src = mediaUrl; // This URL should be served by Django's static/media files
                    img.alt = 'Accident Media';
                    img.className = 'rounded-lg w-full h-auto object-cover shadow-md';
                    mediaContainer.appendChild(img);
                });
            } else {
                mediaContainer.innerHTML = '<div class="no-media">No media available</div>';
            }

            // Store accident ID on the "View on Map" button for easy access
            document.getElementById('singleDetailViewOnMapBtn').dataset.accidentId = accident.id;

            // Show the modal
            singleAccidentDetailsModalElement.classList.remove('hidden');
            singleAccidentDetailsModalElement.style.display = 'flex';

            isPanelOpening = true; // Set flag for global click listener
            setTimeout(() => { isPanelOpening = false; }, 100);
        };

        /**
         * Views a specific accident on the main map.
         * Closes any open modals/popups, zooms the map to the accident's location,
         * and then opens the accident details panel for that accident.
         * @param {string} accidentId - The ID of the accident to view.
         */
        window.viewAccidentOnMap = function(accidentId) { // Make global for onclick in HTML
            closeAllPopups(); // Close any currently open popups or modals
            const accident = accidentIncidents.find(acc => acc.id === accidentId); // Find the accident object
            if (accident) {
                // The `accident.lng` and `accident.lat` should correspond to the longitude and latitude
                // fields in your Django accident model. If using GeoDjango's PointField, you might
                // need to extract these from the GeoJSON representation.
                const coords = ol.proj.fromLonLat([accident.lng, accident.lat]); // Convert lat/lng to map coordinates
                map.getView().animate({ // Animate the map view to the accident's location
                    center: coords,
                    zoom: 12, // Zoom in closer for better detail
                    duration: 500 // Animation duration in milliseconds
                });
                openAccidentDetails(accident); // Open the details panel for the selected accident
            }
        };

        /**
         * Helper function to get CSRF token for Django AJAX requests.
         * This function should be included if you are making POST/PUT/PATCH/DELETE requests
         * to a Django backend. Django's CSRF protection requires this token for security.
         * You would typically include it in your base template or a JavaScript file loaded
         * before your main script.
         *
         * To use this in Django, ensure your view renders the CSRF token in a meta tag:
         * <meta name="csrf-token" content="{{ csrf_token }}">
         * Or in a hidden input field within a form.
         */
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        // --- Event Listeners and Initial Setup on Document Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get references to all necessary DOM elements for event handling
            // These global references are crucial for efficient access to elements
            // throughout the JavaScript code, avoiding repeated `document.getElementById` calls.
            accidentDetailsPanelElement = document.getElementById('accidentDetailsPanel');
            mapFiltersPanelElement = document.getElementById('mapFiltersPanel');
            allAccidentsModalElement = document.getElementById('allAccidentsModal');
            notificationPreferencesModalElement = document.getElementById('notificationPreferencesModal');
            singleAccidentDetailsModalElement = document.getElementById('singleAccidentDetailsModal');

            const updateAccidentBtn = document.getElementById('updateAccidentBtn');
            const editAccidentBtn = document.getElementById('editAccidentBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const viewAllAccidentsBtn = document.getElementById('viewAllAccidentsBtn');

            const openFiltersPanelBtn = document.getElementById('openFiltersPanelBtn');
            const closeFiltersPanel = document.getElementById('closeFiltersPanel');

            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const locateMeBtn = document.getElementById('locateMeBtn');
            const fullscreenBtn = document.getElementById('fullscreenBtn');

            const drawPointBtn = document.getElementById('drawPointBtn');
            const drawLineBtn = document.getElementById('drawLineBtn');
            const drawPolygonBtn = document.getElementById('drawPolygonBtn');
            const clearDrawingsBtn = document.getElementById('clearDrawingsBtn');

            const osmLayerBtn = document.getElementById('osmLayerBtn');
            const satelliteLayerBtn = document.getElementById('satelliteLayerBtn');
            const terrainLayerBtn = document.getElementById('terrainLayerBtn');

            // Elements for modal filters (within #allAccidentsModal)
            const modalStatusFilter = document.getElementById('modalStatusFilter');
            const modalSeverityFilter = document.getElementById('modalSeverityFilter');
            const modalTimeRangeFilter = document.getElementById('modalTimeRangeFilter');
            const modalYearFilter = document.getElementById('modalYearFilter');
            const modalMonthFilter = document.getElementById('modalMonthFilter');
            const modalDayFilter = document.getElementById('modalDayFilter');
            const modalSearchBar = document.getElementById('modalSearchBar');
            const applyModalFiltersBtn = document.getElementById('applyModalFiltersBtn');

            // New: Button inside single accident details modal
            const singleDetailViewOnMapBtn = document.getElementById('singleDetailViewOnMapBtn');


            // Event listener for opening the new Map Filters Panel
            openFiltersPanelBtn.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevents the global click listener from immediately closing the panel
                closeAllPopups('mapFiltersPanel'); // Close all other popups, but keep mapFiltersPanel open
                mapFiltersPanelElement.classList.remove('hidden'); // Make the panel visible
                setTimeout(() => mapFiltersPanelElement.classList.add('open'), 10); // Trigger slide-in with a slight delay
                isPanelOpening = true; // Set flag to prevent global click listener from closing it immediately
                setTimeout(() => {
                    isPanelOpening = false; // Reset flag after a short delay
                }, 100);
            });

            // Event listener for closing the new Map Filters Panel
            closeFiltersPanel.addEventListener('click', () => {
                closeAllPopups(); // Use the general close function to close this panel
            });

            // Event listener for the new "View All Accidents" button
            viewAllAccidentsBtn.addEventListener('click', (event) => {
                event.stopPropagation(); // Stop propagation to prevent global click from closing the modal
                openAllAccidentsModal(); // Call the function to open the modal
            });

            // Global click listener to close popups/dropdowns when clicking anywhere outside them.
            // This is a common pattern for "click outside to close" functionality.
            document.addEventListener('click', (event) => {
                if (isPanelOpening) {
                    return; // Ignore clicks while a panel is in the process of opening to prevent immediate re-closing
                }

                // Check if the click was inside any of the interactive components using the global references.
                // This ensures that clicks *within* an open panel/modal or on a button that *opens* one
                // do not trigger the closeAllPopups function.
                const clickedInsideFilterPanel = mapFiltersPanelElement && mapFiltersPanelElement.contains(event.target);
                const clickedInsideDetailsPanel = accidentDetailsPanelElement && accidentDetailsPanelElement.contains(event.target);
                const clickedInsideAllAccidentsModal = allAccidentsModalElement && allAccidentsModalElement.contains(event.target);
                const clickedInsideNotificationPreferencesModal = notificationPreferencesModalElement && notificationPreferencesModalElement.contains(event.target);
                const clickedInsideSingleAccidentDetailsModal = singleAccidentDetailsModalElement && singleAccidentDetailsModalElement.contains(event.target);
                const clickedInsideOpenFiltersBtn = openFiltersPanelBtn.contains(event.target);
                const clickedInsideViewAllAccidentsBtn = viewAllAccidentsBtn.contains(event.target);

                const shouldClose = !clickedInsideFilterPanel &&
                                   !clickedInsideDetailsPanel &&
                                   !clickedInsideAllAccidentsModal &&
                                   !clickedInsideNotificationPreferencesModal &&
                                   !clickedInsideSingleAccidentDetailsModal &&
                                   !clickedInsideOpenFiltersBtn &&
                                   !clickedInsideViewAllAccidentsBtn;

                if (shouldClose) {
                    closeAllPopups();
                }
            });

            // Event listener to close the accident details panel using its dedicated close button
            document.getElementById('closeDetailsPanel').addEventListener('click', closeAccidentDetails);

            // Event listeners for applying filters to the main map (now real-time).
            // These would trigger AJAX requests to a Django API endpoint to fetch filtered data.
            document.getElementById('statusFilter').addEventListener('change', applyFiltersAndSearch);
            document.getElementById('severityFilter').addEventListener('change', applyFiltersAndSearch);
            document.getElementById('timeRangeFilter').addEventListener('change', applyFiltersAndSearch);
            document.getElementById('searchBar').addEventListener('input', applyFiltersAndSearch); // Use 'input' for real-time search

            // Event listener for the "Edit Accident" button
            editAccidentBtn.addEventListener('click', () => {
                setAccidentDetailsEditable(true); // Enable editing fields in the details panel
            });

            // Event listener for the "Update Accident" button in the details panel.
            // This would trigger a PUT/PATCH request to your Django API.
            updateAccidentBtn.addEventListener('click', updateAccidentDetails);

            // Event listener for the "Cancel" button in the details panel.
            // This reverts the form fields to the original accident data.
            cancelEditBtn.addEventListener('click', () => {
                if (selectedAccidentFeature) {
                    // Re-populate with original data from the stored feature
                    openAccidentDetails(selectedAccidentFeature.getProperties().accidentData);
                }
                setAccidentDetailsEditable(false); // Disable editing fields
            });

            initMap(); // Initialize the OpenLayers map when the DOM is ready

            // Event listeners for map drawing controls.
            // The `drawend` event listener within `addInteraction` is where you'd send
            // the drawn geometry data to your Django backend (e.g., a GeoDjango model).
            drawPointBtn.addEventListener('click', () => {
                addInteraction('Point');
                setActiveDrawButton(drawPointBtn);
            });
            drawLineBtn.addEventListener('click', () => {
                addInteraction('LineString');
                setActiveDrawButton(drawLineBtn);
            });
            drawPolygonBtn.addEventListener('click', () => {
                addInteraction('Polygon');
                setActiveDrawButton(drawPolygonBtn);
            });
            clearDrawingsBtn.addEventListener('click', () => {
                drawVectorSource.clear(); // Clear all features drawn on the map
                if (drawInteraction) {
                    map.removeInteraction(drawInteraction); // Remove the active drawing interaction
                }
                setActiveDrawButton(null); // Deactivate all drawing buttons
            });

            // Event listeners for map base layer switching buttons.
            // These simply control client-side map tile visibility.
            osmLayerBtn.addEventListener('click', () => switchLayer('Standard Map'));
            satelliteLayerBtn.addEventListener('click', () => switchLayer('Satellite'));
            terrainLayerBtn.addEventListener('click', () => switchLayer('Terrain Map'));

            // Event listeners for map navigation controls (zoom, locate, fullscreen).
            // Geolocation data could potentially be sent to Django for user location tracking
            // or for creating new accident reports at the current location.
            zoomInBtn.addEventListener('click', () => {
                const view = map.getView();
                const zoom = view.getZoom();
                view.animate({ zoom: zoom + 1, duration: 250 }); // Zoom in with animation
            });

            zoomOutBtn.addEventListener('click', () => {
                const view = map.getView();
                const zoom = view.getZoom();
                view.animate({ zoom: zoom - 1, duration: 250 }); // Zoom out with animation
            });

            locateMeBtn.addEventListener('click', () => {
                if (navigator.geolocation) { // Check if geolocation is supported by the browser
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const coords = [position.coords.longitude, position.coords.latitude];
                        const view = map.getView();
                        view.animate({
                            center: ol.proj.fromLonLat(coords), // Center map on user's current location
                            zoom: 14, // Zoom level for the location
                            duration: 500
                        });
                        // You could send this location to Django if you want to store user's last known location
                        // or initiate a new report from their current position.
                        // fetch('/api/user_location/', {
                        //     method: 'POST',
                        //     headers: {
                        //         'Content-Type': 'application/json',
                        //         'X-CSRFToken': getCookie('csrftoken')
                        //     },
                        //     body: JSON.stringify({ lat: position.coords.latitude, lng: position.coords.longitude })
                        // });
                    }, function(error) {
                        console.error('Geolocation error:', error);
                        // Show a user-friendly error if geolocation fails
                        showCustomAlert('Unable to retrieve your location. Please ensure location services are enabled and permissions are granted.', 'Geolocation Error');
                    });
                } else {
                    // Show a message if geolocation is not supported
                    showCustomAlert('Your browser does not support Geolocation.', 'Geolocation Not Supported');
                }
            });

            fullscreenBtn.addEventListener('click', () => {
                const mapElement = document.getElementById('map');
                if (document.fullscreenElement) { // Check if already in fullscreen mode
                    document.exitFullscreen(); // Exit fullscreen
                } else {
                    mapElement.requestFullscreen().catch(err => { // Request fullscreen mode for the map element
                        console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                        // Show an error if fullscreen request fails
                        showCustomAlert(`Failed to enter fullscreen mode: ${err.message}`, 'Fullscreen Error');
                    });
                }
            });

            // Event listeners for filters within the "All Accidents" modal.
            // These trigger `applyFiltersToAllAccidentsModal` which would then
            // fetch filtered data from a Django API endpoint.
            modalStatusFilter.addEventListener('change', applyFiltersToAllAccidentsModal);
            modalSeverityFilter.addEventListener('change', applyFiltersToAllAccidentsModal);
            modalTimeRangeFilter.addEventListener('change', applyFiltersToAllAccidentsModal);
            modalYearFilter.addEventListener('change', applyFiltersToAllAccidentsModal);
            modalMonthFilter.addEventListener('change', applyFiltersToAllAccidentsModal);
            modalDayFilter.addEventListener('change', applyFiltersToAllAccidentsModal);
            modalSearchBar.addEventListener('input', applyFiltersToAllAccidentsModal);
            applyModalFiltersBtn.addEventListener('click', applyFiltersToAllAccidentsModal);
            
            // New: Event listener for "View on Map" button inside the single accident details modal.
            // This button uses `viewAccidentOnMap` to close the modal and center the map on the accident.
            singleDetailViewOnMapBtn.addEventListener('click', (event) => {
                const accidentId = event.target.dataset.accidentId;
                if (accidentId) {
                    viewAccidentOnMap(accidentId); // Call the global function to view on map
                }
            });
        });
    </script>
</body>
</html>

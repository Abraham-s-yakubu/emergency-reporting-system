<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accident Report Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons (e.g., for notification bell) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-bold text-blue-400 mb-6 text-center">Accident Report Management Dashboard</h1>

        <!-- Action Buttons: Add New Report and View All Incidents -->
        <div class="flex justify-end mb-6 space-x-4">
            <button id="addNewReportButton" class="px-6 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 shadow-lg flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                Add New Accident Report
            </button>
            <button id="viewAllIncidentsBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-lg flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-checks"><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/><path d="M11 12h9"/><path d="M11 18h9"/><path d="M11 6h9"/></svg>
                View All Incidents
            </button>
        </div>

        <!-- Statistics Cards Section -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
            <div class="bg-blue-950 rounded-lg p-6 shadow-md flex flex-col items-start">
                <p class="text-sm font-medium text-blue-200">Total Accident Reports</p>
                <p class="text-4xl font-bold text-white mt-2" id="totalAccidentReports">0</p>
                <div class="flex items-center text-blue-300 text-sm mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                    <span>+9% from last month</span>
                </div>
            </div>

            <div class="bg-blue-950 rounded-lg p-6 shadow-md flex flex-col items-start">
                <p class="text-sm font-medium text-blue-200">Resolved Accident Reports</p>
                <p class="text-4xl font-bold text-white mt-2" id="resolvedAccidentReports">0</p>
                <div class="flex items-center text-blue-300 text-sm mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                    <span>+7% from last month</span>
                </div>
            </div>

            <div class="bg-blue-950 rounded-lg p-6 shadow-md flex flex-col items-start">
                <p class="text-sm font-medium text-blue-200">Pending Accident Reports</p>
                <p class="text-4xl font-bold text-white mt-2" id="pendingAccidentReports">0</p>
                <div class="flex items-center text-blue-300 text-sm mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                    <span>-3% from last month</span>
                </div>
            </div>

            <div class="bg-blue-950 rounded-lg p-6 shadow-md flex flex-col items-start">
                <p class="text-sm font-medium text-blue-200">New Reports Today</p>
                <p class="text-4xl font-bold text-white mt-2" id="newReportsToday">0</p>
                <div class="flex items-center text-blue-300 text-sm mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                    <span>+1 today</span>
                </div>
            </div>

            <div class="bg-blue-950 rounded-lg p-6 shadow-md flex flex-col items-start">
                <p class="text-sm font-medium text-blue-200">Speeding Incidents</p>
                <p class="text-4xl font-bold text-white mt-2" id="speedingIncidentsCount">0</p>
                <div class="flex items-center text-blue-300 text-sm mt-2">
                    <span>Leading Cause</span>
                </div>
            </div>

            <div class="bg-blue-950 rounded-lg p-6 shadow-md flex flex-col items-start">
                <p class="text-sm font-medium text-blue-200">Estimated Damage</p>
                <p class="text-4xl font-bold text-white mt-2" id="estimatedDamage">$0</p>
                <div class="flex items-center text-blue-300 text-sm mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                    </svg>
                    <span>+15% from last year</span>
                </div>
            </div>

            <div class="bg-blue-950 rounded-lg p-6 shadow-md flex flex-col items-start">
                <p class="text-sm font-medium text-blue-200">High Severity Accidents</p>
                <p class="text-4xl font-bold text-white mt-2" id="highSeverityAccidents">0</p>
                <div class="flex items-center text-blue-300 text-sm mt-2">
                    <span>Immediate Action</span>
                </div>
            </div>

            <div class="bg-blue-950 rounded-lg p-6 shadow-md flex flex-col items-start">
                <p class="text-sm font-medium text-blue-200">Avg. Response Time</p>
                <p class="text-4xl font-bold text-white mt-2" id="avgResponseTimeDisplay">0 min</p>
                <div class="flex items-center text-blue-300 text-sm mt-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                    <span>-3 min from last week</span>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2 bg-blue-950 rounded-lg p-6 shadow-md">
                <h2 class="text-xl font-semibold text-white mb-4">Accident Reports Statistics</h2>
                <p class="text-blue-200 mb-4">Monthly breakdown of accident incidents.</p>
                <div class="w-full h-80 bg-blue-900 rounded-md flex items-center justify-center text-blue-200 p-4">
                    <canvas id="monthlyAccidentReportsChart"></canvas>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <div class="w-full h-64 bg-blue-900 rounded-md flex items-center justify-center text-blue-200 p-4">
                        <canvas id="accidentCauseDistributionChart"></canvas>
                    </div>
                    <div class="w-full h-64 bg-blue-900 rounded-md flex items-center justify-center text-blue-200 p-4">
                        <canvas id="accidentSeverityBreakdownChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1 bg-blue-950 rounded-lg p-6 shadow-md">
                <h2 class="text-xl font-semibold text-white mb-4">Incident Distribution by Property Type</h2>
                <p class="text-blue-200 mb-4">Breakdown of incidents by the type of property affected.</p>
                <div class="w-full h-[400px] bg-blue-900 rounded-md flex items-center justify-center text-blue-200">
                    <canvas id="propertyTypeDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Accident Reports Table Section -->
        <div class="lg:col-span-3 bg-blue-950 rounded-lg p-6 shadow-md overflow-x-auto">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                <h2 class="text-xl font-semibold text-white">Recent Accident Reports</h2>
                <div class="flex space-x-2 flex-wrap gap-2">
                    <input type="text" id="recentReportsSearchInput" placeholder="Search recent reports..." class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <select class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" id="recentSeverityFilter">
                        <option value="All">All Severities</option>
                        <option value="Critical">Critical</option>
                        <option value="Serious">Serious</option>
                        <option value="Minor">Minor</option>
                    </select>
                    <select class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500" id="recentStatusFilter">
                        <option value="All">All Statuses</option>
                        <option value="Reported">Reported</option>
                        <option value="Active">Active</option>
                        <option value="Closed">Closed</option>
                        <option value="Investigating">Investigating</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Duplicate">Duplicate</option>
                    </select>
                </div>
            </div>
            <table class="min-w-full divide-y divide-blue-700">
                <thead class="bg-blue-900">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider rounded-tl-lg">
                            Report ID
                        </th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">
                            Location
                        </th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">
                            Date/Time
                        </th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">
                            Cause
                        </th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">
                            Severity
                        </th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">
                            Status
                        </th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider rounded-tr-lg">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-blue-700" id="accidentReportsTableBody">
                    <!-- Report rows will be dynamically populated here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Report Details Modal (for viewing/editing existing reports) -->
    <div id="reportDetailsModal" class="modal hidden">
        <div class="modal-content w-full md:w-3/4 lg:w-1/2">
            <button class="modal-close-button" onclick="document.getElementById('reportDetailsModal').classList.add('hidden');">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-blue-400 mb-4">Report Details: <span id="modalReportIdDisplay"></span></h2>
            <form id="editReportForm" class="space-y-4">
                <input type="hidden" id="editReportId" name="report_id">
                <div>
                    <label for="editLocation" class="block text-blue-200 text-sm font-bold mb-2">Location:</label>
                    <input type="text" id="editLocation" name="location" class="form-control" required>
                </div>
                <div>
                    <label for="editDateTime" class="block text-blue-200 text-sm font-bold mb-2">Date/Time:</label>
                    <input type="datetime-local" id="editDateTime" name="date_time" class="form-control" required>
                </div>
                <div>
                    <label for="editCause" class="block text-blue-200 text-sm font-bold mb-2">Cause:</label>
                    <select id="editCause" name="cause" class="form-control" required>
                        <option value="">Select Cause</option>
                        <option value="Speeding">Speeding</option>
                        <option value="Pothole">Pothole</option>
                        <option value="Brake Failure">Brake Failure</option>
                        <option value="Driver Distraction">Driver Distraction</option>
                        <option value="Poor Visibility">Poor Visibility</option>
                        <option value="Traffic Light Violation">Traffic Light Violation</option>
                        <option value="Improper Lane Change">Improper Lane Change</option>
                        <option value="Mechanical Failure">Mechanical Failure</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="editSeverity" class="block text-blue-200 text-sm font-bold mb-2">Severity:</label>
                    <select id="editSeverity" name="severity" class="form-control" required>
                        <option value="">Select Severity</option>
                        <option value="Critical">Critical</option>
                        <option value="Serious">Serious</option>
                        <option value="Minor">Minor</option>
                    </select>
                </div>
                <div>
                    <label for="editStatus" class="block text-blue-200 text-sm font-bold mb-2">Status:</label>
                    <select id="editStatus" name="status" class="form-control" required>
                        <option value="">Select Status</option>
                        <option value="Reported">Reported</option>
                        <option value="Active">Active</option>
                        <option value="Closed">Closed</option>
                        <option value="Investigating">Investigating</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Duplicate">Duplicate</option>
                    </select>
                </div>
                <div>
                    <label for="editDamageEstimate" class="block text-blue-200 text-sm font-bold mb-2">Damage Estimate ($):</label>
                    <input type="number" id="editDamageEstimate" name="damage_estimate" class="form-control" min="0">
                </div>
                <div>
                    <label for="editFatalities" class="block text-blue-200 text-sm font-bold mb-2">Fatalities:</label>
                    <input type="number" id="editFatalities" name="fatalities" class="form-control" min="0">
                </div>
                <div>
                    <label for="editInjuries" class="block text-blue-200 text-sm font-bold mb-2">Injuries:</label>
                    <input type="number" id="editInjuries" name="injuries" class="form-control" min="0">
                </div>
                <div>
                    <label for="editResponseTime" class="block text-blue-200 text-sm font-bold mb-2">Response Time (min):</label>
                    <input type="number" id="editResponseTime" name="response_time" class="form-control" min="0">
                </div>
                <div>
                    <label for="editPropertyType" class="block text-blue-200 text-sm font-bold mb-2">Property Type:</label>
                    <select id="editPropertyType" name="property_type" class="form-control" required>
                        <option value="">Select Property Type</option>
                        <option value="Road">Road</option>
                        <option value="Bridge">Bridge</option>
                        <option value="Intersection">Intersection</option>
                        <option value="Expressway">Expressway</option>
                        <option value="Toll Gate">Toll Gate</option>
                        <option value="Rural Road">Rural Road</option>
                        <option value="Gate">Gate</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="mt-6">
                    <label for="editDescription" class="block text-blue-200 text-sm font-bold mb-2">Description:</label>
                    <textarea id="editDescription" name="description" class="w-full p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 mt-2 h-24"></textarea>
                </div>
                <div class="mt-6">
                    <p class="font-semibold text-blue-200">Attached Media:</p>
                    <div id="editMedia" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mt-2">
                    </div>
                </div>
                <div class="mt-6">
                    <p class="font-semibold text-blue-200">Chatbot Conversation Log:</p>
                    <div id="editChatbotLog" class="bg-blue-800 p-4 rounded-md mt-2 max-h-48 overflow-y-auto text-sm">
                    </div>
                </div>
                <div class="mt-6">
                    <p class="font-semibold text-blue-200">Admin Action History:</p>
                    <div id="editAdminLog" class="bg-blue-800 p-4 rounded-md mt-2 max-h-32 overflow-y-auto text-sm">
                    </div>
                </div>
                <div class="mt-6">
                    <label for="editInternalNotes" class="block text-blue-200 text-sm font-bold mb-2">Internal Notes:</label>
                    <textarea id="editInternalNotes" name="internal_notes" class="w-full p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 mt-2 h-24"></textarea>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700" onclick="document.getElementById('reportDetailsModal').classList.add('hidden');">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
                    <button type="button" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700" id="flagAsDuplicateBtn">Flag as Duplicate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Report Modal (for adding new reports) -->
    <div id="addEditReportModal" class="modal hidden">
        <div class="modal-content w-full md:w-2/3 lg:w-1/2">
            <button class="modal-close-button" onclick="document.getElementById('addEditReportModal').classList.add('hidden');">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-blue-400 mb-4">Add New Accident Report</h2>
            <form id="accidentReportForm" class="space-y-4">
                <div>
                    <label for="reportIdInput" class="block text-blue-200 text-sm font-bold mb-2">Report ID:</label>
                    <input type="text" id="reportIdInput" name="report_id" class="form-control" readonly>
                </div>
                <div>
                    <label for="locationInput" class="block text-blue-200 text-sm font-bold mb-2">Location:</label>
                    <input type="text" id="locationInput" name="location" class="form-control" placeholder="e.g., Main Road, Near City Center" required>
                </div>
                <div>
                    <label for="dateTimeInput" class="block text-blue-200 text-sm font-bold mb-2">Date/Time:</label>
                    <input type="datetime-local" id="dateTimeInput" name="date_time" class="form-control" required>
                </div>
                <div>
                    <label for="causeInput" class="block text-blue-200 text-sm font-bold mb-2">Cause:</label>
                    <select id="causeInput" name="cause" class="form-control" required>
                        <option value="">Select Cause</option>
                        <option value="Speeding">Speeding</option>
                        <option value="Pothole">Pothole</option>
                        <option value="Brake Failure">Brake Failure</option>
                        <option value="Driver Distraction">Driver Distraction</option>
                        <option value="Poor Visibility">Poor Visibility</option>
                        <option value="Traffic Light Violation">Traffic Light Violation</option>
                        <option value="Improper Lane Change">Improper Lane Change</option>
                        <option value="Mechanical Failure">Mechanical Failure</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="severityInput" class="block text-blue-200 text-sm font-bold mb-2">Severity:</label>
                    <select id="severityInput" name="severity" class="form-control" required>
                        <option value="">Select Severity</option>
                        <option value="Critical">Critical</option>
                        <option value="Serious">Serious</option>
                        <option value="Minor">Minor</option>
                    </select>
                </div>
                <div>
                    <label for="statusInput" class="block text-blue-200 text-sm font-bold mb-2">Status:</label>
                    <select id="statusInput" name="status" class="form-control" required>
                        <option value="">Select Status</option>
                        <option value="Reported">Reported</option>
                        <option value="Active">Active</option>
                        <option value="Closed">Closed</option>
                        <option value="Investigating">Investigating</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Duplicate">Duplicate</option>
                    </select>
                </div>
                <div>
                    <label for="damageEstimateInput" class="block text-blue-200 text-sm font-bold mb-2">Damage Estimate ($):</label>
                    <input type="number" id="damageEstimateInput" name="damage_estimate" class="form-control" placeholder="e.g., 50000" min="0">
                </div>
                <div>
                    <label for="fatalitiesInput" class="block text-blue-200 text-sm font-bold mb-2">Fatalities:</label>
                    <input type="number" id="fatalitiesInput" name="fatalities" class="form-control" placeholder="e.g., 0" min="0">
                </div>
                <div>
                    <label for="injuriesInput" class="block text-blue-200 text-sm font-bold mb-2">Injuries:</label>
                    <input type="number" id="injuriesInput" name="injuries" class="form-control" placeholder="e.g., 1" min="0">
                </div>
                <div>
                    <label for="responseTimeInput" class="block text-blue-200 text-sm font-bold mb-2">Response Time (min):</label>
                    <input type="number" id="responseTimeInput" class="form-control" placeholder="e.g., 15" min="0">
                </div>
                <div>
                    <label for="propertyTypeInput" class="block text-blue-200 text-sm font-bold mb-2">Property Type:</label>
                    <select id="propertyTypeInput" name="property_type" class="form-control" required>
                        <option value="">Select Property Type</option>
                        <option value="Road">Road</option>
                        <option value="Bridge">Bridge</option>
                        <option value="Intersection">Intersection</option>
                        <option value="Expressway">Expressway</option>
                        <option value="Toll Gate">Toll Gate</option>
                        <option value="Rural Road">Rural Road</option>
                        <option value="Gate">Gate</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="mediaUpload" class="block text-blue-200 text-sm font-bold mb-2">Upload Media (Images):</label>
                    <input type="file" id="mediaUpload" name="media" class="block w-full text-sm text-blue-100
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-500 file:text-white
                        hover:file:bg-blue-600"
                        accept="image/*" multiple>
                    <div id="mediaPreview" class="mt-2 grid grid-cols-3 gap-2">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700" onclick="document.getElementById('addEditReportModal').classList.add('hidden');">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Report Generation Modal -->
    <div id="customReportModal" class="modal hidden">
        <div class="modal-content w-full md:w-2/3 lg:w-1/2">
            <button class="modal-close-button" onclick="document.getElementById('customReportModal').classList.add('hidden');">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-blue-400 mb-4">Generate Custom Report</h2>
            <form id="reportGenerationForm" class="space-y-4">
                <div>
                    <label for="reportStartDate" class="block text-blue-200 text-sm font-bold mb-2">Start Date:</label>
                    <input type="date" id="reportStartDate" name="start_date" class="form-control">
                </div>
                <div>
                    <label for="reportEndDate" class="block text-blue-200 text-sm font-bold mb-2">End Date:</label>
                    <input type="date" id="reportEndDate" name="end_date" class="form-control">
                </div>
                <div>
                    <label for="reportSeverityFilter" class="block text-blue-200 text-sm font-bold mb-2">Severity:</label>
                    <select id="reportSeverityFilter" class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Severities</option>
                        <option value="Critical">Critical</option>
                        <option value="Serious">Serious</option>
                        <option value="Minor">Minor</option>
                    </select>
                </div>
                <div>
                    <label for="reportLocationFilter" class="block text-blue-200 text-sm font-bold mb-2">Location:</label>
                    <select id="reportLocationFilter" class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Locations</option>
                    </select>
                </div>
                <div>
                    <label for="reportPropertyTypeFilter" class="block text-blue-200 text-sm font-bold mb-2">Property Type:</label>
                    <select id="reportPropertyTypeFilter" class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">All Property Types</option>
                    </select>
                </div>
                <div>
                    <label for="reportFormat" class="block text-blue-200 text-sm font-bold mb-2">Output Format:</label>
                    <select id="reportFormat" name="format" class="form-control">
                        <option value="csv">CSV (Comma Separated Values)</option>
                        <option value="pdf_summary">Text Summary (PDF-like)</option>
                    </select>
                </div>
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700" onclick="document.getElementById('customReportModal').classList.add('hidden');">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Generate Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- All Incidents Modal (for viewing all reports with advanced filters) -->
    <div id="allIncidentsModal" class="modal hidden">
        <div class="modal-content w-11/12 max-w-6xl">
            <button class="modal-close-button" onclick="document.getElementById('allIncidentsModal').classList.add('hidden');">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-blue-400 mb-4">All Accident Incidents</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="allIncidentsSearch" class="block text-blue-200 text-sm font-bold mb-2">Search:</label>
                    <input type="text" id="allIncidentsSearch" placeholder="Search ID, location, cause..." class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="allIncidentsSeverityFilter" class="block text-blue-200 text-sm font-bold mb-2">Severity:</label>
                    <select id="allIncidentsSeverityFilter" class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="All">All Severities</option>
                        <option value="Critical">Critical</option>
                        <option value="Serious">Serious</option>
                        <option value="Minor">Minor</option>
                    </select>
                </div>
                <div>
                    <label for="allIncidentsStatusFilter" class="block text-blue-200 text-sm font-bold mb-2">Status:</label>
                    <select id="allIncidentsStatusFilter" class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="All">All Statuses</option>
                        <option value="Reported">Reported</option>
                        <option value="Active">Active</option>
                        <option value="Closed">Closed</option>
                        <option value="Investigating">Investigating</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Duplicate">Duplicate</option>
                    </select>
                </div>
                <div>
                    <label for="allIncidentsCauseFilter" class="block text-blue-200 text-sm font-bold mb-2">Cause:</label>
                    <select id="allIncidentsCauseFilter" class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="All">All Causes</option>
                        <option value="Speeding">Speeding</option>
                        <option value="Pothole">Pothole</option>
                        <option value="Brake Failure">Brake Failure</option>
                        <option value="Driver Distraction">Driver Distraction</option>
                        <option value="Poor Visibility">Poor Visibility</option>
                        <option value="Traffic Light Violation">Traffic Light Violation</option>
                        <option value="Improper Lane Change">Improper Lane Change</option>
                        <option value="Mechanical Failure">Mechanical Failure</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="allIncidentsLocationFilter" class="block text-blue-200 text-sm font-bold mb-2">Location:</label>
                    <select id="allIncidentsLocationFilter" class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="All">All Locations</option>
                    </select>
                </div>
                <div>
                    <label for="allIncidentsPropertyTypeFilter" class="block text-blue-200 text-sm font-bold mb-2">Property Type:</label>
                    <select id="allIncidentsPropertyTypeFilter" class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="All">All Property Types</option>
                    </select>
                </div>
                <div>
                    <label for="allIncidentsStartDate" class="block text-blue-200 text-sm font-bold mb-2">Start Date:</label>
                    <input type="date" id="allIncidentsStartDate" class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="allIncidentsEndDate" class="block text-blue-200 text-sm font-bold mb-2">End Date:</label>
                    <input type="date" id="allIncidentsEndDate" class="p-2 rounded-md bg-blue-800 text-blue-100 border border-blue-700 w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-blue-700">
                    <thead class="bg-blue-900">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider rounded-tl-lg">Report ID</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">Location</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">Date/Time</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">Cause</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">Severity</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">Property Type</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-blue-200 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-blue-700" id="allIncidentsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <script>
        // Sample data for reports (in a real Django app, this would be fetched from a Django REST API endpoint,
        // e.g., using `fetch('/api/accident_reports/')` in `DOMContentLoaded`).
        let accidentReports = [
            {
                id: 'AR-001', location: 'Kaduna-Abuja Expressway, Km 50', dateTime: '2025-06-20T10:00:00',
                cause: 'Speeding', severity: 'Critical', status: 'Active', vehiclesInvolved: 5,
                fatalities: 3, injuries: 8, responseTime: 15, propertyType: 'Expressway',
                description: 'Multiple vehicle collision due to high speed. Road currently blocked. Emergency services en route.',
                media: ['https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+1A', 'https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+1B'],
                chatbotLog: 'User: Accident on highway!\nChatbot: Location and severity?\nUser: Kaduna-Abuja, critical.\nChatbot: Emergency dispatched.',
                adminLog: 'Admin User: Report Received (2025-06-20 10:01)\nAdmin User: Dispatched response team (2025-06-20 10:05)',
                damageEstimate: 75000, internalNotes: 'Requires immediate attention due to high traffic volume.'
            },
            {
                id: 'AR-002', location: 'Zaria City Bypass, Near Ahmadu Bello Uni', dateTime: '2025-06-19T14:30:00',
                cause: 'Pothole', severity: 'Serious', status: 'Closed', vehiclesInvolved: 1,
                fatalities: 0, injuries: 1, responseTime: 40, propertyType: 'Road',
                description: 'Car veered off road hitting a large pothole. Driver sustained serious injuries. Vehicle recovered.',
                media: [],
                chatbotLog: 'User: Car hit pothole!\nChatbot: Injuries?\nUser: Minor injury, car damaged.\nChatbot: Help is on the way.',
                adminLog: 'Admin User: Report Received (2025-06-19 14:35)\nAdmin User: Accident cleared, road patched (2025-06-19 16:00)',
                damageEstimate: 12000, internalNotes: 'Monitor road conditions regularly.'
            },
            {
                id: 'AR-003', location: 'Kafanchan-Jema\'a Road, Bridge Section', dateTime: '2025-06-18T08:15:00',
                cause: 'Brake Failure', severity: 'Critical', status: 'Investigating', vehiclesInvolved: 3,
                fatalities: 2, injuries: 5, responseTime: 20, propertyType: 'Bridge',
                description: 'Truck suffered brake failure on bridge, collided with two cars. Bridge integrity under assessment.',
                media: ['https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+2A'],
                chatbotLog: 'User: Truck crash on bridge!\nChatbot: Fatalities?\nUser: Yes, multiple. Bridge damaged.\nChatbot: Urgent response dispatched.',
                adminLog: 'Admin User: Report Received (2025-06-18 08:20)\nAdmin User: Structural engineers en route (2025-06-18 09:00)',
                damageEstimate: 250000, internalNotes: 'Close bridge to traffic until assessment complete.'
            },
            {
                id: 'AR-004', location: 'Sokoto Road, Kaduna City', dateTime: '2025-06-17T11:00:00',
                cause: 'Driver Distraction', severity: 'Minor', status: 'Resolved', vehiclesInvolved: 2,
                fatalities: 0, injuries: 0, responseTime: 10, propertyType: 'Road',
                description: 'Minor fender-bender. No injuries, minimal damage. Parties exchanged info and left.',
                media: [],
                chatbotLog: 'User: Minor accident, Sokoto Road.\nChatbot: Injuries?\nUser: None, just a scratch.\nChatbot: Understood.',
                adminLog: 'Admin User: Report Received (2025-06-17 11:05)\nAdmin User: Report closed (2025-06-17 11:15)',
                damageEstimate: 1500, internalNotes: 'Typical minor incident.'
            },
            {
                id: 'AR-005', location: 'Kaduna Western Bye-pass, Refinery Area', dateTime: '2025-06-16T22:00:00',
                cause: 'Poor Visibility', severity: 'Serious', status: 'Active', vehiclesInvolved: 2,
                fatalities: 1, injuries: 2, responseTime: 25, propertyType: 'Expressway',
                description: 'Nighttime collision involving a tanker and a car due to heavy fog. Tanker carrying non-flammable liquid.',
                media: ['https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+3A', 'https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+3B', 'https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+3C'],
                chatbotLog: 'User: Foggy crash!\nChatbot: Injuries? Tanker type?\nUser: Fatalities, non-flammable tanker.\nChatbot: Teams en route.',
                adminLog: 'Admin User: Report Received (2025-06-16 22:05)\nAdmin User: Tanker safely secured. Recovery ongoing (2025-06-16 23:00)',
                damageEstimate: 50000, internalNotes: 'Monitor weather conditions for advisories.'
            },
            {
                id: 'AR-006', location: 'Abuja City Gate Intersection', dateTime: '2024-11-15T09:15:00',
                cause: 'Traffic Light Violation', severity: 'Serious', status: 'Closed', vehiclesInvolved: 2,
                fatalities: 0, injuries: 3, responseTime: 20, propertyType: 'Intersection',
                description: 'Two cars collided at City Gate. One driver ran a red light. Injuries reported.',
                media: [],
                chatbotLog: 'User: Red light crash!\nChatbot: Injuries?\nUser: Yes, three injured.\nChatbot: Police informed.',
                adminLog: 'Admin User: Report Received (2024-11-15 09:20)\nAdmin User: Scene cleared (2024-11-15 10:30)',
                damageEstimate: 18000, internalNotes: 'Recommend review of traffic light timing.'
            },
            {
                id: 'AR-007', location: 'Wuse Market Road, Abuja', dateTime: '2024-12-05T13:00:00',
                cause: 'Improper Lane Change', severity: 'Minor', status: 'Closed', vehiclesInvolved: 2,
                fatalities: 0, injuries: 0, responseTime: 10, propertyType: 'Road',
                description: 'Taxi brushed against private car during lane change. No significant damage, minor argument.',
                media: [],
                chatbotLog: 'User: Lane change accident.\nChatbot: Damage?\nUser: Minor, just a scrape.\nChatbot: Understood.',
                adminLog: 'Admin User: Report Received (2024-12-05 13:05)',
                damageEstimate: 800, internalNotes: 'No further action needed.'
            },
            {
                id: 'AR-008', location: 'Kubwa Expressway, Abuja', dateTime: '2023-01-25T17:45:00',
                cause: 'Speeding', severity: 'Critical', status: 'Closed', vehiclesInvolved: 2,
                fatalities: 4, injuries: 1, responseTime: 30, propertyType: 'Expressway',
                description: 'Fatal head-on collision on Kubwa Expressway. Caused by over-speeding. Road briefly closed.',
                media: ['https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+4A'],
                chatbotLog: 'User: Fatal crash on expressway!\nChatbot: Casualties?\nUser: Multiple fatalities.\nChatbot: Road closure and emergency teams.',
                adminLog: 'Admin User: Report Received (2023-01-25 17:50)\nAdmin User: Road reopened, scene cleared (2023-01-25 20:00)',
                damageEstimate: 150000, internalNotes: 'High profile case. Ongoing police investigation.'
            },
            {
                id: 'AR-009', location: 'Airport Road, Abuja', dateTime: '2024-06-08T06:30:00',
                cause: 'Mechanical Failure', severity: 'Serious', status: 'Reported', vehiclesInvolved: 1,
                fatalities: 0, injuries: 5, responseTime: 25, propertyType: 'Road',
                description: 'Bus experienced tire burst on Airport Road, swerved and hit barrier. Minor injuries, bus disabled.',
                media: [],
                chatbotLog: 'User: Bus tire burst!\nChatbot: Injuries?\nUser: Five injured, bus stopped.\nChatbot: Rescue dispatched.',
                adminLog: 'Admin User: Report Received (2024-06-08 06:35)\nAdmin User: Recovery ongoing (2024-06-08 07:15)',
                damageEstimate: 30000, internalNotes: 'FRSC to inspect bus after recovery.'
            },
            {
                id: 'AR-010', location: 'Gwarinpa Estate Main Gate, Abuja', dateTime: '2025-02-10T15:00:00',
                cause: 'Driver Distraction', severity: 'Minor', status: 'Closed', vehiclesInvolved: 2,
                fatalities: 0, injuries: 0, responseTime: 5, propertyType: 'Gate',
                description: 'Two vehicles scraped each other at estate gate. Drivers exchanged details.',
                media: [],
                chatbotLog: 'User: Minor scrape at gate.\nChatbot: Injuries?\nUser: None, just a fender bender.\nChatbot: Understood.',
                adminLog: 'Admin User: Report Received (2025-02-10 15:05)',
                damageEstimate: 500, internalNotes: 'Common occurrence, no follow up needed.'
            },
            {
                id: 'AR-011', location: 'Lagos-Ibadan Expressway, Km 100', dateTime: '2025-01-05T09:00:00',
                cause: 'Speeding', severity: 'Critical', status: 'Active', vehiclesInvolved: 4,
                fatalities: 2, injuries: 7, responseTime: 10, propertyType: 'Expressway',
                description: 'Multi-vehicle pile-up due to high speed and sudden braking. Road partially blocked.',
                media: ['https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+5A'],
                chatbotLog: 'User: Major pile-up!\nChatbot: Casualties?\nUser: Multiple, road blocked.\nChatbot: Emergency response.',
                adminLog: 'Admin User: Report Received (2025-01-05 09:02)\nAdmin User: Emergency services dispatched (2025-01-05 09:07)',
                damageEstimate: 100000, internalNotes: 'High priority, potential for further incidents.'
            },
            {
                id: 'AR-012', location: 'Benin-Ore Expressway, Toll Gate', dateTime: '2024-10-20T18:00:00',
                cause: 'Drunk Driving', severity: 'Serious', status: 'Closed', vehiclesInvolved: 2,
                fatalities: 1, injuries: 2, responseTime: 30, propertyType: 'Toll Gate',
                description: 'Car hit barrier after driver lost control. Suspected drunk driving. Driver arrested.',
                media: [],
                chatbotLog: 'User: Drunk driver crash!\nChatbot: Injuries? Driver status?\nUser: Fatal, driver arrested.\nChatbot: Police and medical teams.',
                adminLog: 'Admin User: Report Received (2024-10-20 18:05)\nAdmin User: Police confirmed arrest (2024-10-20 19:10)',
                damageEstimate: 45000, internalNotes: 'Legal action pending.'
            },
            {
                id: 'AR-013', location: 'Enugu-Port Harcourt Road, Umuahia', dateTime: '2025-03-12T11:30:00',
                cause: 'Tyre Burst', severity: 'Minor', status: 'Resolved', vehiclesInvolved: 1,
                fatalities: 0, injuries: 0, responseTime: 15, propertyType: 'Road',
                description: 'Vehicle had a tyre burst, swerved but no collision. Driver safe, minor vehicle damage.',
                media: [],
                chatbotLog: 'User: Tyre burst on road.\nChatbot: Injuries?\nUser: None, just vehicle damage.\nChatbot: Roadside assistance.',
                adminLog: 'Admin User: Report Received (2025-03-12 11:35)\nAdmin User: Driver confirmed safe (2025-03-12 12:00)',
                damageEstimate: 3000, internalNotes: 'Remind drivers about tire maintenance.'
            },
            {
                id: 'AR-014', location: 'Calabar-Itu Road, Akwa Ibom', dateTime: '2025-04-25T07:00:00',
                cause: 'Animal Crossing', severity: 'Minor', status: 'Closed', vehiclesInvolved: 1,
                fatalities: 0, injuries: 0, responseTime: 20, propertyType: 'Rural Road',
                description: 'Car hit a stray animal. Minor bumper damage. Animal deceased.',
                media: [],
                chatbotLog: 'User: Animal hit by car.\nChatbot: Injuries?\nUser: None, animal deceased.\nChatbot: Road cleared.',
                adminLog: 'Admin User: Report Received (2025-04-25 07:05)\nAdmin User: Scene cleared (2025-04-25 07:45)',
                damageEstimate: 1000, internalNotes: 'Consider warning signs for animal crossings.'
            },
            {
                id: 'AR-015', location: 'Jos-Bauchi Road, Plateau', dateTime: '2024-09-01T16:00:00',
                cause: 'Pothole', severity: 'Serious', status: 'Investigating', vehiclesInvolved: 1,
                fatalities: 0, injuries: 1, responseTime: 25, propertyType: 'Road',
                description: 'Motorcycle lost control due to a large pothole. Rider sustained leg injury.',
                media: ['https://placehold.co/150x100/3B82F6/FFFFFF?text=Accident+Scene+6A'],
                chatbotLog: 'User: Motorcycle crash, pothole!\nChatbot: Injuries?\nUser: Leg injury.\nChatbot: Medical assistance and road repair.',
                adminLog: 'Admin User: Report Received (2024-09-01 16:05)\nAdmin User: Road maintenance alerted (2024-09-01 16:30)',
                damageEstimate: 8000, internalNotes: 'Urgent road repair needed.'
            }
        ];

        // Global flag to prevent immediate closing of newly opened modals by the global click listener
        let isModalOpening = false;

        /**
         * Creates and initializes a Chart.js chart on a given canvas element.
         * This function handles canvas resizing for sharpness and destroys existing charts.
         * @param {string} ctxId - The ID of the canvas element.
         * @param {string} type - The type of chart (e.g., 'line', 'bar', 'pie').
         * @param {Array<string>} labels - Labels for the chart's axes or segments.
         * @param {Array<number>} data - Data values for the chart.
         * @param {string} label - Label for the dataset.
         * @param {string|Array<string>} backgroundColor - Background color(s) for chart elements.
         * @param {string|Array<string>} borderColor - Border color(s) for chart elements.
         */
        function createChart(ctxId, type, labels, data, label, backgroundColor, borderColor) {
            const canvas = document.getElementById(ctxId);
            if (!canvas) {
                console.error(`Canvas element with ID '${ctxId}' not found.`);
                return;
            }
            const ctx = canvas.getContext('2d');

            // Get the actual display size of the canvas's parent container
            const parent = canvas.parentElement;
            const computedStyle = getComputedStyle(parent);
            const displayWidth = parseFloat(computedStyle.width);
            const displayHeight = parseFloat(computedStyle.height);

            // Set the canvas element's width and height attributes to match its display size
            // multiplied by the device pixel ratio for sharper rendering on high-DPI screens
            const dpr = window.devicePixelRatio || 1;
            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;

            // Ensure the canvas is styled to fit its container
            canvas.style.width = `${displayWidth}px`;
            canvas.style.height = `${displayHeight}px`;

            // If a chart instance already exists on this canvas, destroy it to prevent duplicates
            if (Chart.getChart(ctxId)) {
                Chart.getChart(ctxId).destroy();
            }

            new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1,
                        fill: type === 'line' ? true : false, // Fill area under line for line charts
                        tension: type === 'line' ? 0.4 : 0 // Smooth curves for line charts
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    devicePixelRatio: dpr, // Crucial for high-DPI screens
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E0E7FF' // Light color for legend text
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#1E293B' /* Blue grid lines */
                            },
                            ticks: {
                                color: '#E0E7FF' // Light color for x-axis labels
                            }
                        },
                        y: {
                            grid: {
                                color: '#1E293B' /* Blue grid lines */
                            },
                            ticks: {
                                color: '#E0E7FF', // Light color for y-axis labels
                                beginAtZero: true
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the recent reports table with a subset of the sample data.
         * @param {Array<Object>} reportsToDisplay - The array of report objects to render.
         */
        function renderReportsTable(reportsToDisplay = accidentReports.slice(0, 10)) {
            const tableBody = document.getElementById('accidentReportsTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            reportsToDisplay.forEach(report => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-900 transition duration-150 ease-in-out';
                // Determine severity and status badge colors
                const severityClass = `severity-${report.severity.toLowerCase()}`;
                const statusClass = `status-${report.status.toLowerCase()}`;

                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-white">${report.id}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-100">${report.location}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-100">${new Date(report.dateTime).toLocaleString()}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-100">${report.cause}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${severityClass} text-white">
                            ${report.severity}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass} text-white">
                            ${report.status}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <button class="text-blue-400 hover:text-blue-500 mr-2 view-details-btn" data-report-id="${report.id}">Details</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Re-attach event listeners for "Details" buttons after re-rendering
            document.querySelectorAll('#accidentReportsTableBody .view-details-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const reportId = event.target.dataset.reportId;
                    console.log(`Details button clicked for Report ID: ${reportId}`); // Debugging log
                    const report = accidentReports.find(r => r.id === reportId);
                    if (report) {
                        populateReportDetailsModal(report);
                    } else {
                        console.error(`Report with ID ${reportId} not found for details.`);
                    }
                });
            });
        }

        /**
         * Populates the Report Details Modal with data from a specific report object.
         * @param {Object} report - The report object to display.
         */
        function populateReportDetailsModal(report) {
            const reportDetailsModal = document.getElementById('reportDetailsModal');
            document.getElementById('modalReportIdDisplay').textContent = report.id;
            document.getElementById('editReportId').value = report.id; // Hidden ID for saving
            document.getElementById('editLocation').value = report.location;
            document.getElementById('editDateTime').value = report.dateTime;
            document.getElementById('editCause').value = report.cause;
            document.getElementById('editSeverity').value = report.severity;
            document.getElementById('editStatus').value = report.status;
            document.getElementById('editDamageEstimate').value = report.damageEstimate || '';
            document.getElementById('editFatalities').value = report.fatalities || '';
            document.getElementById('editInjuries').value = report.injuries || '';
            document.getElementById('editResponseTime').value = report.responseTime || '';
            document.getElementById('editPropertyType').value = report.propertyType || '';
            document.getElementById('editDescription').value = report.description;
            document.getElementById('editChatbotLog').textContent = report.chatbotLog;
            document.getElementById('editAdminLog').textContent = report.adminLog;
            document.getElementById('editInternalNotes').value = report.internalNotes || '';

            const editMediaContainer = document.getElementById('editMedia');
            editMediaContainer.innerHTML = ''; // Clear previous media
            if (report.media && report.media.length > 0) {
                report.media.forEach(mediaUrl => {
                    const img = document.createElement('img');
                    img.src = mediaUrl;
                    img.alt = 'Incident Media';
                    img.className = 'w-full h-24 object-cover rounded-md';
                    editMediaContainer.appendChild(img);
                });
            } else {
                editMediaContainer.innerHTML = '<div class="w-full h-24 bg-blue-900 rounded-md flex items-center justify-center text-blue-200 text-sm p-4 border border-blue-700">No media available</div>';
            }

            reportDetailsModal.classList.remove('hidden'); // Show the modal

            isModalOpening = true; // Set flag when opening
            setTimeout(() => {
                isModalOpening = false; // Reset flag after a short delay
            }, 100);
        }

        /**
         * Updates the summary statistics displayed on the dashboard based on the current reports data.
         * @param {Array<Object>} reports - The array of report objects to use for calculations.
         */
        function updateSummaryStatistics(reports = accidentReports) {
            document.getElementById('totalAccidentReports').textContent = reports.length;
            document.getElementById('resolvedAccidentReports').textContent = reports.filter(r => r.status === 'Resolved').length;
            document.getElementById('pendingAccidentReports').textContent = reports.filter(r => r.status === 'Pending' || r.status === 'Investigating' || r.status === 'Reported' || r.status === 'Active').length;

            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('newReportsToday').textContent = reports.filter(r => r.dateTime.startsWith(today)).length;

            const speedingIncidents = reports.filter(r => r.cause === 'Speeding').length;
            document.getElementById('speedingIncidentsCount').textContent = speedingIncidents;

            const totalDamage = reports.reduce((sum, r) => sum + (r.damageEstimate || 0), 0);
            document.getElementById('estimatedDamage').textContent = `$${totalDamage.toLocaleString()}`;

            const highSeverity = reports.filter(r => r.severity === 'Critical' || r.severity === 'Serious').length;
            document.getElementById('highSeverityAccidents').textContent = highSeverity;

            const totalResponseTime = reports.reduce((sum, r) => sum + (r.responseTime || 0), 0);
            const avgResponseTime = reports.length > 0 ? (totalResponseTime / reports.length).toFixed(1) : 0;
            document.getElementById('avgResponseTimeDisplay').textContent = `${avgResponseTime} min`;
        }

        /**
         * Initializes all Chart.js charts on the dashboard. This function is called on page load
         * and on window resize to ensure charts are rendered sharply.
         * @param {Array<Object>} reports - The array of report objects to use for chart data.
         */
        function initializeAllCharts(reports = accidentReports) {
            // Data for Monthly Accident Reports Chart (Line Chart)
            const monthlyReports = {};
            reports.forEach(report => {
                const monthYear = report.dateTime.substring(0, 7); // YYYY-MM
                monthlyReports[monthYear] = (monthlyReports[monthYear] || 0) + 1;
            });
            const sortedMonths = Object.keys(monthlyReports).sort();
            const monthlyReportsLabels = sortedMonths.map(my => {
                const [year, month] = my.split('-');
                return new Date(year, month - 1).toLocaleString('en-US', { month: 'short', year: '2-digit' });
            });
            const monthlyReportsData = sortedMonths.map(my => monthlyReports[my]);

            createChart(
                'monthlyAccidentReportsChart',
                'line',
                monthlyReportsLabels,
                monthlyReportsData,
                'Number of Accident Reports',
                'rgba(59, 130, 246, 0.4)', /* Blue with transparency */
                'rgba(59, 130, 246, 1)'   /* Solid Blue */
            );

            // Data for Accident Cause Distribution Chart (Pie Chart)
            const accidentCauseLabels = ['Speeding', 'Pothole', 'Brake Failure', 'Driver Distraction', 'Poor Visibility', 'Traffic Light Violation', 'Improper Lane Change', 'Mechanical Failure', 'Animal Crossing', 'Drunk Driving', 'Tyre Burst', 'Other'];
            const causeCounts = {};
            reports.forEach(report => {
                const cause = accidentCauseLabels.includes(report.cause) ? report.cause : 'Other';
                causeCounts[cause] = (causeCounts[cause] || 0) + 1;
            });
            const accidentCauseData = accidentCauseLabels.map(cause => causeCounts[cause] || 0);

            const accidentCauseColors = [
                'rgba(59, 130, 246, 0.8)',   /* Blue */
                'rgba(37, 99, 235, 0.8)',    /* Darker Blue */
                'rgba(29, 78, 216, 0.8)',    /* Even Darker Blue */
                'rgba(17, 24, 39, 0.8)',     /* Very Dark Blue */
                'rgba(79, 70, 229, 0.8)',    /* Indigo */
                'rgba(109, 40, 217, 0.8)',   /* Violet */
                'rgba(139, 92, 246, 0.8)',   /* Purple */
                'rgba(168, 85, 247, 0.8)',   /* Light Purple */
                'rgba(200, 100, 250, 0.8)',  /* Lighter Purple */
                'rgba(220, 150, 255, 0.8)',  /* Even Lighter Purple */
                'rgba(240, 200, 255, 0.8)',  /* Pale Purple */
                'rgba(255, 255, 255, 0.8)'   /* White for Other */
            ];
            createChart(
                'accidentCauseDistributionChart',
                'pie',
                accidentCauseLabels,
                accidentCauseData,
                'Accident Causes',
                accidentCauseColors,
                accidentCauseColors // Border color same as background for pie
            );

            // Data for Accident Severity Breakdown Chart (Bar Chart)
            const accidentSeverityLabels = ['Critical', 'Serious', 'Minor'];
            const severityCounts = {};
            reports.forEach(report => {
                severityCounts[report.severity] = (severityCounts[report.severity] || 0) + 1;
            });
            const accidentSeverityData = accidentSeverityLabels.map(severity => severityCounts[severity] || 0);

            const accidentSeverityColors = [
                'rgba(239, 68, 68, 0.8)',   /* Red for Critical */
                'rgba(249, 115, 22, 0.8)',  /* Orange for Serious */
                'rgba(34, 197, 94, 0.8)'    /* Green for Minor */
            ];
            createChart(
                'accidentSeverityBreakdownChart',
                'bar',
                accidentSeverityLabels,
                accidentSeverityData,
                'Accident Severity',
                accidentSeverityColors,
                accidentSeverityColors // Border color same as background for bar
            );

            // Data for Property Type Distribution Chart (New Pie Chart)
            const propertyTypeLabels = ['Road', 'Bridge', 'Intersection', 'Expressway', 'Toll Gate', 'Rural Road', 'Gate', 'Other'];
            const propertyTypeCounts = {};
            reports.forEach(report => {
                const type = propertyTypeLabels.includes(report.propertyType) ? report.propertyType : 'Other';
                propertyTypeCounts[type] = (propertyTypeCounts[type] || 0) + 1;
            });
            const propertyTypeData = propertyTypeLabels.map(type => propertyTypeCounts[type] || 0);

            const propertyTypeColors = [
                'rgba(59, 130, 246, 0.8)',  /* Blue */
                'rgba(37, 99, 235, 0.8)',   /* Darker Blue */
                'rgba(29, 78, 216, 0.8)',   /* Even Darker Blue */
                'rgba(17, 24, 39, 0.8)',    /* Very Dark Blue */
                'rgba(79, 70, 229, 0.8)',   /* Indigo */
                'rgba(109, 40, 217, 0.8)',  /* Violet */
                'rgba(139, 92, 246, 0.8)',  /* Purple */
                'rgba(200, 200, 200, 0.8)'  /* Light Gray for Other */
            ];
            createChart(
                'propertyTypeDistributionChart',
                'pie',
                propertyTypeLabels,
                propertyTypeData,
                'Property Types',
                propertyTypeColors,
                propertyTypeColors
            );
        }

        /**
         * Converts an array of JavaScript objects into a CSV (Comma Separated Values) string.
         * @param {Array<Object>} data - The array of objects to convert.
         * @returns {string} The CSV string.
         */
        function convertToCSV(data) {
            if (data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvRows = [];

            csvRows.push(headers.join(','));

            for (const row of data) {
                const values = headers.map(header => {
                    // Handle potential null/undefined values and escape double quotes
                    const value = row[header] !== undefined && row[header] !== null ? String(row[header]) : '';
                    const escaped = value.replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        }

        /**
         * Triggers the download of a file to the user's browser.
         * @param {string} content - The content of the file.
         * @param {string} filename - The desired name of the file.
         * @param {string} mimeType - The MIME type of the file.
         */
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * Displays a custom alert message as a modal overlay.
         * This replaces browser's native `alert()` for better UI consistency and control.
         * @param {string} message - The main message content to display.
         * @param {string} title - The title for the alert modal.
         */
        function showCustomAlert(message, title = 'Alert') {
            const customAlert = document.createElement('div');
            customAlert.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[999]';
            customAlert.innerHTML = `
                <div class="bg-blue-950 p-6 rounded-lg shadow-lg text-white">
                    <h3 class="text-xl font-semibold mb-3">${title}</h3>
                    <p>${message}</p>
                    <button class="mt-4 px-4 py-2 bg-blue-600 rounded-md hover:bg-blue-700" onclick="this.closest('.fixed').remove()">OK</button>
                </div>
            `;
            document.body.appendChild(customAlert);
        }

        /**
         * Opens the custom report generation modal and populates its filters.
         */
        function openCustomReportModal() {
            const customReportModal = document.getElementById('customReportModal');
            customReportModal.classList.remove('hidden');
            populateReportFilters(); // Populate location and property type dropdowns

            isModalOpening = true; // Set flag when opening
            setTimeout(() => {
                isModalOpening = false; // Reset flag after a short delay
            }, 100);
        }

        /**
         * Populates the location and property type filter dropdowns in the custom report modal
         * with unique values from the accidentReports data.
         */
        function populateReportFilters() {
            const locationFilter = document.getElementById('reportLocationFilter');
            const propertyTypeFilter = document.getElementById('reportPropertyTypeFilter');

            // Store original "All" options to re-add them after clearing
            const originalLocationOption = locationFilter.querySelector('option[value="all"]').outerHTML;
            const originalPropertyTypeOption = propertyTypeFilter.querySelector('option[value="all"]').outerHTML;

            // Clear existing options, then re-add "All"
            locationFilter.innerHTML = originalLocationOption;
            propertyTypeFilter.innerHTML = originalPropertyTypeOption;

            const uniqueLocations = new Set();
            const uniquePropertyTypes = new Set();

            accidentReports.forEach(report => {
                uniqueLocations.add(report.location);
                if (report.propertyType) { // Ensure propertyType exists before adding
                    uniquePropertyTypes.add(report.propertyType);
                }
            });

            Array.from(uniqueLocations).sort().forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });

            Array.from(uniquePropertyTypes).sort().forEach(propertyType => {
                const option = document.createElement('option');
                option.value = propertyType;
                option.textContent = propertyType;
                propertyTypeFilter.appendChild(option);
            });
        }

        /**
         * Processes the custom report generation based on selected filters and format.
         * This function is triggered when the "Generate Report" button in the modal is clicked.
         * @param {Event} event - The form submission event.
         */
        function processReportGeneration(event) {
            event.preventDefault(); // Prevent form default submission

            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const severityFilter = document.getElementById('reportSeverityFilter').value;
            const locationFilter = document.getElementById('reportLocationFilter').value;
            const propertyTypeFilter = document.getElementById('reportPropertyTypeFilter').value;
            const format = document.getElementById('reportFormat').value;

            // Filter reports based on selected criteria
            const filteredReports = accidentReports.filter(report => {
                const reportDate = new Date(report.dateTime);
                const startDateTime = startDate ? new Date(startDate) : null;
                const endDateTime = endDate ? new Date(endDate) : null;

                const matchesDate = (!startDateTime || reportDate >= startDateTime) &&
                                    (!endDateTime || reportDate <= endDateTime);
                const matchesSeverity = severityFilter === 'all' || report.severity === severityFilter;
                const matchesLocation = locationFilter === 'all' || report.location === locationFilter;
                const matchesPropertyType = propertyTypeFilter === 'all' || report.propertyType === propertyTypeFilter;

                return matchesDate && matchesSeverity && matchesLocation && matchesPropertyType;
            });

            let reportContent = '';
            let filename = 'custom_accident_report';
            let mimeType = '';

            if (format === 'csv') {
                reportContent = convertToCSV(filteredReports);
                filename += '.csv';
                mimeType = 'text/csv';
            } else if (format === 'pdf_summary') {
                reportContent = generatePdfSummary(filteredReports, {
                    startDate, endDate, severityFilter, locationFilter, propertyTypeFilter
                });
                filename += '.txt'; // Using .txt for a simple text-based summary
                mimeType = 'text/plain';
            }

            if (filteredReports.length > 0) {
                downloadFile(reportContent, filename, mimeType);
                showCustomAlert(`Custom report generated successfully as ${filename}!`, 'Report Generated');
            } else {
                showCustomAlert('No accident incidents found matching your selected criteria for the report.', 'No Data');
            }

            document.getElementById('customReportModal').classList.add('hidden'); // Close the modal
        }

        /**
         * Generates a text-based summary resembling a PDF report.
         * This includes key statistics and a list of filtered reports.
         * @param {Array<Object>} reports - The filtered accident reports.
         * @param {Object} filters - The filters applied to generate this report.
         * @returns {string} A formatted text summary.
         */
        function generatePdfSummary(reports, filters) {
            let summary = `Accident Report Management - Custom Report\n`;
            summary += `Generated On: ${new Date().toLocaleString()}\n\n`;

            summary += `--- Report Parameters ---\n`;
            summary += `Date Range: ${filters.startDate || 'All Time'} to ${filters.endDate || 'All Time'}\n`;
            summary += `Severity: ${filters.severityFilter}\n`;
            summary += `Location: ${filters.locationFilter}\n`;
            summary += `Property Type: ${filters.propertyTypeFilter}\n\n`;

            summary += `--- Summary Statistics ---\n`;
            summary += `Total Reports: ${reports.length}\n`;
            summary += `Total Fatalities: ${reports.reduce((sum, r) => sum + (r.fatalities || 0), 0)}\n`;
            summary += `Total Injuries: ${reports.reduce((sum, r) => sum + (r.injuries || 0), 0)}\n`;
            summary += `Estimated Total Damage: $${reports.reduce((sum, r) => sum + (r.damageEstimate || 0), 0).toLocaleString()}\n`;

            const uniqueCauses = [...new Set(reports.map(r => r.cause))];
            summary += `Unique Causes: ${uniqueCauses.join(', ') || 'N/A'}\n`;

            const avgResponseTime = reports.length > 0 ? (reports.reduce((sum, r) => sum + (r.responseTime || 0), 0) / reports.length).toFixed(1) : '0';
            summary += `Average Response Time: ${avgResponseTime} minutes\n\n`;

            summary += `--- Report Details (First 10, if available) ---\n`;
            if (reports.length === 0) {
                summary += "No reports to display.\n";
            } else {
                reports.slice(0, 10).forEach((report, index) => {
                    summary += `\nReport #${index + 1}\n`;
                    summary += `  ID: ${report.id}\n`;
                    summary += `  Location: ${report.location}\n`;
                    summary += `  Date/Time: ${new Date(report.dateTime).toLocaleString()}\n`;
                    summary += `  Cause: ${report.cause}\n`;
                    summary += `  Severity: ${report.severity}\n`;
                    summary += `  Status: ${report.status}\n`;
                    summary += `  Fatalities: ${report.fatalities}\n`;
                    summary += `  Injuries: ${report.injuries}\n`;
                    summary += `  Damage Estimate: $${(report.damageEstimate || 0).toLocaleString()}\n`;
                });
                if (reports.length > 10) {
                    summary += `\n... and ${reports.length - 10} more reports.\n`;
                }
            }

            summary += `\n--- End of Report ---\n`;
            return summary;
        }

        /**
         * Opens the "All Incidents" modal and populates its filters and table.
         */
        function openAllIncidentsModal() {
            document.getElementById('allIncidentsModal').classList.remove('hidden');
            populateAllIncidentsFilters(); // Populate dropdowns in this modal
            filterAllIncidents(); // Apply initial filters and render table
            
            // Close other modals if open
            document.getElementById('reportDetailsModal').classList.add('hidden');
            document.getElementById('addEditReportModal').classList.add('hidden');
            document.getElementById('customReportModal').classList.add('hidden');

            isModalOpening = true; // Set flag when opening
            setTimeout(() => {
                isModalOpening = false; // Reset flag after a short delay
            }, 100);
        }

        /**
         * Populates the filter dropdowns within the "All Incidents" modal
         * with unique values from the entire `accidentReports` dataset.
         */
        function populateAllIncidentsFilters() {
            const causeFilter = document.getElementById('allIncidentsCauseFilter');
            const locationFilter = document.getElementById('allIncidentsLocationFilter');
            const propertyTypeFilter = document.getElementById('allIncidentsPropertyTypeFilter');

            // Store original "All" options
            const originalCauseOption = causeFilter.querySelector('option[value="All"]').outerHTML;
            const originalLocationOption = locationFilter.querySelector('option[value="All"]').outerHTML;
            const originalPropertyTypeOption = propertyTypeFilter.querySelector('option[value="All"]').outerHTML;

            // Clear existing options, then re-add "All"
            causeFilter.innerHTML = originalCauseOption;
            locationFilter.innerHTML = originalLocationOption;
            propertyTypeFilter.innerHTML = originalPropertyTypeOption;

            const uniqueCauses = new Set();
            const uniqueLocations = new Set();
            const uniquePropertyTypes = new Set();

            accidentReports.forEach(report => {
                uniqueCauses.add(report.cause);
                uniqueLocations.add(report.location);
                if (report.propertyType) {
                    uniquePropertyTypes.add(report.propertyType);
                }
            });

            Array.from(uniqueCauses).sort().forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                causeFilter.appendChild(option);
            });
            Array.from(uniqueLocations).sort().forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                locationFilter.appendChild(option);
            });
            Array.from(uniquePropertyTypes).sort().forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                propertyTypeFilter.appendChild(option);
            });
        }

        /**
         * Applies filters to the full list of incidents and renders the table in the "All Incidents" modal.
         */
        function filterAllIncidents() {
            const searchTerm = document.getElementById('allIncidentsSearch').value.toLowerCase();
            const selectedSeverity = document.getElementById('allIncidentsSeverityFilter').value;
            const selectedStatus = document.getElementById('allIncidentsStatusFilter').value;
            const selectedCause = document.getElementById('allIncidentsCauseFilter').value;
            const selectedLocation = document.getElementById('allIncidentsLocationFilter').value;
            const selectedPropertyType = document.getElementById('allIncidentsPropertyTypeFilter').value;
            const startDate = document.getElementById('allIncidentsStartDate').value;
            const endDate = document.getElementById('allIncidentsEndDate').value;

            const filteredReports = accidentReports.filter(report => {
                const reportDate = new Date(report.dateTime);
                const startDateTime = startDate ? new Date(startDate) : null;
                const endDateTime = endDate ? new Date(endDate) : null;

                const matchesSearch = report.id.toLowerCase().includes(searchTerm) ||
                                      report.location.toLowerCase().includes(searchTerm) ||
                                      report.cause.toLowerCase().includes(searchTerm) ||
                                      report.description.toLowerCase().includes(searchTerm);
                const matchesSeverity = selectedSeverity === 'All' || report.severity === selectedSeverity;
                const matchesStatus = selectedStatus === 'All' || report.status === selectedStatus;
                const matchesCause = selectedCause === 'All' || report.cause === selectedCause;
                const matchesLocation = selectedLocation === 'All' || report.location === selectedLocation;
                const matchesPropertyType = selectedPropertyType === 'All' || report.propertyType === selectedPropertyType;
                const matchesDate = (!startDateTime || reportDate >= startDateTime) &&
                                    (!endDateTime || reportDate <= endDateTime);

                return matchesSearch && matchesSeverity && matchesStatus && matchesCause && matchesLocation && matchesPropertyType && matchesDate;
            });
            renderAllIncidentsTable(filteredReports);
        }

        /**
         * Renders the table inside the "All Incidents" modal.
         * @param {Array<Object>} reportsToDisplay - The filtered reports to display.
         */
        function renderAllIncidentsTable(reportsToDisplay) {
            const tableBody = document.getElementById('allIncidentsTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            if (reportsToDisplay.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="px-4 py-4 text-center text-blue-200">No incidents found matching your criteria.</td></tr>`;
                return;
            }

            reportsToDisplay.forEach(report => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-900 transition duration-150 ease-in-out';
                const severityClass = `severity-${report.severity.toLowerCase()}`;
                const statusClass = `status-${report.status.toLowerCase()}`;

                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-white">${report.id}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-100">${report.location}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-100">${new Date(report.dateTime).toLocaleString()}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-100">${report.cause}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${severityClass} text-white">
                            ${report.severity}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass} text-white">
                            ${report.status}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-blue-100">${report.propertyType || 'N/A'}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm">
                        <button class="text-blue-400 hover:text-blue-500 mr-2 view-details-btn-all" data-report-id="${report.id}">Details</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Attach event listeners for "Details" buttons in this modal
            document.querySelectorAll('#allIncidentsTableBody .view-details-btn-all').forEach(button => {
                button.addEventListener('click', (event) => {
                    const reportId = event.target.dataset.reportId;
                    console.log(`Details button clicked in All Incidents for Report ID: ${reportId}`); // Debugging log
                    const report = accidentReports.find(r => r.id === reportId);
                    if (report) {
                        populateReportDetailsModal(report);
                        document.getElementById('allIncidentsModal').classList.add('hidden'); // Close this modal
                    } else {
                        console.error(`Report with ID ${reportId} not found in All Incidents for details.`);
                    }
                });
            });
        }


        // --- JavaScript for main functionality ---
        document.addEventListener('DOMContentLoaded', () => {
            // Get references to all necessary DOM elements
            const reportDetailsModal = document.getElementById('reportDetailsModal');
            const addNewReportButton = document.getElementById('addNewReportButton');
            const addEditReportModal = document.getElementById('addEditReportModal');
            const accidentReportForm = document.getElementById('accidentReportForm');
            const reportIdInput = document.getElementById('reportIdInput');
            const locationInput = document.getElementById('locationInput');
            const dateTimeInput = document.getElementById('dateTimeInput');
            const causeInput = document.getElementById('causeInput');
            const severityInput = document.getElementById('severityInput');
            const statusInput = document.getElementById('statusInput');
            const damageEstimateInput = document.getElementById('damageEstimateInput');
            const fatalitiesInput = document.getElementById('fatalitiesInput');
            const injuriesInput = document.getElementById('injuriesInput');
            const responseTimeInput = document.getElementById('responseTimeInput');
            const propertyTypeInput = document.getElementById('propertyTypeInput');
            const mediaUploadInput = document.getElementById('mediaUpload');
            const mediaPreviewContainer = document.getElementById('mediaPreview');

            // Elements for the EDITABLE Report Details Modal
            const editReportForm = document.getElementById('editReportForm');
            const editReportId = document.getElementById('editReportId');
            const modalReportIdDisplay = document.getElementById('modalReportIdDisplay');
            const editLocation = document.getElementById('editLocation');
            const editDateTime = document.getElementById('editDateTime');
            const editCause = document.getElementById('editCause');
            const editSeverity = document.getElementById('editSeverity');
            const editStatus = document.getElementById('editStatus');
            const editDamageEstimate = document.getElementById('editDamageEstimate');
            const editFatalities = document.getElementById('editFatalities');
            const editInjuries = document.getElementById('editInjuries');
            const editResponseTime = document.getElementById('editResponseTime');
            const editPropertyType = document.getElementById('editPropertyType');
            const editDescription = document.getElementById('editDescription');
            const editChatbotLog = document.getElementById('editChatbotLog');
            const editAdminLog = document.getElementById('editAdminLog');
            const editInternalNotes = document.getElementById('editInternalNotes');
            const flagAsDuplicateBtn = document.getElementById('flagAsDuplicateBtn');

            // Elements for filtering Recent Reports table
            const recentReportsSearchInput = document.getElementById('recentReportsSearchInput');
            const recentSeverityFilter = document.getElementById('recentSeverityFilter');
            const recentStatusFilter = document.getElementById('recentStatusFilter');

            // Custom Report button (assuming there's a button for this, though not explicitly in the provided HTML)
            const generateCustomReportBtn = document.getElementById('generateCustomReportBtn'); // This might be null if not in HTML
            if (generateCustomReportBtn) { // Only add listener if button exists
                generateCustomReportBtn.addEventListener('click', openCustomReportModal);
            }
            document.getElementById('reportGenerationForm').addEventListener('submit', processReportGeneration);


            // All Incidents Modal elements
            const viewAllIncidentsBtn = document.getElementById('viewAllIncidentsBtn');
            const allIncidentsModal = document.getElementById('allIncidentsModal');
            const allIncidentsSearch = document.getElementById('allIncidentsSearch');
            const allIncidentsSeverityFilter = document.getElementById('allIncidentsSeverityFilter');
            const allIncidentsStatusFilter = document.getElementById('allIncidentsStatusFilter');
            const allIncidentsCauseFilter = document.getElementById('allIncidentsCauseFilter');
            const allIncidentsLocationFilter = document.getElementById('allIncidentsLocationFilter');
            const allIncidentsPropertyTypeFilter = document.getElementById('allIncidentsPropertyTypeFilter');
            const allIncidentsStartDate = document.getElementById('allIncidentsStartDate');
            const allIncidentsEndDate = document.getElementById('allIncidentsEndDate');


            let selectedMediaFiles = []; // To store base64 representations of uploaded images

            // --- Close modals if clicked outside (simplified for robustness) ---
            document.addEventListener('click', (event) => {
                // If a modal is in the process of opening, ignore this click to prevent immediate closing
                if (isModalOpening) {
                    return;
                }

                // Check if the click was inside any modal content area (for *currently visible* modals)
                // This handles clicks inside the modal to prevent closing it
                const isClickInsideAnyModalContent = Array.from(document.querySelectorAll('.modal:not(.hidden) .modal-content'))
                                                        .some(content => content.contains(event.target));

                // Check if the click originated from a button that *opens* a modal
                // This prevents closing when a modal is intentionally opened
                const isClickOnModalToggleButton = event.target.closest('#addNewReportButton') ||
                                                   event.target.closest('#viewAllIncidentsBtn') ||
                                                   event.target.closest('.view-details-btn'); // Crucial addition

                // If the click was NOT inside any open modal content AND NOT on a button that opens a modal, then close all modals.
                if (!isClickInsideAnyModalContent && !isClickOnModalToggleButton) {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.classList.add('hidden');
                    });
                }
            });

            // --- Media Upload Logic for Add New Report Modal ---
            mediaUploadInput.addEventListener('change', (event) => {
                mediaPreviewContainer.innerHTML = ''; // Clear previous previews
                selectedMediaFiles = []; // Reset array
                const files = event.target.files;

                if (files.length > 0) {
                    Array.from(files).forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = document.createElement('img');
                                img.src = e.target.result;
                                img.alt = file.name; // Add alt text for accessibility
                                img.className = 'w-full h-24 object-cover rounded-md'; // Consistent size for preview
                                mediaPreviewContainer.appendChild(img);
                                selectedMediaFiles.push(e.target.result); // Store base64 string
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            });

            // --- Add New Accident Report Logic ---
            addNewReportButton.addEventListener('click', () => {
                document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden')); // Close others
                addEditReportModal.classList.remove('hidden');
                isModalOpening = true; // Set flag when opening
                setTimeout(() => { isModalOpening = false; }, 100); // Reset after a short delay
                accidentReportForm.reset(); // Clear form for new entry
                mediaPreviewContainer.innerHTML = ''; // Clear media previews
                selectedMediaFiles = []; // Clear selected media files
                // Generate a simple dummy report ID (In Django, this would typically be handled by the database's auto-incrementing primary key)
                const nextIdNum = accidentReports.length > 0 ? Math.max(...accidentReports.map(r => parseInt(r.id.replace('AR-', '')))) + 1 : 1;
                reportIdInput.value = 'AR-' + nextIdNum.toString().padStart(3, '0');
                // Pre-fill current date/time (Django forms can also pre-fill this)
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                dateTimeInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            });

            accidentReportForm.addEventListener('submit', (event) => {
                event.preventDefault(); // Prevent default form submission

                // Construct data object from form inputs.
                const newReport = {
                    id: reportIdInput.value, // This ID would likely be ignored or validated by Django
                    location: locationInput.value,
                    dateTime: dateTimeInput.value,
                    cause: causeInput.value,
                    severity: severityInput.value,
                    status: statusInput.value,
                    damageEstimate: parseFloat(damageEstimateInput.value) || 0,
                    fatalities: parseInt(fatalitiesInput.value) || 0,
                    injuries: parseInt(injuriesInput.value) || 0,
                    responseTime: parseInt(responseTimeInput.value) || 0,
                    propertyType: propertyTypeInput.value,
                    media: [...selectedMediaFiles], // For Django, these would be sent as file uploads or base64 strings
                    description: 'No description provided yet.',
                    chatbotLog: 'No chatbot log for this report yet.',
                    adminLog: `Admin User: Report Added (${new Date().toLocaleString()})`,
                    internalNotes: ''
                };

                accidentReports.push(newReport);
                // Sort reports by date to ensure "Recent Reports" always shows latest
                accidentReports.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));

                // Re-render table and charts to reflect new data
                applyRecentReportsFilters(); // Re-render recent reports table
                initializeAllCharts();
                updateSummaryStatistics();

                // Show confirmation message (using custom alert)
                showCustomAlert('The new accident report has been successfully added.', 'Report Saved!');

                addEditReportModal.classList.add('hidden');
                accidentReportForm.reset(); // Clear the form
                mediaPreviewContainer.innerHTML = ''; // Clear media previews after saving
                selectedMediaFiles = []; // Reset selected media files after saving
            });

            // --- Save Changes in Report Details Modal ---
            editReportForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const reportIdToUpdate = editReportId.value;
                const reportIndex = accidentReports.findIndex(r => r.id === reportIdToUpdate);

                if (reportIndex !== -1) {
                    const updatedReport = {
                        ...accidentReports[reportIndex], // Keep existing properties
                        location: editLocation.value,
                        dateTime: editDateTime.value,
                        cause: editCause.value,
                        severity: editSeverity.value,
                        status: editStatus.value,
                        damageEstimate: parseFloat(editDamageEstimate.value) || 0,
                        fatalities: parseInt(editFatalities.value) || 0,
                        injuries: parseInt(editInjuries.value) || 0,
                        responseTime: parseInt(editResponseTime.value) || 0,
                        propertyType: editPropertyType.value,
                        description: editDescription.value,
                        internalNotes: editInternalNotes.value,
                        adminLog: accidentReports[reportIndex].adminLog + `\nAdmin User: Details Updated (${new Date().toLocaleString()})`
                    };
                    accidentReports[reportIndex] = updatedReport;
                    console.log('Report updated:', updatedReport);

                    // Re-render table and charts
                    applyRecentReportsFilters(); // Re-render recent reports table
                    initializeAllCharts();
                    updateSummaryStatistics();

                    // Show confirmation message
                    showCustomAlert('Accident report details have been successfully updated.', 'Changes Saved!');

                    reportDetailsModal.classList.add('hidden');
                } else {
                    console.error('Report not found for update:', reportIdToUpdate);
                }
            });

            // --- Flag as Duplicate Button Logic ---
            flagAsDuplicateBtn.addEventListener('click', () => {
                const reportIdToFlag = editReportId.value;
                const reportIndex = accidentReports.findIndex(r => r.id === reportIdToFlag);

                if (reportIndex !== -1) {
                    // Update status to 'Investigating' or a specific 'Duplicate' status
                    accidentReports[reportIndex].status = 'Investigating'; // Or 'Duplicate' if you add that option
                    accidentReports[reportIndex].adminLog += `\nAdmin User: Flagged as Duplicate (${new Date().toLocaleString()})`;
                    
                    // Show confirmation message
                    showCustomAlert(`Report ${reportIdToFlag} has been flagged as a potential duplicate and its status set to 'Investigating'.`, 'Report Flagged!');

                    applyRecentReportsFilters(); // Update table to show new status
                    reportDetailsModal.classList.add('hidden');
                    updateSummaryStatistics();
                }
            });

            // --- Filtering Logic for Recent Reports Table ---
            function applyRecentReportsFilters() {
                const searchTerm = recentReportsSearchInput.value.toLowerCase();
                const selectedSeverity = recentSeverityFilter.value;
                const selectedStatus = recentStatusFilter.value;

                const filteredReports = accidentReports.filter(report => {
                    const matchesSearch = report.id.toLowerCase().includes(searchTerm) ||
                                          report.location.toLowerCase().includes(searchTerm) ||
                                          report.cause.toLowerCase().includes(searchTerm) ||
                                          report.description.toLowerCase().includes(searchTerm);
                    const matchesSeverity = selectedSeverity === 'All' || report.severity === selectedSeverity;
                    const matchesStatus = selectedStatus === 'All' || report.status === selectedStatus;
                    return matchesSearch && matchesSeverity && matchesStatus;
                }).slice(0, 10); // Only show the most recent 10 filtered reports
                renderReportsTable(filteredReports);
            }

            // Event listeners for recent reports filters
            recentReportsSearchInput.addEventListener('input', applyRecentReportsFilters);
            recentSeverityFilter.addEventListener('change', applyRecentReportsFilters);
            recentStatusFilter.addEventListener('change', applyRecentReportsFilters);

            // --- Custom Report Generation Button Listener ---
            const generateCustomReportBtnElement = document.getElementById('generateCustomReportBtn');
            if (generateCustomReportBtnElement) {
                generateCustomReportBtnElement.addEventListener('click', openCustomReportModal);
            }
            document.getElementById('reportGenerationForm').addEventListener('submit', processReportGeneration);


            // --- All Incidents Modal Event Listeners ---
            viewAllIncidentsBtn.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent global click from immediately closing
                openAllIncidentsModal(); // This function already handles showing the modal
            });

            allIncidentsSearch.addEventListener('input', filterAllIncidents);
            allIncidentsSeverityFilter.addEventListener('change', filterAllIncidents);
            allIncidentsStatusFilter.addEventListener('change', filterAllIncidents);
            allIncidentsCauseFilter.addEventListener('change', filterAllIncidents);
            allIncidentsLocationFilter.addEventListener('change', filterAllIncidents);
            allIncidentsPropertyTypeFilter.addEventListener('change', filterAllIncidents);
            allIncidentsStartDate.addEventListener('change', filterAllIncidents);
            allIncidentsEndDate.addEventListener('change', filterAllIncidents);


            // Initial rendering on page load
            applyRecentReportsFilters(); // Render recent reports table initially
            initializeAllCharts();
            updateSummaryStatistics();

            // Re-render charts on window resize to maintain sharpness
            window.addEventListener('resize', () => {
                initializeAllCharts();
            });
        });
    </script>
</body>
</html>
